import{r as C,X as q,w as J,f as g,e as r,o as _,b as a,d as n,a3 as h,c as U,t as v,v as u,F as j,i as ro,m as lo,Z as so,x as no,au as io}from"./index-BeJKwT3L.js";import{_ as co}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as uo}from"./VDialog-B8fNwsjc.js";import{V as F,b as po,c as mo}from"./VCard-CGdkx-aT.js";import{V as _o}from"./VCardText-DwCeoSnf.js";import{V as k,a as i}from"./VRow-D5xgHycP.js";import{V}from"./VTextField-Jwusj3K2.js";import{V as vo}from"./VDataTable-B7G1_Tc3.js";import{V as R}from"./VDivider-BwTOxVso.js";import{V as fo}from"./VChip-Dk9LcUUU.js";import{V as go}from"./VCheckbox-C41lrorx.js";import{V as Vo}from"./VAlert-BAeOn0Ot.js";import{V as bo}from"./VSpacer-DUGk-Oji.js";import"./VOverlay-Dw8rT7j1.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-_UBNvAVp.js";import"./VAvatar-CfPmM5Ot.js";import"./VImg-DEZOfq6Q.js";/* empty css              */import"./VInput-CRx9gst-.js";import"./VSelect-CP_h5oZu.js";import"./VList-CestEiTa.js";import"./VMenu-BknqRJcB.js";import"./VCheckboxBtn-Dc5VQrYU.js";import"./VSelectionControl-C9MxSs2p.js";import"./filter-DhrMZfUc.js";const yo={key:0},xo={class:"text-subtitle-1 mb-3"},Co={class:"text-subtitle-2"},ho={class:"text-caption text-grey"},Po={class:"text-subtitle-2"},$o={class:"text-subtitle-2"},ko={class:"text-subtitle-2"},wo={class:"text-subtitle-2 text-success"},So={class:"text-subtitle-2"},Uo={class:"text-subtitle-2"},Fo={class:"text-subtitle-2 text-success"},Io={class:"text-h6 text-primary"},Ao={__name:"ModalProductos",props:{mostrar:{type:Boolean,default:!1}},emits:["update:mostrar","agregar-productos"],setup(X,{emit:Z}){const G=X,I=Z,f=C(!1),P=C([]),p=C([]),b=C(""),w=C(!1),H=[{title:"Código",key:"codigo_proveedor",sortable:!0},{title:"Nombre",key:"nombre",sortable:!0},{title:"Color",key:"color",sortable:!0},{title:"Proveedor",key:"proveedor",sortable:!0},{title:"Precio",key:"precio",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,align:"center"}],K=q(()=>{if(!Array.isArray(P.value))return[];const t=[];if(P.value.forEach(o=>{const l=(o.listaPrecios||o.lista_precios||[]).filter(d=>Number(d.activo)===1||d.activo===!0||d.activo==="1");l.length===0?t.push({...o,_productoOriginal:o,_listaPrecio:null,color:"-",proveedor:"-",precio:"-"}):l.forEach(d=>{var x,m;const c=d.productoColorProveedor||d.producto_color_proveedor;t.push({...o,_productoOriginal:o,_listaPrecio:d,id:`${o.id}_${d.id}`,color:((x=c==null?void 0:c.color)==null?void 0:x.nombre)||"-",proveedor:((m=c==null?void 0:c.proveedor)==null?void 0:m.nombre)||"-",precio:`$${Number(d.precio_venta||0).toLocaleString("es-CL")}`})})}),!b.value)return t;const e=b.value.toLowerCase();return t.filter(o=>{var s,l,d,c;return((s=o.nombre)==null?void 0:s.toLowerCase().includes(e))||((l=o.codigo)==null?void 0:l.toLowerCase().includes(e))||((d=o.color)==null?void 0:d.toLowerCase().includes(e))||((c=o.proveedor)==null?void 0:c.toLowerCase().includes(e))})}),Q=q(()=>p.value.reduce((t,e)=>{const o=e.esVidrio?e.precio_venta_total||0:e.precio_venta||0;return t+o},0));J(()=>G.mostrar,t=>{f.value=t,t&&W()}),J(f,t=>{I("update:mostrar",t),t||to()});const W=async()=>{w.value=!0;try{let e=(await io.get("/api/productos")).data;if(typeof e=="string")try{e=JSON.parse(e)}catch(o){console.error("Error al parsear JSON:",o),e=[]}P.value=Array.isArray(e)?e:[]}catch(t){console.error("Error al cargar productos:",t),P.value=[]}finally{w.value=!1}},Y=t=>{var M,N,B,E,D,T,z;const e=t._productoOriginal,o=t._listaPrecio;if(p.value.find(O=>O.producto_lista_id===e.id&&O.lista_precio_id===(o==null?void 0:o.id))){alert("Esta variante del producto ya fue seleccionada");return}if(!o){alert("Este producto no tiene precio configurado");return}const l=o.productoColorProveedor||o.producto_color_proveedor,d=parseFloat(o.precio_costo)||0,c=parseFloat(o.margen)||30,x=c>=100?0:d/(1-c/100),m=e.tipo_producto_id===1||e.tipo_producto_id===2;p.value.push({producto:{...e},producto_lista_id:e.id,lista_precio_id:o.id,cantidad:1,precio_costo:d,margen:c,precio_venta:x,precio_venta_total:x,descripcion:`${e.nombre} - ${((M=l==null?void 0:l.color)==null?void 0:M.nombre)||"Sin color"} (${((N=l==null?void 0:l.proveedor)==null?void 0:N.nombre)||"Sin proveedor"})`,codigo:e.codigo,nombre:e.nombre,color:((B=l==null?void 0:l.color)==null?void 0:B.nombre)||"-",proveedor:((E=l==null?void 0:l.proveedor)==null?void 0:E.nombre)||"-",tipo:((D=e.tipo_producto)==null?void 0:D.nombre)||"",unidad:((T=e.unidad)==null?void 0:T.nombre)||((z=e.unidad)==null?void 0:z.simbolo)||"",esVidrio:m,ancho_mm:m?null:void 0,alto_mm:m?null:void 0,m2:m?0:void 0,pulido:m?!1:void 0,precio_costo_calculado:m?d:void 0})},oo=t=>{p.value.splice(t,1)},eo=t=>{const e=parseFloat(t.precio_costo)||0,o=parseFloat(t.cantidad)||1,s=parseFloat(t.margen)||0;if(s>=100){t.precio_venta=0;return}const l=e/(1-s/100);t.precio_venta=l*o},S=t=>{if(!t.esVidrio||!t.ancho_mm||!t.alto_mm)return 0;const e=t.ancho_mm*t.alto_mm/1e6;return t.m2=e,e},A=t=>{const e=S(t);return e>0?e.toFixed(4):"0.0000"},$=t=>{if(!t.esVidrio)return;const e=S(t);if(e<=0){t.precio_venta_total=0,t.precio_costo_calculado=t.precio_costo;return}let o=t.precio_costo;t.pulido&&(o=t.precio_costo*1.2),t.precio_costo_calculado=o;const s=parseFloat(t.margen)||0;if(s>=100){t.precio_venta_total=0,t.precio_venta=0;return}const d=o*e/(1-s/100),c=parseFloat(t.cantidad)||1;t.precio_venta_total=d*c,t.precio_venta=t.precio_venta_total},y=t=>new Intl.NumberFormat("es-CL").format(t||0),to=()=>{p.value=[],b.value=""},L=()=>{f.value=!1},ao=()=>{if(p.value.filter(o=>o.esVidrio&&(!o.ancho_mm||!o.alto_mm||o.ancho_mm<=0||o.alto_mm<=0)).length>0){alert("Por favor, ingresa las dimensiones (ancho y alto) para todos los productos de vidrio");return}const e=p.value.map(o=>{if(o.esVidrio){const s=o.pulido?" [PULIDO]":"";return{...o,descripcion:`${o.nombre} - ${o.ancho_mm}mm x ${o.alto_mm}mm (${A(o)} m²)${s} - ${o.color} (${o.proveedor})`,precio_venta:o.precio_venta_total,m2:S(o)}}return o});I("agregar-productos",e),f.value=!1};return(t,e)=>(_(),g(uo,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value=o),"max-width":"1000px",persistent:""},{default:r(()=>[a(F,null,{default:r(()=>[a(po,{class:"text-h6 d-flex justify-space-between align-center"},{default:r(()=>[e[2]||(e[2]=n("span",null,"Agregar Productos",-1)),a(h,{icon:"mdi-close",variant:"text",onClick:L})]),_:1}),a(_o,null,{default:r(()=>[a(k,{dense:""},{default:r(()=>[a(i,{cols:"12"},{default:r(()=>[a(V,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=o=>b.value=o),label:"Buscar producto por nombre o código","prepend-inner-icon":"mdi-magnify",clearable:"",outlined:"",dense:"","hide-details":"auto"},null,8,["modelValue"])]),_:1})]),_:1}),a(vo,{headers:H,items:K.value,loading:w.value,"item-value":"id",class:"elevation-1 mt-4",density:"compact","items-per-page":10,"items-per-page-options":[5,10,25,50]},{"item.tipo_producto":r(({item:o})=>{var s;return[v(u(((s=o.tipoProducto)==null?void 0:s.nombre)||"-"),1)]}),"item.unidad":r(({item:o})=>{var s;return[v(u(((s=o.unidad)==null?void 0:s.abreviacion)||"-"),1)]}),"item.acciones":r(({item:o})=>[a(h,{icon:"mdi-plus",size:"small",color:"success",variant:"tonal",onClick:s=>Y(o)},null,8,["onClick"])]),_:1},8,["items","loading"]),a(R,{class:"my-4"}),p.value.length>0?(_(),U("div",yo,[n("h3",xo,"Productos seleccionados ("+u(p.value.length)+")",1),(_(!0),U(j,null,ro(p.value,(o,s)=>(_(),g(F,{key:s,class:"mb-3 pa-3",outlined:""},{default:r(()=>[a(k,{dense:"",align:"center"},{default:r(()=>[a(i,{cols:"12",md:"3"},{default:r(()=>[n("div",Co,u(o.nombre),1),n("div",ho,u(o.codigo),1),o.esVidrio?(_(),g(fo,{key:0,size:"x-small",color:"info",class:"mt-1"},{default:r(()=>e[3]||(e[3]=[v(" Venta por m² ")])),_:1})):lo("",!0)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[4]||(e[4]=n("div",{class:"text-caption text-grey"},"Color",-1)),n("div",Po,u(o.color||"-"),1)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[5]||(e[5]=n("div",{class:"text-caption text-grey"},"Proveedor",-1)),n("div",$o,u(o.proveedor||"-"),1)]),_:2},1024),o.esVidrio?(_(),g(i,{key:0,cols:"12",md:"12"},{default:r(()=>[a(R,{class:"my-2"}),a(k,{dense:""},{default:r(()=>[a(i,{cols:"6",md:"2"},{default:r(()=>[a(V,{modelValue:o.ancho_mm,"onUpdate:modelValue":l=>o.ancho_mm=l,modelModifiers:{number:!0},label:"Ancho (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(V,{modelValue:o.alto_mm,"onUpdate:modelValue":l=>o.alto_mm=l,modelModifiers:{number:!0},label:"Alto (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[(_(),g(V,{key:`m2-${o.ancho_mm}-${o.alto_mm}`,"model-value":A(o),label:"m²",readonly:"",variant:"outlined",density:"compact","hide-details":"",class:"text-primary font-weight-bold"},{"append-inner":r(()=>[a(so,{size:"small",color:"info"},{default:r(()=>e[6]||(e[6]=[v("mdi-texture-box")])),_:1})]),_:2},1032,["model-value"]))]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[a(V,{modelValue:o.cantidad,"onUpdate:modelValue":l=>o.cantidad=l,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(go,{modelValue:o.pulido,"onUpdate:modelValue":l=>o.pulido=l,label:"Pulido (+20%)",color:"primary","hide-details":"",onChange:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[7]||(e[7]=n("div",{class:"text-caption text-grey"},"P. Costo/m²",-1)),n("div",ko,"$"+u(y(o.precio_costo_calculado||o.precio_costo)),1)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[8]||(e[8]=n("div",{class:"text-caption text-grey"},"P. Venta Total",-1)),n("div",wo,"$"+u(y(o.precio_venta_total)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)):(_(),U(j,{key:1},[a(i,{cols:"6",md:"1"},{default:r(()=>[a(V,{modelValue:o.cantidad,"onUpdate:modelValue":l=>o.cantidad=l,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:l=>eo(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[9]||(e[9]=n("div",{class:"text-caption text-grey"},"P. Costo",-1)),n("div",So,"$"+u(y(o.precio_costo)),1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[10]||(e[10]=n("div",{class:"text-caption text-grey"},"Margen",-1)),n("div",Uo,u(o.margen)+"%",1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[11]||(e[11]=n("div",{class:"text-caption text-grey"},"P. Venta",-1)),n("div",Fo,"$"+u(y(o.precio_venta)),1)]),_:2},1024)],64)),a(i,{cols:o.esVidrio?12:4,md:o.esVidrio?12:1,class:no(o.esVidrio?"":"text-right")},{default:r(()=>[a(h,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:l=>oo(s)},null,8,["onClick"])]),_:2},1032,["cols","md","class"])]),_:2},1024)]),_:2},1024))),128)),a(F,{class:"pa-3 bg-primary-lighten-5",outlined:""},{default:r(()=>[a(k,null,{default:r(()=>[a(i,{cols:"12",class:"text-right"},{default:r(()=>[e[12]||(e[12]=n("div",{class:"text-subtitle-2 text-grey"},"Total productos seleccionados:",-1)),n("div",Io,"$"+u(y(Q.value)),1)]),_:1})]),_:1})]),_:1})])):(_(),g(Vo,{key:1,type:"info",variant:"tonal",class:"mt-4"},{default:r(()=>e[13]||(e[13]=[v(" Busca y selecciona productos de la tabla para agregarlos a la cotización ")])),_:1}))]),_:1}),a(mo,null,{default:r(()=>[a(bo),a(h,{color:"grey",variant:"text",onClick:L},{default:r(()=>e[14]||(e[14]=[v(" Cancelar ")])),_:1}),a(h,{color:"primary",variant:"elevated",disabled:p.value.length===0,onClick:ao},{default:r(()=>[v(" Agregar "+u(p.value.length)+" producto(s) ",1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},le=co(Ao,[["__scopeId","data-v-791e84cc"]]);export{le as default};
