import{r as x,X as D,w as T,f as V,e as r,o as m,b as a,d,a3 as C,c as w,t as f,v as c,F as z,i as eo,m as to,Z as ao,x as ro,ar as lo}from"./index-zXGCFGIg.js";import{_ as so}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as no}from"./VDialog-DbzeL1Fr.js";import{V as U,b as io,c as co}from"./VCard-BivyUXWm.js";import{V as uo}from"./VCardText-C6b6sPjd.js";import{V as k,a as i}from"./VRow-C1LQQmap.js";import{V as g}from"./VTextField-B1sfjoWq.js";import{V as po}from"./VDataTable-CyyfS5q2.js";import{V as O}from"./VDivider-Dz9kH9oT.js";import{V as mo}from"./VChip-8OtzmJWd.js";import{V as _o}from"./VCheckbox-PBYDZt7s.js";import{V as fo}from"./VAlert-DnyJZ4VW.js";import{V as vo}from"./VSpacer-Cu14cexP.js";import"./VOverlay-C3-CcM7k.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-BvxzZJi3.js";import"./VAvatar-MgFTNfdu.js";import"./VImg-CHMTV0xF.js";/* empty css              */import"./VInput-pyJZwFq9.js";import"./VSelect-DPytfcsj.js";import"./VList-B-_lPbF_.js";import"./VMenu-5q30PoDq.js";import"./VCheckboxBtn-D0lPBrIw.js";import"./VSelectionControl-DgQkzTB8.js";import"./filter-C9QZNLH-.js";const Vo={key:0},go={class:"text-subtitle-1 mb-3"},bo={class:"text-subtitle-2"},yo={class:"text-caption text-grey"},xo={class:"text-subtitle-2"},Co={class:"text-subtitle-2"},ho={class:"text-subtitle-2 text-success"},Po={class:"text-subtitle-2"},$o={class:"text-subtitle-2"},ko={class:"text-subtitle-2 text-success"},Ao={class:"text-h6 text-primary"},Io={__name:"ModalProductos",props:{mostrar:{type:Boolean,default:!1}},emits:["update:mostrar","agregar-productos"],setup(R,{emit:q}){const J=R,F=q,v=x(!1),h=x([]),u=x([]),b=x(""),A=x(!1),j=[{title:"Código",key:"codigo_proveedor",sortable:!0},{title:"Nombre",key:"nombre",sortable:!0},{title:"Color",key:"color",sortable:!0},{title:"Precio",key:"precio",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,align:"center"}],H=D(()=>{if(!Array.isArray(h.value))return[];const t=[];if(h.value.forEach(o=>{const s=(o.listaPrecios||o.lista_precios||[]).filter(n=>Number(n.activo)===1||n.activo===!0||n.activo==="1");s.length===0?t.push({...o,_productoOriginal:o,_listaPrecio:null,color:"-",precio:"-"}):s.forEach(n=>{var _;const p=n.color||((_=n.productoColorProveedor)==null?void 0:_.color);t.push({...o,_productoOriginal:o,_listaPrecio:n,id:`${o.id}_${n.id}`,color:(p==null?void 0:p.nombre)||"-",precio:`$${Number(n.precio_venta||0).toLocaleString("es-CL")}`})})}),!b.value)return t;const e=b.value.toLowerCase();return t.filter(o=>{var l,s,n;return((l=o.nombre)==null?void 0:l.toLowerCase().includes(e))||((s=o.codigo)==null?void 0:s.toLowerCase().includes(e))||((n=o.color)==null?void 0:n.toLowerCase().includes(e))})}),X=D(()=>u.value.reduce((t,e)=>{const o=e.esVidrio?e.precio_venta_total||0:e.precio_venta||0;return t+o},0));T(()=>J.mostrar,t=>{v.value=t,t&&Z()}),T(v,t=>{F("update:mostrar",t),t||Y()});const Z=async()=>{A.value=!0;try{let e=(await lo.get("/api/productos")).data;if(typeof e=="string")try{e=JSON.parse(e)}catch(o){console.error("Error al parsear JSON:",o),e=[]}h.value=Array.isArray(e)?e:[]}catch(t){console.error("Error al cargar productos:",t),h.value=[]}finally{A.value=!1}},G=t=>{var $,B,E;const e=t._productoOriginal,o=t._listaPrecio,l=e.tipo_producto_id===1||e.tipo_producto_id===2;if(!l&&u.value.find(L=>L.producto_lista_id===e.id&&L.lista_precio_id===(o==null?void 0:o.id))){alert("Esta variante del producto ya fue seleccionada");return}if(!o){alert("Este producto no tiene precio configurado");return}const s=o.productoColorProveedor||o.producto_color_proveedor,n=o.color||(s==null?void 0:s.color),p=parseFloat(o.precio_costo)||0,_=parseFloat(o.margen)||30,S=_>=100?0:p/(1-_/100);u.value.push({producto:{...e},producto_lista_id:e.id,lista_precio_id:o.id,cantidad:1,precio_costo:p,margen:_,precio_venta:S,precio_venta_total:S,descripcion:`${e.nombre} - ${(n==null?void 0:n.nombre)||"Sin color"}`,codigo:e.codigo,nombre:e.nombre,color:(n==null?void 0:n.nombre)||"-",proveedor:"-",tipo:(($=e.tipo_producto)==null?void 0:$.nombre)||"",unidad:((B=e.unidad)==null?void 0:B.nombre)||((E=e.unidad)==null?void 0:E.simbolo)||"",esVidrio:l,ancho_mm:l?null:void 0,alto_mm:l?null:void 0,m2:l?0:void 0,pulido:l?!1:void 0,precio_costo_calculado:l?p:void 0})},K=t=>{u.value.splice(t,1)},Q=t=>{const e=parseFloat(t.precio_costo)||0,o=parseFloat(t.cantidad)||1,l=parseFloat(t.margen)||0;if(l>=100){t.precio_venta=0;return}const s=e/(1-l/100);t.precio_venta=s*o},I=t=>{if(!t.esVidrio||!t.ancho_mm||!t.alto_mm)return 0;const e=t.ancho_mm*t.alto_mm/1e6;return t.m2=e,e},M=t=>{const e=I(t);return e>0?e.toFixed(4):"0.0000"},P=t=>{if(!t.esVidrio)return;const e=I(t);if(e<=0){t.precio_venta_total=0,t.precio_costo_calculado=t.precio_costo;return}let o=t.precio_costo;t.pulido&&(o=t.precio_costo*1.2),t.precio_costo_calculado=o;const l=parseFloat(t.margen)||0;if(l>=100){t.precio_venta_total=0,t.precio_venta=0;return}const n=o*e/(1-l/100),p=parseFloat(t.cantidad)||1,_=n*1.19,$=W(_)/1.19;t.precio_venta_total=$*p,t.precio_venta=t.precio_venta_total},W=t=>Math.ceil(t/500)*500,y=t=>new Intl.NumberFormat("es-CL").format(t||0),Y=()=>{u.value=[],b.value=""},N=()=>{v.value=!1},oo=()=>{if(u.value.filter(o=>o.esVidrio&&(!o.ancho_mm||!o.alto_mm||o.ancho_mm<=0||o.alto_mm<=0)).length>0){alert("Por favor, ingresa las dimensiones (ancho y alto) para todos los productos de vidrio");return}const e=u.value.map(o=>{if(o.esVidrio){const l=o.pulido?" [PULIDO]":"";return{...o,descripcion:`${o.nombre} - ${o.ancho_mm}mm x ${o.alto_mm}mm (${M(o)} m²)${l} - ${o.color}`,precio_venta:o.precio_venta_total,m2:I(o)}}return o});F("agregar-productos",e),v.value=!1};return(t,e)=>(m(),V(no,{modelValue:v.value,"onUpdate:modelValue":e[1]||(e[1]=o=>v.value=o),"max-width":"1000px",persistent:""},{default:r(()=>[a(U,null,{default:r(()=>[a(io,{class:"text-h6 d-flex justify-space-between align-center"},{default:r(()=>[e[2]||(e[2]=d("span",null,"Agregar Productos",-1)),a(C,{icon:"mdi-close",variant:"text",onClick:N})]),_:1}),a(uo,null,{default:r(()=>[a(k,{dense:""},{default:r(()=>[a(i,{cols:"12"},{default:r(()=>[a(g,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=o=>b.value=o),label:"Buscar producto por nombre o código","prepend-inner-icon":"mdi-magnify",clearable:"",outlined:"",dense:"","hide-details":"auto"},null,8,["modelValue"])]),_:1})]),_:1}),a(po,{headers:j,items:H.value,loading:A.value,"item-value":"id",class:"elevation-1 mt-4",density:"compact","items-per-page":10,"items-per-page-options":[5,10,25,50]},{"item.tipo_producto":r(({item:o})=>{var l;return[f(c(((l=o.tipoProducto)==null?void 0:l.nombre)||"-"),1)]}),"item.unidad":r(({item:o})=>{var l;return[f(c(((l=o.unidad)==null?void 0:l.abreviacion)||"-"),1)]}),"item.acciones":r(({item:o})=>[a(C,{icon:"mdi-plus",size:"small",color:"success",variant:"tonal",onClick:l=>G(o)},null,8,["onClick"])]),_:1},8,["items","loading"]),a(O,{class:"my-4"}),u.value.length>0?(m(),w("div",Vo,[d("h3",go,"Productos seleccionados ("+c(u.value.length)+")",1),(m(!0),w(z,null,eo(u.value,(o,l)=>(m(),V(U,{key:l,class:"mb-3 pa-3",outlined:""},{default:r(()=>[a(k,{dense:"",align:"center"},{default:r(()=>[a(i,{cols:"12",md:"3"},{default:r(()=>[d("div",bo,c(o.nombre),1),d("div",yo,c(o.codigo),1),o.esVidrio?(m(),V(mo,{key:0,size:"x-small",color:"info",class:"mt-1"},{default:r(()=>e[3]||(e[3]=[f(" Venta por m² ")])),_:1})):to("",!0)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[4]||(e[4]=d("div",{class:"text-caption text-grey"},"Color",-1)),d("div",xo,c(o.color||"-"),1)]),_:2},1024),o.esVidrio?(m(),V(i,{key:0,cols:"12",md:"12"},{default:r(()=>[a(O,{class:"my-2"}),a(k,{dense:""},{default:r(()=>[a(i,{cols:"6",md:"2"},{default:r(()=>[a(g,{modelValue:o.ancho_mm,"onUpdate:modelValue":s=>o.ancho_mm=s,modelModifiers:{number:!0},label:"Ancho (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:s=>P(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(g,{modelValue:o.alto_mm,"onUpdate:modelValue":s=>o.alto_mm=s,modelModifiers:{number:!0},label:"Alto (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:s=>P(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[(m(),V(g,{key:`m2-${o.ancho_mm}-${o.alto_mm}`,"model-value":M(o),label:"m²",readonly:"",variant:"outlined",density:"compact","hide-details":"",class:"text-primary font-weight-bold"},{"append-inner":r(()=>[a(ao,{size:"small",color:"info"},{default:r(()=>e[5]||(e[5]=[f("mdi-texture-box")])),_:1})]),_:2},1032,["model-value"]))]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[a(g,{modelValue:o.cantidad,"onUpdate:modelValue":s=>o.cantidad=s,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:s=>P(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(_o,{modelValue:o.pulido,"onUpdate:modelValue":s=>o.pulido=s,label:"Pulido (+20%)",color:"primary","hide-details":"",onChange:s=>P(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[6]||(e[6]=d("div",{class:"text-caption text-grey"},"P. Costo/m²",-1)),d("div",Co,"$"+c(y(o.precio_costo_calculado||o.precio_costo)),1)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[7]||(e[7]=d("div",{class:"text-caption text-grey"},"P. Venta Total",-1)),d("div",ho,"$"+c(y(o.precio_venta_total)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)):(m(),w(z,{key:1},[a(i,{cols:"6",md:"1"},{default:r(()=>[a(g,{modelValue:o.cantidad,"onUpdate:modelValue":s=>o.cantidad=s,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:s=>Q(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[8]||(e[8]=d("div",{class:"text-caption text-grey"},"P. Costo",-1)),d("div",Po,"$"+c(y(o.precio_costo)),1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[9]||(e[9]=d("div",{class:"text-caption text-grey"},"Margen",-1)),d("div",$o,c(o.margen)+"%",1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[10]||(e[10]=d("div",{class:"text-caption text-grey"},"P. Venta",-1)),d("div",ko,"$"+c(y(o.precio_venta)),1)]),_:2},1024)],64)),a(i,{cols:o.esVidrio?12:4,md:o.esVidrio?12:1,class:ro(o.esVidrio?"":"text-right")},{default:r(()=>[a(C,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:s=>K(l)},null,8,["onClick"])]),_:2},1032,["cols","md","class"])]),_:2},1024)]),_:2},1024))),128)),a(U,{class:"pa-3 bg-primary-lighten-5",outlined:""},{default:r(()=>[a(k,null,{default:r(()=>[a(i,{cols:"12",class:"text-right"},{default:r(()=>[e[11]||(e[11]=d("div",{class:"text-subtitle-2 text-grey"},"Total productos seleccionados:",-1)),d("div",Ao,"$"+c(y(X.value)),1)]),_:1})]),_:1})]),_:1})])):(m(),V(fo,{key:1,type:"info",variant:"tonal",class:"mt-4"},{default:r(()=>e[12]||(e[12]=[f(" Busca y selecciona productos de la tabla para agregarlos a la cotización ")])),_:1}))]),_:1}),a(co,null,{default:r(()=>[a(vo),a(C,{color:"grey",variant:"text",onClick:N},{default:r(()=>e[13]||(e[13]=[f(" Cancelar ")])),_:1}),a(C,{color:"primary",variant:"elevated",disabled:u.value.length===0,onClick:oo},{default:r(()=>[f(" Agregar "+c(u.value.length)+" producto(s) ",1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},te=so(Io,[["__scopeId","data-v-88061c45"]]);export{te as default};
