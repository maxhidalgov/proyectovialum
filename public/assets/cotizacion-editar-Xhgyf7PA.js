import{r as n,j as io,au as _,X as ro,E as lo,f as k,e as r,k as so,o as m,c as f,F as P,b as i,t as c,v as V,a3 as x,Z as A,a2 as no,m as B,i as uo,d as O}from"./index-DYMceNWG.js";import co from"./VentanaForm-CjFpdj6E.js";import po from"./AgregarVentanaModal-DN3YQEao.js";import{d as _o}from"./debounce-0NXr9dVh.js";import{V as mo}from"./VContainer-CO2HTMTQ.js";import{V as D,b as U}from"./VCard-CBHxwNdg.js";import{V as I}from"./VSpacer-B375I71-.js";import{V as vo}from"./VCardText-4lG1nYAG.js";import{V as Vo}from"./VForm-DykMwXQl.js";import{V as J,a as g}from"./VRow-q--0_byE.js";import{V as fo}from"./VAutocomplete-DLStVuLU.js";import{V as go}from"./VTextField-uHRdvwvX.js";import{V as bo}from"./VSelect-DkqZfatN.js";import{V as zo}from"./VTextarea-d3ooDS_Z.js";import{V as N}from"./VAlert-ByNqPXc9.js";import{V as yo}from"./VDataTable-BuD5hFFF.js";import{V as L}from"./VChip--B5kh3pi.js";import"./VDialog-CPxcCCUx.js";import"./VOverlay-B0LZfzvn.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-BdNk6NMH.js";/* empty css              */import"./VAvatar--oB_bTjf.js";import"./VImg-DJXENaQY.js";import"./VInput-Bfuylp40.js";import"./VList-CIuBNxRS.js";import"./VDivider-CtqN3et3.js";import"./VMenu-3wN_fvCw.js";import"./VCheckboxBtn-CIqsUzBX.js";import"./VSelectionControl-mQQLVTOm.js";const Co={key:0},ho={key:1},jo={key:0},ea={__name:"cotizacion-editar",setup(ko){const y=n(!1),H=io(),q=so(),G=H.query.id;n([]);const $=n([]),E=n(null),S=n([]),M=n([]);n(!1),n(X());function X(){return{tipo_ventana_id:null,ancho:null,alto:null,cantidad:1,color_id:null,tipo_vidrio_id:null,producto_vidrio_proveedor_id:null,hojas_totales:2,hojas_moviles:2,costo:0,precio:0,materiales:[]}}const Z=l=>b.value.flatMap(o=>o.colores_por_proveedor.map(a=>({id:a.id,producto_id:o.id,proveedor_id:a.proveedor_id}))).find(o=>o.id===l),K=_o(async(l,o)=>{if(!l.productoVidrio||!l.proveedorVidrio||!l.tipo||!l.ancho||!l.alto){console.warn("⚠️ Payload incompleto para cálculo:",l);return}try{console.log("➡️ Enviando a /api/cotizador/calcular-materiales:",l);const a=await _.post("/api/cotizador/calcular-materiales",l);console.log("✅ Respuesta del backend:",a.data);const e=o.cantidad||1;o.costo_total_unitario=a.data.costo_unitario,o.costo_total=a.data.costo_unitario*e,o.precio_unitario=Math.ceil(a.data.costo_unitario/(1-.45)),o.precio=o.precio_unitario*e,o.materiales=a.data.materiales??[],t.value.ventanas=[...t.value.ventanas],console.log("🧮 Costo asignado:",o.costo),console.log("🧮 Precio asignado:",o.precio);const s=t.value.ventanas.findIndex(u=>u===o);s!==-1&&(t.value.ventanas[s]={...o})}catch(a){console.error("❌ Error al calcular materiales:",a),o.costo=0,o.precio=0,o.materiales=[];const e=t.value.ventanas.findIndex(s=>s===o);e!==-1&&(t.value.ventanas[e]={...o})}},800),t=n({fecha:"",estado_cotizacion_id:null,observaciones:"",ventanas:[]});n(null);const Q=l=>{const o=Z(l.producto_vidrio_proveedor_id),a={...l,costo:0,precio:0,materiales:[]};t.value.ventanas.push(a),console.log("🧾 Lista actual de ventanas:",t.value.ventanas);const e={...a,tipo:a.tipo_ventana_id,tipoVidrio:a.tipo_vidrio_id,productoVidrio:o==null?void 0:o.producto_id,proveedorVidrio:o==null?void 0:o.proveedor_id,hojas_moviles:a.tipo_ventana_id===3||a.tipo_ventana_id===46?a.hojas_moviles:void 0};console.log("✅ Ejecutando recalcularCosto para ventana agregada..."),K(e,a),t.value.ventanas=[...t.value.ventanas],y.value=!1},W=n(null),Y=[{title:"Tipo de ventana",value:"tipo_ventana_id"},{title:"Ancho (mm)",value:"ancho"},{title:"Alto (mm)",value:"alto"},{title:"Cantidad",value:"cantidad"},{title:"Color",value:"color_id"},{title:"Vidrio",value:"producto_vidrio_proveedor_id"},{title:"Hojas Totales",value:"hojas_totales"},{title:"Hojas Móviles",value:"hojas_moviles"},{title:"Costo",value:"costo"},{title:"Precio",value:"precio"}],C=n([]),h=n([]),j=n([]),b=n([]),T=ro(()=>b.value.flatMap(l=>l.colores_por_proveedor.map(o=>{var a;return{id:o.id,nombre:`${l.nombre} (${((a=o.proveedor)==null?void 0:a.nombre)||"Desconocido"})`,producto_id:l.id,proveedor_id:o.proveedor_id,producto:l,proveedor:o.proveedor}}))),w=()=>{q.push({path:"/cotizaciones"})},R=async()=>{const l=JSON.stringify(E.value),o=JSON.stringify(t.value);if(l===o){alert("No hay cambios para guardar");return}try{console.log("🧾 Payload a guardar:",t.value.ventanas.map(e=>({id:e.id,hojas_totales:e.hojas_totales,hojas_moviles:e.hojas_moviles,tipo_ventana_id:e.tipo_ventana_id})));const a={cliente_id:t.value.cliente_id,fecha:t.value.fecha,estado_cotizacion_id:t.value.estado_cotizacion_id,observaciones:t.value.observaciones,ventanas:t.value.ventanas.map(e=>({id:e.id,tipo_ventana_id:e.tipo_ventana_id,ancho:e.ancho,alto:e.alto,cantidad:e.cantidad||1,color_id:e.color_id,tipo_vidrio_id:e.tipo_vidrio_id,producto_vidrio_proveedor_id:Number(e.producto_vidrio_proveedor_id),costo:e.costo_total||e.costo||0,costo_unitario:e.costo_unitario||0,precio:e.precio||0,precio_unitario:e.precio_unitario||0,hojas_totales:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_totales:null,hojas_moviles:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_moviles:null}))};await _.put(`/api/cotizaciones/${t.value.id}`,a),alert("Cotización actualizada correctamente"),w()}catch(a){console.error("❌ Error al guardar cambios:",a),alert("Error al guardar cambios")}};return lo(async()=>{try{const[l,o,a,e,s,u,oo,ao]=await Promise.all([_.get(`/api/cotizaciones/${G}`),_.get("/api/tipos_ventana"),_.get("/api/colores"),_.get("/api/tipos_producto"),_.get("/api/productos"),_.get("/api/estados-cotizacion"),_.get("/api/clientes"),_.get("/api/tipos_material")]);b.value=s.data.filter(d=>[1,2].includes(d.tipo_producto_id));const eo=b.value.flatMap(d=>d.colores_por_proveedor.map(v=>{var p;return{id:v.id,nombre:`${d.nombre} (${((p=v.proveedor)==null?void 0:p.nombre)||"Desconocido"})`,producto_id:d.id,proveedor_id:v.proveedor_id,producto:d,proveedor:v.proveedor}})),z=l.data;z.ventanas=(z.ventanas||[]).map(d=>{var F;const v=Number(d.producto_vidrio_proveedor_id),p=eo.find(to=>to.id===v);return{...d,hojas_totales:d.hojas_totales??2,hojas_moviles:d.hojas_moviles??2,producto_vidrio_proveedor_id:v,cantidad:d.cantidad||1,tipo_vidrio_id:((F=p==null?void 0:p.producto)==null?void 0:F.tipo_producto_id)??null,producto_vidrio_proveedor:p||null,producto_vidrio_nombre:(p==null?void 0:p.nombre)||"—"}}),z.ventanas=z.ventanas.map(d=>({...d,original:{tipo_ventana_id:d.tipo_ventana_id,ancho:d.ancho,alto:d.alto,cantidad:d.cantidad||1,color_id:d.color_id,tipo_vidrio_id:d.tipo_vidrio_id,producto_vidrio_proveedor_id:d.producto_vidrio_proveedor_id}})),t.value=z,S.value=oo.data,M.value=ao.data,E.value=JSON.parse(JSON.stringify(t.value)),C.value=o.data,h.value=a.data,j.value=e.data.filter(d=>[1,2].includes(d.id)),$.value=u.data,console.log("🧪 productosVidrioFiltrados:",T.value),console.log("🧾 ventanas:",t.value.ventanas.map(d=>d.producto_vidrio_proveedor_id))}catch(l){console.error("Error al cargar cotización:",l)}}),(l,o)=>(m(),k(mo,null,{default:r(()=>[t.value?(m(),f(P,{key:0},[i(D,{class:"mb-4"},{default:r(()=>[i(U,null,{default:r(()=>[c(" Editar Cotización #"+V(t.value.id)+" ",1),i(I),i(x,{icon:"",onClick:w},{default:r(()=>[i(A,null,{default:r(()=>o[6]||(o[6]=[c("mdi-arrow-left")])),_:1})]),_:1})]),_:1}),i(vo,null,{default:r(()=>[i(Vo,{onSubmit:no(R,["prevent"]),ref_key:"form",ref:W},{default:r(()=>[i(J,null,{default:r(()=>[i(g,{cols:"12",sm:"6"},{default:r(()=>[i(fo,{modelValue:t.value.cliente_id,"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.cliente_id=a),items:S.value,"item-title":"razon_social","item-value":"id",label:"Cliente",clearable:""},null,8,["modelValue","items"])]),_:1}),i(g,{cols:"12",sm:"6"},{default:r(()=>[i(go,{modelValue:t.value.fecha,"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.fecha=a),label:"Fecha",type:"date"},null,8,["modelValue"])]),_:1}),i(g,{cols:"12",sm:"6"},{default:r(()=>[i(bo,{modelValue:t.value.estado_cotizacion_id,"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.estado_cotizacion_id=a),items:$.value,"item-value":"id","item-title":"nombre",label:"Estado"},null,8,["modelValue","items"])]),_:1}),i(g,{cols:"12"},{default:r(()=>[i(zo,{modelValue:t.value.observaciones,"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.observaciones=a),label:"Observaciones"},null,8,["modelValue"])]),_:1})]),_:1}),i(x,{type:"submit",color:"primary",class:"mt-4"},{default:r(()=>o[7]||(o[7]=[c("Guardar Cambios")])),_:1})]),_:1},512)]),_:1})]),_:1}),i(D,null,{default:r(()=>[i(U,null,{default:r(()=>[o[9]||(o[9]=c(" Ventanas ")),i(I),t.value.estado_cotizacion_id===1?(m(),k(x,{key:0,icon:"",onClick:o[4]||(o[4]=a=>y.value=!0)},{default:r(()=>[i(A,null,{default:r(()=>o[8]||(o[8]=[c("mdi-plus")])),_:1})]),_:1})):B("",!0)]),_:1}),t.value.estado_cotizacion_id===1?(m(),f("div",Co,[(m(!0),f(P,null,uo(t.value.ventanas,(a,e)=>(m(),f("div",{key:e,class:"mb-6"},[i(co,{ventana:a,tiposVentana:C.value,colores:h.value,tiposVidrio:j.value,productosVidrio:T.value},null,8,["ventana","tiposVentana","colores","tiposVidrio","productosVidrio"]),i(J,{class:"mt-2 px-4"},{default:r(()=>[i(g,{cols:"6"},{default:r(()=>[i(N,{type:"info",variant:"tonal",color:"blue"},{default:r(()=>{var s,u;return[o[10]||(o[10]=O("strong",null,"Costo:",-1)),c(" $"+V(((u=(s=a.costo)==null?void 0:s.toLocaleString)==null?void 0:u.call(s))||0),1)]}),_:2},1024)]),_:2},1024),i(g,{cols:"6"},{default:r(()=>[i(N,{type:"success",variant:"tonal",color:"green"},{default:r(()=>{var s,u;return[o[11]||(o[11]=O("strong",null,"Precio:",-1)),c(" $"+V(((u=(s=a.precio)==null?void 0:s.toLocaleString)==null?void 0:u.call(s))||0),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))])):(m(),f("div",ho,[i(yo,{headers:Y,items:t.value.ventanas,"items-per-page":5,class:"elevation-1"},{"item.tipo_ventana_id":r(({item:a})=>{var e;return[c(V(((e=a.tipo_ventana)==null?void 0:e.nombre)||"—"),1)]}),"item.color_id":r(({item:a})=>[i(L,{color:"primary",variant:"tonal",size:"small"},{default:r(()=>{var e;return[c(V(((e=a.color_obj)==null?void 0:e.nombre)||"—"),1)]}),_:2},1024)]),"item.producto_vidrio_proveedor_id":r(({item:a})=>[i(L,{color:"green",variant:"tonal",size:"small"},{default:r(()=>{var e,s,u;return[c(V(((s=(e=a.producto_vidrio_proveedor)==null?void 0:e.producto)==null?void 0:s.nombre)||"—")+" ",1),(u=a.producto_vidrio_proveedor)!=null&&u.proveedor?(m(),f("span",jo," ("+V(a.producto_vidrio_proveedor.proveedor.nombre)+") ",1)):B("",!0)]}),_:2},1024)]),_:1},8,["items"])]))]),_:1}),i(po,{modelValue:y.value,"onUpdate:modelValue":o[5]||(o[5]=a=>y.value=a),tiposVentana:C.value,colores:h.value,materiales:M.value,tiposVidrio:j.value,productosVidrio:b.value,onAgregar:Q},null,8,["modelValue","tiposVentana","colores","materiales","tiposVidrio","productosVidrio"])],64)):(m(),k(N,{key:1,type:"info",variant:"outlined",class:"mt-4"},{default:r(()=>o[12]||(o[12]=[c(" Cargando cotización... ")])),_:1}))]),_:1}))}};export{ea as default};
