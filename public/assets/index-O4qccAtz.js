import{ar as G,f as Q,e as o,b as e,t as d,Z as B,a3 as q,o as h,d as a,v as u,m as oe,c as O,a as ye,aQ as me,aR as fe,r as L,w as se,a2 as ze,X as pe,E as $e,F as Ee,i as Le,q as Te}from"./index-DVH5_zAC.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as M,c as de,V as P}from"./VCard-COrdRJy_.js";import{V as W}from"./VDivider-DRFFLgzE.js";import{V as I}from"./VCardText-CjaUBipx.js";import{V as ue}from"./VForm-39R0lN7h.js";import{V as J,a as V}from"./VRow-B11LxY42.js";import{V as F}from"./VTextField-CPMs-WRD.js";import{V as ee}from"./VSelect-1AUmKITv.js";import{V as Ne}from"./VCheckbox-B355fbFP.js";import{V as ce}from"./VSpacer-Doa9SyIl.js";import{V as ie}from"./VDialog-BnFs-wUc.js";import{V as Se}from"./VAlert-C8Os17kO.js";import{V as ke}from"./VAutocomplete-BpRMQiZT.js";import{a as te,b as ae,d as ve,V as Be}from"./VList-DlqD1lUI.js";import{V as De}from"./VTextarea-B4D_kEEq.js";import{V as Fe}from"./VSwitch-BVE41btl.js";import{V as le}from"./VChip-6LEPsz9j.js";import{V as he}from"./VDataTable-I1JlzO2v.js";import{V as Pe}from"./VAvatar-DhgsH_Fv.js";import{V as xe}from"./VImg-CFgr5isP.js";import{V as je}from"./VMenu-DPmMVBcN.js";import"./VInput-DvJG3W6V.js";import"./transition-sBQMWBRJ.js";import"./forwardRefs-DWGaNmQL.js";/* empty css              */import"./VOverlay-DzZwY3HF.js";import"./VCheckboxBtn-7U5_OoeV.js";import"./VSelectionControl-sJMu9Y8j.js";import"./filter-bYy-Y7_U.js";const qe={name:"ModalCrearClienteBsale",props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","cliente-creado"],data(){return{formValid:!1,creandoCliente:!1,comunas:[{id:1,name:"Santiago"},{id:2,name:"Las Condes"},{id:3,name:"Providencia"},{id:4,name:"√ëu√±oa"},{id:5,name:"La Reina"},{id:6,name:"Vitacura"},{id:7,name:"Lo Barnechea"},{id:8,name:"Maip√∫"},{id:9,name:"Puente Alto"},{id:10,name:"La Florida"}],formulario:{nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},emailRules:[i=>!i||/.+@.+\..+/.test(i)||"Email debe ser v√°lido"]}},computed:{dialog:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}},watch:{dialog(i){i&&this.cotizacion&&this.precargarDatos()}},methods:{precargarDatos(){var i;if((i=this.cotizacion)!=null&&i.cliente){const t=this.cotizacion.cliente;this.formulario.nombre=t.nombre||"",this.formulario.rut=t.rut||"",this.formulario.email=t.email||"",this.formulario.telefono=t.telefono||"",this.formulario.direccion=t.direccion||"",this.formulario.giro="Comercio al por menor"}},async crearCliente(){var i,t;if(this.formValid){this.creandoCliente=!0;try{const b={nombre:this.formulario.nombre,apellido:this.formulario.apellido,rut:this.formulario.rut,email:this.formulario.email,telefono:this.formulario.telefono,empresa:this.formulario.empresa,giro:this.formulario.giro,direccion:this.formulario.direccion,comuna_id:this.formulario.comuna_id,enviar_email:this.formulario.enviar_email},x=await G.post("/api/bsale/clientes",b);if(x.data.success)this.$emit("cliente-creado",x.data.cliente),this.cerrar();else throw new Error(x.data.error||"Error desconocido")}catch(b){console.error("Error creando cliente:",b);const x=((t=(i=b.response)==null?void 0:i.data)==null?void 0:t.error)||b.message||"Error al crear cliente";this.$toast.error(x)}finally{this.creandoCliente=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var i;this.formulario={nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},(i=this.$refs.form)==null||i.resetValidation()}}};function Ae(i,t,b,x,n,z){return h(),Q(ie,{modelValue:z.dialog,"onUpdate:modelValue":t[11]||(t[11]=p=>z.dialog=p),"max-width":"600px",persistent:""},{default:o(()=>[e(P,null,{default:o(()=>[e(M,{class:"text-h5 pa-4"},{default:o(()=>[e(B,{class:"mr-2",color:"primary"},{default:o(()=>t[12]||(t[12]=[d("mdi-account-plus")])),_:1}),t[13]||(t[13]=d(" Crear Cliente en BSALE "))]),_:1}),e(W),e(I,{class:"pa-4"},{default:o(()=>[e(ue,{ref:"form",modelValue:n.formValid,"onUpdate:modelValue":t[10]||(t[10]=p=>n.formValid=p)},{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.nombre,"onUpdate:modelValue":t[0]||(t[0]=p=>n.formulario.nombre=p),label:"Nombre",rules:[p=>!!p||"Nombre es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.apellido,"onUpdate:modelValue":t[1]||(t[1]=p=>n.formulario.apellido=p),label:"Apellido",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.rut,"onUpdate:modelValue":t[2]||(t[2]=p=>n.formulario.rut=p),label:"RUT",rules:[p=>!!p||"RUT es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.email,"onUpdate:modelValue":t[3]||(t[3]=p=>n.formulario.email=p),label:"Email",type:"email",rules:n.emailRules,outlined:"","prepend-inner-icon":"mdi-email"},null,8,["modelValue","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.telefono,"onUpdate:modelValue":t[4]||(t[4]=p=>n.formulario.telefono=p),label:"Tel√©fono",outlined:"","prepend-inner-icon":"mdi-phone",placeholder:"+56 9 1234 5678"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.empresa,"onUpdate:modelValue":t[5]||(t[5]=p=>n.formulario.empresa=p),label:"Empresa",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(F,{modelValue:n.formulario.giro,"onUpdate:modelValue":t[6]||(t[6]=p=>n.formulario.giro=p),label:"Giro/Actividad",rules:[p=>!!p||"Giro es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-briefcase",placeholder:"Ej: Comercio al por menor"},null,8,["modelValue","rules"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(F,{modelValue:n.formulario.direccion,"onUpdate:modelValue":t[7]||(t[7]=p=>n.formulario.direccion=p),label:"Direcci√≥n",outlined:"","prepend-inner-icon":"mdi-map-marker",placeholder:"Ej: Av. Principal 123"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:n.formulario.comuna_id,"onUpdate:modelValue":t[8]||(t[8]=p=>n.formulario.comuna_id=p),items:n.comunas,"item-value":"id","item-title":"name",label:"Comuna",rules:[p=>!!p||"Comuna es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-city"},null,8,["modelValue","items","rules"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(Ne,{modelValue:n.formulario.enviar_email,"onUpdate:modelValue":t[9]||(t[9]=p=>n.formulario.enviar_email=p),label:"Enviar email de bienvenida al cliente",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(W),e(de,{class:"pa-4"},{default:o(()=>[e(ce),e(q,{color:"grey",text:"",onClick:z.cerrar,disabled:n.creandoCliente},{default:o(()=>t[14]||(t[14]=[d(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(q,{color:"primary",onClick:z.crearCliente,loading:n.creandoCliente,disabled:!n.formValid},{default:o(()=>[e(B,{left:""},{default:o(()=>t[15]||(t[15]=[d("mdi-account-plus")])),_:1}),t[16]||(t[16]=d(" Crear Cliente "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const Ue=we(qe,[["render",Ae],["__scopeId","data-v-99c8a3e8"]]),Me={name:"ModalBsale",components:{ModalCrearClienteBsale:Ue},props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","documento-generado"],data(){return{formValid:!1,generandoDocumento:!1,cargandoClientes:!1,cargandoClientesSincronizados:!1,busquedaCliente:"",dialogCrearCliente:!1,tiposDocumento:[{id:3,name:"Nota de Venta",codeSii:"",description:"Documento de preventa"},{id:5,name:"Factura Electr√≥nica",codeSii:"33",description:"Documento tributario electr√≥nico"},{id:1,name:"Boleta Electr√≥nica",codeSii:"39",description:"Boleta electr√≥nica para consumidor final"}],oficinas:[],clientesBsale:[],clientesSincronizados:[],metodosPago:[{text:"Efectivo",value:"efectivo"},{text:"Transferencia",value:"transferencia"},{text:"Cheque",value:"cheque"},{text:"Tarjeta de Cr√©dito",value:"tarjeta_credito"},{text:"Tarjeta de D√©bito",value:"tarjeta_debito"}],formulario:{tipo_documento:null,oficina_id:null,cliente_bsale_id:null,cliente_facturacion_id:null,metodo_pago:"transferencia",condiciones_pago:"30 d√≠as",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""}}},computed:{dialog:{get(){return this.modelValue},set(i){this.$emit("update:modelValue",i)}}},watch:{dialog(i){i&&this.cargarDatosIniciales()}},methods:{async cargarDatosIniciales(){var i,t,b,x,n,z;console.log("üîÑ Cargando datos iniciales BSALE...");try{if(await this.cargarOficinas(),await this.cargarTiposDocumento(),await this.cargarClientesSincronizados(),(t=(i=this.cotizacion)==null?void 0:i.cliente)!=null&&t.id){const p=this.clientesSincronizados.find(_=>_.id===this.cotizacion.cliente.id);p&&(this.formulario.cliente_facturacion_id=p.id)}console.log("‚úÖ Datos iniciales cargados correctamente")}catch(p){console.error("‚ùå Error cargando datos iniciales:",p),console.error("Response:",(b=p.response)==null?void 0:b.data),console.error("Status:",(x=p.response)==null?void 0:x.status),console.error("URL:",(n=p.config)==null?void 0:n.url),(z=this.$toast)==null||z.error("Error al cargar datos de BSALE")}},async cargarOficinas(){try{const i=await G.get("/api/bsale-oficinas");this.oficinas=i.data.items.map(t=>({id:t.id,name:t.name,description:t.description,address:t.address})),console.log("‚úÖ Oficinas cargadas:",this.oficinas.length)}catch(i){console.error("‚ùå Error cargando oficinas:",i),this.oficinas=[{id:1,name:"Oficina Principal"}]}},async cargarTiposDocumento(){try{const i=await G.get("/api/bsale-tipos-documento");this.tiposDocumento=i.data.items.map(t=>({id:t.id,name:t.name,codeSii:t.codeSii,description:t.description})),console.log("‚úÖ Tipos de documento cargados:",this.tiposDocumento.length)}catch(i){console.error("‚ùå Error cargando tipos de documento:",i),console.log("Usando tipos de documento est√°ticos como fallback")}},async cargarClientesSincronizados(){var i;this.cargandoClientesSincronizados=!0;try{const t=await G.get("/api/bsale/clientes-sincronizados");t.data.success&&(this.clientesSincronizados=t.data.clientes,console.log("‚úÖ Clientes sincronizados cargados:",this.clientesSincronizados.length))}catch(t){console.error("‚ùå Error cargando clientes sincronizados:",t),(i=this.$toast)==null||i.error("Error al cargar clientes sincronizados")}finally{this.cargandoClientesSincronizados=!1}},async buscarClientes(i){var t;if(!(!i||i.length<2)){this.cargandoClientes=!0;try{const b=await G.get("/api/bsale/clientes",{params:{search:i}});b.data.success&&(this.clientesBsale=((t=b.data.clientes.items)==null?void 0:t.map(x=>({...x,displayName:`${x.company||`${x.firstName||""} ${x.lastName||""}`.trim()||"Sin nombre"} - ${x.code}`})))||[])}catch(b){console.error("Error buscando clientes:",b)}finally{this.cargandoClientes=!1}}},async buscarClientesPorRut(i){this.cargandoClientes=!0;try{const t=await G.get("/api/bsale/clientes",{params:{search:i}});if(t.data.success){const b=t.data.clientes.items||[];this.clientesBsale=b.map(n=>({...n,displayName:`${n.company||`${n.firstName||""} ${n.lastName||""}`.trim()||"Sin nombre"} - ${n.code}`}));const x=b.find(n=>n.code===i);x&&(this.formulario.cliente_bsale_id=x.id)}}catch(t){console.error("Error buscando cliente por RUT:",t)}finally{this.cargandoClientes=!1}},abrirCrearCliente(){this.dialogCrearCliente=!0},onClienteCreado(i){this.clientesBsale.unshift({...i,displayName:`${i.company||`${i.firstName||""} ${i.lastName||""}`.trim()||"Sin nombre"} - ${i.code}`}),this.formulario.cliente_bsale_id=i.id,this.$toast.success("Cliente creado exitosamente")},async generarDocumento(){var i,t,b,x,n,z,p;if(this.formValid){this.generandoDocumento=!0;try{const _={cotizacion_id:this.cotizacion.id,tipo_documento:this.formulario.tipo_documento,cliente_facturacion_id:this.formulario.cliente_facturacion_id,metodo_pago:this.formulario.metodo_pago,condiciones_pago:this.formulario.condiciones_pago,fecha_vencimiento:this.formulario.fecha_vencimiento,observaciones:this.formulario.observaciones};console.log("üì§ Enviando documento a Bsale:",_);const r=await G.post("/api/bsale/documento",_);if(r.data&&r.data.success){const $=r.data.documento,T=this.tiposDocumento.find(C=>C.id===this.formulario.tipo_documento);this.$toast.success(`${(T==null?void 0:T.name)||"Documento"} #${$.number} generado exitosamente
Total: $${(i=$.totalAmount)==null?void 0:i.toLocaleString("es-CL")}
ID BSALE: ${$.id}`,{timeout:8e3}),$.urlPdf&&this.$toast.info(`PDF disponible: ${$.urlPdf}`,{timeout:1e4,action:{text:"Abrir PDF",onClick:()=>window.open($.urlPdf,"_blank")}}),this.$emit("documento-generado",$),this.cerrar()}else throw new Error(((t=r.data)==null?void 0:t.error)||((b=r.data)==null?void 0:b.message)||"Error desconocido")}catch(_){console.error("Error generando documento:",_);const r=((n=(x=_.response)==null?void 0:x.data)==null?void 0:n.error)||((p=(z=_.response)==null?void 0:z.data)==null?void 0:p.message)||_.message||"Error al generar documento";this.$toast.error(r)}finally{this.generandoDocumento=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var i;this.formulario={tipo_documento:null,oficina_id:null,cliente_bsale_id:null,metodo_pago:"transferencia",condiciones_pago:"30 d√≠as",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""},(i=this.$refs.form)==null||i.resetValidation()},getFechaVencimiento(){const i=new Date;return i.setDate(i.getDate()+30),i.toISOString().split("T")[0]},formatearPrecio(i){return new Intl.NumberFormat("es-CL").format(i)},formatearFecha(i){return i?new Date(i).toLocaleDateString("es-CL"):"N/A"}}},Ie={class:"mb-2"},Re={class:"mb-1"},Oe={class:"mb-1"},Ge={class:"mb-0"},Qe={class:"d-flex align-center"},Xe={key:0},Ze={key:1};function He(i,t,b,x,n,z){const p=ye("v-list-item-content"),_=Ue;return h(),Q(ie,{modelValue:z.dialog,"onUpdate:modelValue":t[10]||(t[10]=r=>z.dialog=r),"max-width":"800px",persistent:""},{default:o(()=>[e(P,null,{default:o(()=>[e(M,{class:"text-h5 pa-4"},{default:o(()=>[e(B,{class:"mr-2",color:"success"},{default:o(()=>t[11]||(t[11]=[d("mdi-receipt")])),_:1}),t[12]||(t[12]=d(" Generar Documento Electr√≥nico "))]),_:1}),e(W),e(I,{class:"pa-4"},{default:o(()=>[e(J,{class:"mb-4"},{default:o(()=>[e(V,{cols:"12"},{default:o(()=>[e(P,{outlined:"",class:"pa-3"},{default:o(()=>{var r,$,T,C,y;return[a("h4",Ie,"Cotizaci√≥n #"+u(((r=b.cotizacion)==null?void 0:r.numero)||"N/A"),1),a("p",Re,[t[13]||(t[13]=a("strong",null,"Cliente:",-1)),d(" "+u(((T=($=b.cotizacion)==null?void 0:$.cliente)==null?void 0:T.nombre)||"N/A"),1)]),a("p",Oe,[t[14]||(t[14]=a("strong",null,"Total:",-1)),d(" $"+u(z.formatearPrecio(((C=b.cotizacion)==null?void 0:C.total)||0)),1)]),a("p",Ge,[t[15]||(t[15]=a("strong",null,"Fecha:",-1)),d(" "+u(z.formatearFecha((y=b.cotizacion)==null?void 0:y.created_at)),1)])]}),_:1})]),_:1})]),_:1}),e(ue,{ref:"form",modelValue:n.formValid,"onUpdate:modelValue":t[8]||(t[8]=r=>n.formValid=r)},{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:n.formulario.tipo_documento,"onUpdate:modelValue":t[0]||(t[0]=r=>n.formulario.tipo_documento=r),items:n.tiposDocumento,"item-value":"id","item-title":"name",label:"Tipo de documento",rules:[r=>!!r||"Tipo de documento es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-file-document"},null,8,["modelValue","items","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:n.formulario.oficina_id,"onUpdate:modelValue":t[1]||(t[1]=r=>n.formulario.oficina_id=r),items:n.oficinas,"item-value":"id","item-title":"name",label:"Oficina",rules:[r=>!!r||"Oficina es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue","items","rules"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(Se,{type:n.formulario.tipo_documento==1?"success":"info",variant:"tonal",class:"mb-3"},{default:o(()=>[a("div",Qe,[e(B,{class:"mr-2"},{default:o(()=>t[16]||(t[16]=[d("mdi-information")])),_:1}),n.formulario.tipo_documento==1?(h(),O("div",Xe,t[17]||(t[17]=[a("strong",null,"Boleta Electr√≥nica:",-1),d(" Para boletas no es necesario seleccionar un cliente espec√≠fico. "),a("br",null,null,-1),a("small",null,'Si no seleccionas un cliente, se usar√° "Consumidor Final".',-1)]))):(h(),O("div",Ze,t[18]||(t[18]=[a("strong",null,"Cliente de facturaci√≥n:",-1),d(" Selecciona el cliente que aparecer√° en la factura de Bsale. "),a("br",null,null,-1),a("small",null,[d("Solo se muestran clientes sincronizados con Bsale. "),a("strong",null,"Campo obligatorio para facturas.")],-1)])))])]),_:1},8,["type"]),e(ke,{modelValue:n.formulario.cliente_facturacion_id,"onUpdate:modelValue":t[2]||(t[2]=r=>n.formulario.cliente_facturacion_id=r),items:n.clientesSincronizados,"item-value":"id","item-title":r=>`${r.razon_social} (${r.identification||"Sin RUT"})`,label:n.formulario.tipo_documento==1?"Cliente para facturaci√≥n (Opcional)":"Cliente para facturaci√≥n",loading:n.cargandoClientesSincronizados,rules:n.formulario.tipo_documento==1?[]:[r=>!!r||"Cliente de facturaci√≥n es requerido para facturas"],required:n.formulario.tipo_documento!=1,outlined:"","prepend-inner-icon":"mdi-account-cash",clearable:"",hint:n.formulario.tipo_documento==1?"Opcional: Deja en blanco para usar Consumidor Final":"Selecciona el cliente que recibir√° la factura","persistent-hint":""},{item:o(({props:r,item:$})=>[e(te,me(fe(r)),{title:o(()=>[d(u($.raw.razon_social),1)]),subtitle:o(()=>[d(" RUT: "+u($.raw.identification||"Sin RUT")+" | Bsale ID: "+u($.raw.bsale_id),1)]),_:2},1040)]),"no-data":o(()=>[e(te,null,{default:o(()=>[e(p,null,{default:o(()=>[e(ae,null,{default:o(()=>t[19]||(t[19]=[d(" No hay clientes sincronizados ")])),_:1}),e(ve,null,{default:o(()=>t[20]||(t[20]=[d(" Ejecuta el comando de sincronizaci√≥n en el servidor ")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","items","item-title","label","loading","rules","required","hint"])]),_:1}),oe("",!0),e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:n.formulario.metodo_pago,"onUpdate:modelValue":t[4]||(t[4]=r=>n.formulario.metodo_pago=r),items:n.metodosPago,"item-title":"text","item-value":"value",label:"M√©todo de pago",outlined:"","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.condiciones_pago,"onUpdate:modelValue":t[5]||(t[5]=r=>n.formulario.condiciones_pago=r),label:"Condiciones de pago",outlined:"","prepend-inner-icon":"mdi-calendar-clock",placeholder:"Ej: 30 d√≠as"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:n.formulario.fecha_vencimiento,"onUpdate:modelValue":t[6]||(t[6]=r=>n.formulario.fecha_vencimiento=r),label:"Fecha de vencimiento",type:"date",outlined:"","prepend-inner-icon":"mdi-calendar"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(De,{modelValue:n.formulario.observaciones,"onUpdate:modelValue":t[7]||(t[7]=r=>n.formulario.observaciones=r),label:"Observaciones",outlined:"",rows:"3","prepend-inner-icon":"mdi-note-text",placeholder:"Observaciones adicionales para el documento..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(W),e(de,{class:"pa-4"},{default:o(()=>[e(ce),e(q,{color:"grey",text:"",onClick:z.cerrar,disabled:n.generandoDocumento},{default:o(()=>t[23]||(t[23]=[d(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(q,{color:"success",onClick:z.generarDocumento,loading:n.generandoDocumento,disabled:!n.formValid},{default:o(()=>[e(B,{left:""},{default:o(()=>t[24]||(t[24]=[d("mdi-receipt")])),_:1}),t[25]||(t[25]=d(" Generar Documento "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),e(_,{modelValue:n.dialogCrearCliente,"onUpdate:modelValue":t[9]||(t[9]=r=>n.dialogCrearCliente=r),cotizacion:b.cotizacion,onClienteCreado:z.onClienteCreado},null,8,["modelValue","cotizacion","onClienteCreado"])]),_:1},8,["modelValue"])}const Je=we(Me,[["render",He],["__scopeId","data-v-bd422840"]]),Ke={__name:"CrearClienteBsale",props:{mostrar:Boolean},emits:["update:mostrar","cliente-creado"],setup(i,{emit:t}){const b=i,x=t,n=L(b.mostrar);se(()=>b.mostrar,T=>{n.value=T}),se(n,T=>{x("update:mostrar",T)});const z=L(!1),p=L(),_=L({nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}),r=async()=>{var C,y;const{valid:T}=await p.value.validate();if(T)try{z.value=!0;const X={nombre:_.value.nombre,apellido:_.value.apellido,empresa:_.value.empresa,rut:_.value.rut,giro:_.value.giro,email:_.value.email,telefono:_.value.telefono,direccion:_.value.direccion,enviar_email:_.value.enviar_email},{data:Z}=await G.post("/api/bsale/crear-cliente",X);Z.success&&(x("cliente-creado",Z.cliente),$(),alert("Cliente creado exitosamente"))}catch(X){console.error("Error creando cliente:",X);const Z=((y=(C=X.response)==null?void 0:C.data)==null?void 0:y.message)||"Error al crear cliente";alert(`‚ùå ${Z}`)}finally{z.value=!1}},$=()=>{n.value=!1,_.value={nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}};return(T,C)=>(h(),Q(ie,{modelValue:n.value,"onUpdate:modelValue":C[9]||(C[9]=y=>n.value=y),"max-width":"600px",persistent:""},{default:o(()=>[e(P,null,{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>C[10]||(C[10]=[d("mdi-account-plus")])),_:1}),C[11]||(C[11]=d(" Crear Cliente en BSALE "))]),_:1}),e(W),e(I,null,{default:o(()=>[e(ue,{ref_key:"formRef",ref:p,onSubmit:ze(r,["prevent"])},{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.nombre,"onUpdate:modelValue":C[0]||(C[0]=y=>_.value.nombre=y),label:"Nombre *",rules:[y=>!!y||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account",required:""},null,8,["modelValue","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.apellido,"onUpdate:modelValue":C[1]||(C[1]=y=>_.value.apellido=y),label:"Apellido",variant:"outlined","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(F,{modelValue:_.value.empresa,"onUpdate:modelValue":C[2]||(C[2]=y=>_.value.empresa=y),label:"Empresa",variant:"outlined","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.rut,"onUpdate:modelValue":C[3]||(C[3]=y=>_.value.rut=y),label:"RUT",variant:"outlined","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.giro,"onUpdate:modelValue":C[4]||(C[4]=y=>_.value.giro=y),label:"Giro",variant:"outlined","prepend-inner-icon":"mdi-briefcase"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.email,"onUpdate:modelValue":C[5]||(C[5]=y=>_.value.email=y),label:"Email",type:"email",variant:"outlined","prepend-inner-icon":"mdi-email"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:_.value.telefono,"onUpdate:modelValue":C[6]||(C[6]=y=>_.value.telefono=y),label:"Tel√©fono",variant:"outlined","prepend-inner-icon":"mdi-phone"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(F,{modelValue:_.value.direccion,"onUpdate:modelValue":C[7]||(C[7]=y=>_.value.direccion=y),label:"Direcci√≥n",variant:"outlined","prepend-inner-icon":"mdi-map-marker"},null,8,["modelValue"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(Fe,{modelValue:_.value.enviar_email,"onUpdate:modelValue":C[8]||(C[8]=y=>_.value.enviar_email=y),label:"Enviar email de confirmaci√≥n",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),e(de,null,{default:o(()=>[e(ce),e(q,{variant:"text",onClick:$,disabled:z.value},{default:o(()=>C[12]||(C[12]=[d(" Cancelar ")])),_:1},8,["disabled"]),e(q,{color:"primary",onClick:r,loading:z.value},{default:o(()=>[e(B,{start:""},{default:o(()=>C[13]||(C[13]=[d("mdi-account-plus")])),_:1}),C[14]||(C[14]=d(" Crear Cliente "))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},We={class:"d-flex justify-space-between align-center"},Ye={class:"text-caption"},eo={class:"text-end"},oo={class:"text-h6 text-success"},to={class:"text-caption"},ao={class:"text-body-2"},lo={class:"text-body-2"},io={class:"text-h6 text-success mt-2"},no={__name:"ModalFacturacion",props:{mostrar:Boolean,cotizacion:Object},emits:["update:mostrar","documento-creado","actualizar-cotizacion"],setup(i,{emit:t}){const b=i,x=t,n=L(b.mostrar);se(()=>b.mostrar,k=>{n.value=k}),se(n,k=>{x("update:mostrar",k)});const z=L(!1),p=L(!1),_=L(""),r=L({tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}),$=L([{id:1,nombre:"Factura Afecta",descripcion:"Documento tributario con IVA"},{id:8,nombre:"Boleta Afecta",descripcion:"Para consumidores finales con IVA"},{id:9,nombre:"Gu√≠a de Despacho",descripcion:"Solo traslado de mercader√≠a"},{id:12,nombre:"Nota de Venta",descripcion:"Documento interno de venta"}]),T=L([{id:1,nombre:"Efectivo"},{id:2,nombre:"Transferencia Bancaria"},{id:3,nombre:"Cheque"},{id:4,nombre:"Tarjeta de Cr√©dito"},{id:5,nombre:"Tarjeta de D√©bito"}]),C=L([{nombre:"Contado",valor:"contado"},{nombre:"30 d√≠as",valor:"30_dias"},{nombre:"60 d√≠as",valor:"60_dias"},{nombre:"90 d√≠as",valor:"90_dias"}]),y=L([]),X=pe(()=>new Date().toISOString().split("T")[0]),Z=async(k="")=>{try{const{data:s}=await G.get("/api/bsale/clientes",{params:{search:k,limit:50}});s.success&&(y.value=(s.clientes.items||[]).map(v=>({...v,nombre_completo:v.company||`${v.firstName||""} ${v.lastName||""}`.trim()||"Sin nombre",rut:v.code||"Sin RUT",empresa:v.company||"Particular"})))}catch(s){console.error("Error buscando clientes:",s)}},S=async()=>{var k,s;try{z.value=!0;const v={cotizacion_id:b.cotizacion.id,tipo_documento:r.value.tipo_documento,metodo_pago:r.value.metodo_pago,condiciones_pago:r.value.condiciones_pago,fecha_vencimiento:r.value.fecha_vencimiento,cliente_bsale_id:r.value.cliente_bsale_id,observaciones:r.value.observaciones};console.log("Generando documento con payload:",v);const{data:c}=await G.post("/api/bsale/crear-documento",v);c.success&&(x("documento-creado",c.documento),x("actualizar-cotizacion",c.cotizacion),w(),alert(`‚úÖ Documento generado exitosamente: ${c.documento.number}`))}catch(v){console.error("Error generando documento:",v);const c=((s=(k=v.response)==null?void 0:k.data)==null?void 0:s.message)||"Error al generar documento";alert(`‚ùå ${c}`)}finally{z.value=!1}},f=k=>{y.value.push({...k,nombre_completo:k.company||`${k.firstName||""} ${k.lastName||""}`.trim()||"Sin nombre"}),r.value.cliente_bsale_id=k.id},w=()=>{n.value=!1,r.value={tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}},g=k=>{const s=$.value.find(v=>v.id===k);return(s==null?void 0:s.nombre)||"Documento"},U=k=>{const s=T.value.find(v=>v.id===k);return(s==null?void 0:s.nombre)||"No especificado"},j=k=>{const s=C.value.find(v=>v.valor===k);return(s==null?void 0:s.nombre)||"No especificado"},R=()=>y.value.find(k=>k.id===r.value.cliente_bsale_id),H=()=>{var s;const k=((s=b.cotizacion)==null?void 0:s.total)||0;return Math.round(k/1.19)},K=()=>Math.round(H()*.19),Y=()=>H()+K();return se(()=>b.mostrar,k=>{k&&Z("")}),(k,s)=>(h(),Q(ie,{modelValue:n.value,"onUpdate:modelValue":s[8]||(s[8]=v=>n.value=v),"max-width":"800px",persistent:""},{default:o(()=>[e(P,null,{default:o(()=>[e(M,{class:"text-h5 d-flex align-center"},{default:o(()=>[e(B,{color:"primary",class:"me-2"},{default:o(()=>s[9]||(s[9]=[d("mdi-file-document-plus")])),_:1}),s[10]||(s[10]=d(" Generar Documento Electr√≥nico "))]),_:1}),e(W),e(I,null,{default:o(()=>[e(Se,{color:"info",variant:"outlined",class:"mb-4"},{default:o(()=>{var v,c,l,E,m,D,A;return[a("div",We,[a("div",null,[a("strong",null,"Cotizaci√≥n #"+u((v=i.cotizacion)==null?void 0:v.numero),1),s[11]||(s[11]=a("br",null,null,-1)),a("span",Ye,"Cliente: "+u((l=(c=i.cotizacion)==null?void 0:c.cliente)==null?void 0:l.nombre),1)]),a("div",eo,[a("div",oo,"$"+u((m=(E=i.cotizacion)==null?void 0:E.total)==null?void 0:m.toLocaleString()),1),a("span",to,u((A=(D=i.cotizacion)==null?void 0:D.ventanas)==null?void 0:A.length)+" ventanas",1)])])]}),_:1}),e(ue,{ref:"formRef",onSubmit:ze(S,["prevent"])},{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:r.value.tipo_documento,"onUpdate:modelValue":s[0]||(s[0]=v=>r.value.tipo_documento=v),items:$.value,"item-title":"nombre","item-value":"id",label:"Tipo de documento *",rules:[v=>!!v||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-file-document"},{item:o(({props:v,item:c})=>[e(te,me(fe(v)),{default:o(()=>[e(ae,null,{default:o(()=>[d(u(c.raw.nombre),1)]),_:2},1024),e(ve,null,{default:o(()=>[d(u(c.raw.descripcion),1)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:r.value.metodo_pago,"onUpdate:modelValue":s[1]||(s[1]=v=>r.value.metodo_pago=v),items:T.value,"item-title":"nombre","item-value":"id",label:"M√©todo de pago *",rules:[v=>!!v||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items","rules"])]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(ee,{modelValue:r.value.condiciones_pago,"onUpdate:modelValue":s[2]||(s[2]=v=>r.value.condiciones_pago=v),items:C.value,"item-title":"nombre","item-value":"valor",label:"Condiciones de pago *",rules:[v=>!!v||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-calendar-clock"},null,8,["modelValue","items","rules"])]),_:1}),r.value.condiciones_pago!=="contado"?(h(),Q(V,{key:0,cols:"12",md:"6"},{default:o(()=>[e(F,{modelValue:r.value.fecha_vencimiento,"onUpdate:modelValue":s[3]||(s[3]=v=>r.value.fecha_vencimiento=v),type:"date",label:"Fecha de vencimiento",variant:"outlined","prepend-inner-icon":"mdi-calendar",min:X.value},null,8,["modelValue","min"])]),_:1})):oe("",!0),e(V,{cols:"12"},{default:o(()=>[e(ke,{modelValue:r.value.cliente_bsale_id,"onUpdate:modelValue":s[5]||(s[5]=v=>r.value.cliente_bsale_id=v),items:y.value,search:_.value,"item-title":"nombre_completo","item-value":"id",label:"Cliente en BSALE *",rules:[v=>!!v||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account","onUpdate:search":Z,"no-data-text":"No se encontraron clientes"},{item:o(({props:v,item:c})=>[e(te,me(fe(v)),{default:o(()=>[e(ae,null,{default:o(()=>[d(u(c.raw.nombre_completo),1)]),_:2},1024),e(ve,null,{default:o(()=>[d(u(c.raw.empresa)+" ‚Ä¢ "+u(c.raw.rut),1)]),_:2},1024)]),_:2},1040)]),append:o(()=>[e(q,{icon:"mdi-plus",variant:"text",size:"small",onClick:s[4]||(s[4]=v=>p.value=!0)})]),_:1},8,["modelValue","items","search","rules"])]),_:1}),e(V,{cols:"12"},{default:o(()=>[e(De,{modelValue:r.value.observaciones,"onUpdate:modelValue":s[6]||(s[6]=v=>r.value.observaciones=v),label:"Observaciones (opcional)",variant:"outlined",rows:"3","prepend-inner-icon":"mdi-note-text",counter:"500",maxlength:"500"},null,8,["modelValue"])]),_:1})]),_:1}),r.value.tipo_documento&&r.value.cliente_bsale_id?(h(),Q(P,{key:0,variant:"outlined",class:"mt-4"},{default:o(()=>[e(M,{class:"text-subtitle-1"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>s[12]||(s[12]=[d("mdi-eye")])),_:1}),s[13]||(s[13]=d(" Preview del documento "))]),_:1}),e(I,null,{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>{var v,c;return[a("div",ao,[a("strong",null,u(g(r.value.tipo_documento)),1),s[14]||(s[14]=a("br",null,null,-1)),s[15]||(s[15]=a("strong",null,"Cliente:",-1)),d(" "+u((v=R())==null?void 0:v.nombre_completo),1),s[16]||(s[16]=a("br",null,null,-1)),s[17]||(s[17]=a("strong",null,"RUT:",-1)),d(" "+u((c=R())==null?void 0:c.rut),1),s[18]||(s[18]=a("br",null,null,-1)),s[19]||(s[19]=a("strong",null,"M√©todo de pago:",-1)),d(" "+u(U(r.value.metodo_pago)),1),s[20]||(s[20]=a("br",null,null,-1)),s[21]||(s[21]=a("strong",null,"Condiciones:",-1)),d(" "+u(j(r.value.condiciones_pago)),1)])]}),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>{var v,c;return[a("div",lo,[s[22]||(s[22]=a("strong",null,"Items:",-1)),d(" "+u(((c=(v=i.cotizacion)==null?void 0:v.ventanas)==null?void 0:c.length)||0)+" ventanas",1),s[23]||(s[23]=a("br",null,null,-1)),s[24]||(s[24]=a("strong",null,"Subtotal:",-1)),d(" $"+u(H().toLocaleString()),1),s[25]||(s[25]=a("br",null,null,-1)),s[26]||(s[26]=a("strong",null,"IVA (19%):",-1)),d(" $"+u(K().toLocaleString()),1),s[27]||(s[27]=a("br",null,null,-1)),a("div",io,[a("strong",null,"Total: $"+u(Y().toLocaleString()),1)])])]}),_:1})]),_:1})]),_:1})]),_:1})):oe("",!0)]),_:1},512)]),_:1}),e(de,null,{default:o(()=>[e(ce),e(q,{color:"secondary",variant:"text",onClick:w,disabled:z.value},{default:o(()=>s[28]||(s[28]=[d(" Cancelar ")])),_:1},8,["disabled"]),e(q,{color:"primary",onClick:S,loading:z.value},{default:o(()=>[e(B,{start:""},{default:o(()=>s[29]||(s[29]=[d("mdi-file-document-plus")])),_:1}),s[30]||(s[30]=d(" Generar Documento "))]),_:1},8,["loading"])]),_:1})]),_:1}),e(Ke,{mostrar:p.value,"onUpdate:mostrar":s[7]||(s[7]=v=>p.value=v),onClienteCreado:f},null,8,["mostrar"])]),_:1},8,["modelValue"]))}},ro={class:"text-body-1 mb-2"},so={class:"text-body-2 text-medium-emphasis mb-1"},uo={class:"text-body-2 text-medium-emphasis mb-1"},co={class:"text-body-2 text-medium-emphasis"},mo={class:"text-body-2 mb-1"},fo={class:"text-body-2 mb-1"},po={class:"text-body-2 mb-1"},vo={class:"text-body-2 mb-1"},bo={class:"text-body-2"},go={class:"text-success text-h6 ms-1"},_o={class:"font-weight-medium"},Vo={key:0,class:"text-caption text-medium-emphasis"},Co={class:"text-body-2"},xo={class:"text-caption text-medium-emphasis"},yo={class:"text-body-2"},zo={class:"text-caption text-medium-emphasis"},wo={class:"font-weight-medium"},So={class:"font-weight-bold text-success"},ko={class:"text-body-2"},Do={class:"text-body-2 d-flex justify-space-between mb-2"},ho={key:0,class:"text-body-2 d-flex justify-space-between mb-2"},Uo={class:"text-error"},$o={class:"text-h5 font-weight-bold text-success d-flex justify-space-between"},Eo={class:"text-caption text-medium-emphasis mt-2"},Lo={__name:"DetalleCotizacion",props:{cotizacion:Object},emits:["cerrar"],setup(i,{emit:t}){const b=i,x=L(!1),n=L(""),z=[{title:"Tipo",key:"tipo_ventana",sortable:!1},{title:"Dimensiones",key:"dimensiones",sortable:!1},{title:"Material/Color",key:"material_color",sortable:!1},{title:"Cantidad",key:"cantidad",sortable:!0},{title:"Precio Unit.",key:"precio_unitario",sortable:!0},{title:"Total",key:"total",sortable:!1},{title:"Imagen",key:"imagen",sortable:!1}],p=()=>{var w,g,U;const S=(U=(g=(w=b.cotizacion)==null?void 0:w.estado)==null?void 0:g.nombre)==null?void 0:U.toLowerCase();return{evaluaci√≥n:"warning",aprobada:"success",rechazada:"error",facturada:"info",pagada:"primary"}[S]||"grey"},_=S=>S?new Date(S).toLocaleDateString("es-CL"):"-",r=S=>{const f=[];return S.hojas_totales&&f.push(`${S.hojas_totales} hojas`),S.hojas_moviles&&f.push(`${S.hojas_moviles} m√≥viles`),f.join(", ")},$=(S,f)=>!S||!f?"0.00":(S*f/1e6).toFixed(2),T=S=>{const f=S.precio_unitario||S.precio||0,w=S.cantidad||1;return f*w},C=()=>{var S,f;return((f=(S=b.cotizacion)==null?void 0:S.ventanas)==null?void 0:f.reduce((w,g)=>w+T(g),0))||0},y=()=>{var S;return((S=b.cotizacion)==null?void 0:S.descuento_total)||0},X=S=>{n.value=Z(S),x.value=!0},Z=S=>S?`/storage/imagenes_ventanas/${S}`:"";return(S,f)=>(h(),Q(P,{class:"ma-0"},{default:o(()=>[e(M,{class:"d-flex align-center justify-space-between"},{default:o(()=>{var w;return[a("div",null,[a("h2",null,"Detalle de Cotizaci√≥n #"+u((w=i.cotizacion)==null?void 0:w.id),1),e(le,{color:p(),size:"small",class:"mt-2"},{default:o(()=>{var g,U;return[d(u((U=(g=i.cotizacion)==null?void 0:g.estado)==null?void 0:U.nombre),1)]}),_:1},8,["color"])]),e(q,{icon:"mdi-close",variant:"text",onClick:f[0]||(f[0]=g=>S.$emit("cerrar"))})]}),_:1}),e(W),e(I,{class:"pa-6"},{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"6"},{default:o(()=>[e(P,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>f[3]||(f[3]=[d("mdi-account")])),_:1}),f[4]||(f[4]=d(" Informaci√≥n del Cliente "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U,j,R,H,K,Y;return[a("div",ro,[a("strong",null,u((g=(w=i.cotizacion)==null?void 0:w.cliente)==null?void 0:g.nombre),1)]),a("div",so," üìß "+u(((j=(U=i.cotizacion)==null?void 0:U.cliente)==null?void 0:j.email)||"Sin email"),1),a("div",uo," üì± "+u(((H=(R=i.cotizacion)==null?void 0:R.cliente)==null?void 0:H.telefono)||"Sin tel√©fono"),1),a("div",co," üè† "+u(((Y=(K=i.cotizacion)==null?void 0:K.cliente)==null?void 0:Y.direccion)||"Sin direcci√≥n"),1)]}),_:1})]),_:1})]),_:1}),e(V,{cols:"12",md:"6"},{default:o(()=>[e(P,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>f[5]||(f[5]=[d("mdi-file-document")])),_:1}),f[6]||(f[6]=d(" Datos de la Cotizaci√≥n "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U,j,R,H;return[a("div",mo,[f[7]||(f[7]=a("strong",null,"N√∫mero:",-1)),d(" #"+u((w=i.cotizacion)==null?void 0:w.id),1)]),a("div",fo,[f[8]||(f[8]=a("strong",null,"Fecha:",-1)),d(" "+u(_((g=i.cotizacion)==null?void 0:g.fecha)),1)]),a("div",po,[f[9]||(f[9]=a("strong",null,"Vendedor:",-1)),d(" "+u(((j=(U=i.cotizacion)==null?void 0:U.vendedor)==null?void 0:j.nombre)||"No asignado"),1)]),a("div",vo,[f[10]||(f[10]=a("strong",null,"Estado:",-1)),e(le,{color:p(),size:"x-small",class:"ms-1"},{default:o(()=>{var K,Y;return[d(u((Y=(K=i.cotizacion)==null?void 0:K.estado)==null?void 0:Y.nombre),1)]}),_:1},8,["color"])]),a("div",bo,[f[11]||(f[11]=a("strong",null,"Total:",-1)),a("span",go," $"+u((H=(R=i.cotizacion)==null?void 0:R.total)==null?void 0:H.toLocaleString()),1)])]}),_:1})]),_:1})]),_:1})]),_:1}),e(J,{class:"mt-4"},{default:o(()=>[e(V,{cols:"12"},{default:o(()=>[e(P,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>{var w,g;return[e(B,{class:"me-2"},{default:o(()=>f[12]||(f[12]=[d("mdi-window-closed-variant")])),_:1}),d(" Ventanas Cotizadas ("+u(((g=(w=i.cotizacion)==null?void 0:w.ventanas)==null?void 0:g.length)||0)+") ",1)]}),_:1}),e(I,null,{default:o(()=>{var w;return[e(he,{headers:z,items:((w=i.cotizacion)==null?void 0:w.ventanas)||[],"item-value":"id",class:"elevation-0",density:"comfortable"},{"item.tipo_ventana":o(({item:g})=>{var U,j;return[a("div",null,[a("div",_o,u(((U=g.tipoVentana)==null?void 0:U.nombre)||((j=g.tipo_ventana)==null?void 0:j.nombre)),1),r(g)?(h(),O("div",Vo,u(r(g)),1)):oe("",!0)])]}),"item.dimensiones":o(({item:g})=>[a("div",Co,[a("div",null,u(g.ancho)+"mm √ó "+u(g.alto)+"mm",1),a("div",xo,u($(g.ancho,g.alto))+" m¬≤ ",1)])]),"item.material_color":o(({item:g})=>{var U,j,R;return[a("div",yo,[a("div",null,u(((U=g.color)==null?void 0:U.nombre)||"Sin color"),1),a("div",zo,u(((R=(j=g.productoVidrioProveedor)==null?void 0:j.producto)==null?void 0:R.nombre)||"Sin vidrio"),1)])]}),"item.cantidad":o(({item:g})=>[e(le,{size:"small",color:"primary",variant:"outlined"},{default:o(()=>[d(u(g.cantidad),1)]),_:2},1024)]),"item.precio_unitario":o(({item:g})=>[a("div",wo," $"+u((g.precio_unitario||g.precio||0).toLocaleString()),1)]),"item.total":o(({item:g})=>[a("div",So," $"+u(T(g).toLocaleString()),1)]),"item.imagen":o(({item:g})=>[g.imagen?(h(),Q(Pe,{key:0,size:"40",class:"cursor-pointer",onClick:U=>X(g.imagen)},{default:o(()=>[e(xe,{src:Z(g.imagen),cover:""},null,8,["src"])]),_:2},1032,["onClick"])):(h(),Q(B,{key:1,color:"grey-lighten-1"},{default:o(()=>f[13]||(f[13]=[d("mdi-image-off")])),_:1}))]),_:1},8,["items"])]}),_:1})]),_:1})]),_:1})]),_:1}),e(J,{class:"mt-4"},{default:o(()=>[e(V,{cols:"12",md:"8"},{default:o(()=>{var w;return[(w=i.cotizacion)!=null&&w.observaciones?(h(),Q(P,{key:0,variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>f[14]||(f[14]=[d("mdi-note-text")])),_:1}),f[15]||(f[15]=d(" Observaciones "))]),_:1}),e(I,null,{default:o(()=>[a("p",ko,u(i.cotizacion.observaciones),1)]),_:1})]),_:1})):oe("",!0)]}),_:1}),e(V,{cols:"12",md:"4"},{default:o(()=>[e(P,{variant:"outlined",color:"success",class:"text-center"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(B,{class:"me-2"},{default:o(()=>f[16]||(f[16]=[d("mdi-calculator")])),_:1}),f[17]||(f[17]=d(" Resumen Total "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U;return[a("div",Do,[f[18]||(f[18]=a("span",null,"Subtotal:",-1)),a("span",null,"$"+u(C().toLocaleString()),1)]),y()>0?(h(),O("div",ho,[f[19]||(f[19]=a("span",null,"Descuento:",-1)),a("span",Uo,"-$"+u(y().toLocaleString()),1)])):oe("",!0),e(W,{class:"my-3"}),a("div",$o,[f[20]||(f[20]=a("span",null,"Total:",-1)),a("span",null,"$"+u((((w=i.cotizacion)==null?void 0:w.total)||0).toLocaleString()),1)]),a("div",Eo,u(((U=(g=i.cotizacion)==null?void 0:g.ventanas)==null?void 0:U.length)||0)+" ventanas ",1)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ie,{modelValue:x.value,"onUpdate:modelValue":f[2]||(f[2]=w=>x.value=w),"max-width":"800px"},{default:o(()=>[e(P,null,{default:o(()=>[e(M,{class:"d-flex justify-space-between align-center"},{default:o(()=>[f[21]||(f[21]=d(" Imagen de Ventana ")),e(q,{icon:"mdi-close",variant:"text",onClick:f[1]||(f[1]=w=>x.value=!1)})]),_:1}),e(I,{class:"text-center"},{default:o(()=>[e(xe,{src:n.value,"max-height":"500",contain:""},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},To={class:"d-flex align-center"},No={key:0},Bo={class:"font-weight-medium"},Fo={class:"text-caption text-medium-emphasis"},Po={key:1,class:"text-caption text-medium-emphasis"},jo={key:0},qo={key:0,class:"d-flex align-center"},Ao={class:"font-weight-medium text-warning"},Mo={class:"text-caption"},Io={key:1,class:"text-caption text-medium-emphasis"},Ro={key:1,class:"text-caption text-medium-emphasis"},Oo={class:"font-weight-bold text-success"},Go={class:"text-caption"},Qo={class:"d-flex gap-2"},Xo=["colspan"],Zo={class:"pa-4"},Ho={class:"mb-3"},Jo={class:"font-weight-bold"},Ko={class:"d-flex justify-space-between mb-2"},Wo={class:"d-flex justify-space-between mb-2"},Yo={class:"text-error"},et={class:"d-flex justify-space-between font-weight-bold"},ot={class:"text-success"},tt={class:"d-flex justify-space-between align-center pa-4"},at={class:"text-caption"},Nt={__name:"index",setup(i){const t=L(!1),b=L([]),x=L(!1),n=L(!1),z=L(!1),p=L(null),_=L(10),r=L({busqueda:"",estado:null,cliente:null}),$=[{title:"N√∫mero",key:"numero",sortable:!0},{title:"Cliente",key:"cliente",sortable:!1},{title:"Facturado a",key:"cliente_facturacion",sortable:!1},{title:"Total",key:"total",sortable:!0},{title:"Estado",key:"estado_facturacion",sortable:!0},{title:"Fecha aprobaci√≥n",key:"fecha_aprobacion",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,width:"200px"}],T=[{title:"Aprobada (Por facturar)",value:"aprobada"},{title:"Facturada",value:"facturada"},{title:"Pagada",value:"pagada"},{title:"Anulada",value:"anulada"}],C=pe(()=>b.value.map(l=>l.cliente).filter((l,E,m)=>l&&m.findIndex(D=>D.id===l.id)===E)),y=pe(()=>{let c=[...b.value];if(r.value.busqueda){const l=r.value.busqueda.toLowerCase();c=c.filter(E=>{var m,D,A,N,ne,re,be,ge,_e,Ve,Ce;return((m=E.numero)==null?void 0:m.toString().includes(l))||((A=(D=E.cliente)==null?void 0:D.razon_social)==null?void 0:A.toLowerCase().includes(l))||((ne=(N=E.cliente)==null?void 0:N.first_name)==null?void 0:ne.toLowerCase().includes(l))||((be=(re=E.cliente)==null?void 0:re.last_name)==null?void 0:be.toLowerCase().includes(l))||((_e=(ge=E.cliente)==null?void 0:ge.identification)==null?void 0:_e.toLowerCase().includes(l))||((Ce=(Ve=E.cliente)==null?void 0:Ve.email)==null?void 0:Ce.toLowerCase().includes(l))})}return r.value.estado&&(c=c.filter(l=>l.estado_facturacion===r.value.estado)),r.value.cliente&&(c=c.filter(l=>{var E;return((E=l.cliente)==null?void 0:E.id)===r.value.cliente})),c}),X=async()=>{var c,l,E,m,D,A;try{t.value=!0,console.log("üîç Intentando cargar cotizaciones desde:","/api/cotizaciones/aprobadas");const{data:N}=await G.get("/api/cotizaciones/aprobadas");console.log("‚úÖ Respuesta recibida:",N),b.value=N.cotizaciones||[],console.log("üìä Cotizaciones cargadas:",b.value.length)}catch(N){console.error("‚ùå Error cargando cotizaciones:",N),console.error("üìç URL intentada:",(c=N.config)==null?void 0:c.url),console.error("üî¢ Status:",(l=N.response)==null?void 0:l.status),console.error("üìù Mensaje:",(E=N.response)==null?void 0:E.data),alert(`Error: ${(m=N.response)==null?void 0:m.status} - ${((A=(D=N.response)==null?void 0:D.data)==null?void 0:A.message)||"Error desconocido"}`)}finally{t.value=!1}},Z=c=>{p.value=c,z.value=!0},S=c=>{console.log("Documento creado:",c),X()},f=c=>{const l=b.value.findIndex(E=>E.id===c.id);l!==-1&&(b.value[l]=c)},w=c=>{console.log("Duplicar cotizaci√≥n:",c.id)},g=async c=>{if(confirm(`¬øEst√°s seguro de eliminar la cotizaci√≥n #${c.numero}?`))try{await G.delete(`/api/cotizaciones/${c.id}`),b.value=b.value.filter(l=>l.id!==c.id)}catch(l){console.error("Error eliminando cotizaci√≥n:",l)}},U=()=>{r.value={busqueda:"",estado:null,cliente:null}},j=c=>({aprobada:"warning",facturada:"success",pagada:"primary",anulada:"error"})[c]||"grey",R=c=>({aprobada:"Por facturar",facturada:"Facturada",pagada:"Pagada",anulada:"Anulada"})[c]||c,H=c=>c?new Date(c).toLocaleDateString("es-CL"):"-",K=c=>{var l;return((l=c.ventanas)==null?void 0:l.reduce((E,m)=>E+m.precio_unitario*m.cantidad,0))||0},Y=c=>{p.value=c,x.value=!0},k=async c=>{try{await X(),console.log("Documento generado exitosamente:",c)}catch(l){console.error("Error recargando datos:",l)}},s=async c=>{if(c.url_pdf_bsale){window.open(c.url_pdf_bsale,"_blank");return}if(c.id_documento_bsale)try{const l=await G.get(`/api/bsale/documento/${c.id_documento_bsale}/pdf`);l.data.success&&l.data.pdf_url?window.open(l.data.pdf_url,"_blank"):console.error("No se pudo obtener el PDF del documento")}catch(l){console.error("Error obteniendo PDF:",l)}},v=c=>c.descuento_total||0;return $e(()=>{X()}),(c,l)=>{const E=ye("v-simple-table");return h(),O("div",null,[e(P,{class:"mb-6"},{default:o(()=>[e(M,{class:"d-flex align-center justify-space-between"},{default:o(()=>[l[8]||(l[8]=a("div",null,[a("h1",{class:"text-h4 mb-2"},"üìÑ Facturaci√≥n"),a("p",{class:"text-subtitle-1 text-medium-emphasis"}," Gestiona las cotizaciones aprobadas y genera documentos electr√≥nicos ")],-1)),e(le,{color:"primary",variant:"elevated",size:"large"},{default:o(()=>[d(u(b.value.length)+" por facturar ",1)]),_:1})]),_:1})]),_:1}),e(P,{class:"mb-4"},{default:o(()=>[e(I,null,{default:o(()=>[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"4"},{default:o(()=>[e(F,{modelValue:r.value.busqueda,"onUpdate:modelValue":l[0]||(l[0]=m=>r.value.busqueda=m),label:"Buscar cotizaci√≥n...","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"3"},{default:o(()=>[e(ee,{modelValue:r.value.estado,"onUpdate:modelValue":l[1]||(l[1]=m=>r.value.estado=m),items:T,label:"Estado",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(V,{cols:"12",md:"3"},{default:o(()=>[e(ee,{modelValue:r.value.cliente,"onUpdate:modelValue":l[2]||(l[2]=m=>r.value.cliente=m),items:C.value,"item-title":"nombre","item-value":"id",label:"Cliente",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue","items"])]),_:1}),e(V,{cols:"12",md:"2"},{default:o(()=>[e(q,{color:"primary",variant:"outlined",block:"",onClick:U},{default:o(()=>l[9]||(l[9]=[d(" Limpiar filtros ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(P,null,{default:o(()=>[e(he,{"items-per-page":_.value,"onUpdate:itemsPerPage":l[3]||(l[3]=m=>_.value=m),headers:$,items:y.value,loading:t.value,class:"elevation-1","item-value":"id","show-expand":"","expand-on-click":""},{"item.numero":o(({item:m})=>[a("div",To,[e(le,{color:"primary",variant:"outlined",size:"small",class:"me-2"},{default:o(()=>[d(" #"+u(m.id),1)]),_:2},1024)])]),"item.cliente":o(({item:m})=>[m.cliente?(h(),O("div",No,[a("div",Bo,u(m.cliente.razon_social||`${m.cliente.first_name||""} ${m.cliente.last_name||""}`.trim()||"Sin nombre"),1),a("div",Fo,u(m.cliente.email||m.cliente.identification),1)])):(h(),O("div",Po," Sin cliente "))]),"item.cliente_facturacion":o(({item:m})=>[m.cliente_facturacion_id&&m.cliente_facturacion?(h(),O("div",jo,[m.cliente_facturacion_id!==m.cliente_id?(h(),O("div",qo,[e(B,{size:"small",color:"warning",class:"me-1"},{default:o(()=>l[10]||(l[10]=[d("mdi-alert-circle")])),_:1}),a("div",null,[a("div",Ao,u(m.cliente_facturacion.razon_social||`${m.cliente_facturacion.first_name||""} ${m.cliente_facturacion.last_name||""}`.trim()||"Sin nombre"),1),a("div",Mo,u(m.cliente_facturacion.identification),1)])])):(h(),O("div",Io,[e(B,{size:"small",color:"success",class:"me-1"},{default:o(()=>l[11]||(l[11]=[d("mdi-check")])),_:1}),l[12]||(l[12]=d(" Mismo cliente "))]))])):(h(),O("div",Ro,[e(B,{size:"small",color:"info",class:"me-1"},{default:o(()=>l[13]||(l[13]=[d("mdi-account")])),_:1}),l[14]||(l[14]=d(" Mismo cliente "))]))]),"item.total":o(({item:m})=>{var D;return[a("div",Oo," $"+u((D=m.total)==null?void 0:D.toLocaleString()),1)]}),"item.estado_facturacion":o(({item:m})=>[e(le,{color:j(m.estado_facturacion),variant:m.estado_facturacion==="aprobada"?"elevated":"outlined",size:"small"},{default:o(()=>[d(u(R(m.estado_facturacion)),1)]),_:2},1032,["color","variant"])]),"item.fecha_aprobacion":o(({item:m})=>[a("div",Go,u(H(m.fecha_aprobacion)),1)]),"item.acciones":o(({item:m})=>[a("div",Qo,[m.estado_facturacion==="aprobada"?(h(),Q(q,{key:0,color:"success",variant:"elevated",size:"small",onClick:D=>Y(m)},{default:o(()=>[e(B,{start:""},{default:o(()=>l[15]||(l[15]=[d("mdi-receipt")])),_:1}),l[16]||(l[16]=d(" Generar Documento "))]),_:2},1032,["onClick"])):m.estado_facturacion==="facturada"?(h(),Q(q,{key:1,color:"info",variant:"outlined",size:"small",onClick:D=>s(m)},{default:o(()=>[e(B,{start:""},{default:o(()=>l[17]||(l[17]=[d("mdi-file-pdf-box")])),_:1}),l[18]||(l[18]=d(" Descargar Documento "))]),_:2},1032,["onClick"])):oe("",!0),e(je,null,{activator:o(({props:D})=>[e(q,Te(D,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:o(()=>[e(Be,null,{default:o(()=>[e(te,{onClick:D=>Z(m)},{default:o(()=>[e(ae,null,{default:o(()=>l[19]||(l[19]=[d("Ver detalle")])),_:1})]),_:2},1032,["onClick"]),e(te,{onClick:D=>w(m)},{default:o(()=>[e(ae,null,{default:o(()=>l[20]||(l[20]=[d("Duplicar")])),_:1})]),_:2},1032,["onClick"]),e(W),e(te,{onClick:D=>g(m),class:"text-error"},{default:o(()=>[e(ae,null,{default:o(()=>l[21]||(l[21]=[d("Eliminar")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)])]),"expanded-row":o(({columns:m,item:D})=>[a("tr",null,[a("td",{colspan:m.length},[a("div",Zo,[e(J,null,{default:o(()=>[e(V,{cols:"12",md:"8"},{default:o(()=>{var A;return[a("h4",Ho,"Ventanas cotizadas ("+u(((A=D.ventanas)==null?void 0:A.length)||0)+")",1),e(E,{dense:""},{default:o(()=>[l[22]||(l[22]=a("thead",null,[a("tr",null,[a("th",null,"Tipo"),a("th",null,"Dimensiones"),a("th",null,"Cantidad"),a("th",null,"Precio unitario"),a("th",null,"Total")])],-1)),a("tbody",null,[(h(!0),O(Ee,null,Le(D.ventanas,N=>{var ne,re;return h(),O("tr",{key:N.id},[a("td",null,u((ne=N.tipo_ventana)==null?void 0:ne.nombre),1),a("td",null,u(N.ancho)+"mm √ó "+u(N.alto)+"mm",1),a("td",null,u(N.cantidad),1),a("td",null,"$"+u((re=N.precio_unitario)==null?void 0:re.toLocaleString()),1),a("td",Jo," $"+u((N.precio_unitario*N.cantidad).toLocaleString()),1)])}),128))])]),_:2},1024)]}),_:2},1024),e(V,{cols:"12",md:"4"},{default:o(()=>[e(P,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-subtitle-1"},{default:o(()=>l[23]||(l[23]=[d("Resumen")])),_:1}),e(I,null,{default:o(()=>{var A;return[a("div",Ko,[l[24]||(l[24]=a("span",null,"Subtotal:",-1)),a("span",null,"$"+u(K(D).toLocaleString()),1)]),a("div",Wo,[l[25]||(l[25]=a("span",null,"Descuento:",-1)),a("span",Yo,"-$"+u(v(D).toLocaleString()),1)]),e(W,{class:"my-2"}),a("div",et,[l[26]||(l[26]=a("span",null,"Total:",-1)),a("span",ot,"$"+u((A=D.total)==null?void 0:A.toLocaleString()),1)])]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)])],8,Xo)])]),bottom:o(()=>[a("div",tt,[a("div",at," Mostrando "+u(y.value.length)+" de "+u(b.value.length)+" cotizaciones ",1)])]),_:1},8,["items-per-page","items","loading"])]),_:1}),e(Je,{modelValue:x.value,"onUpdate:modelValue":l[4]||(l[4]=m=>x.value=m),cotizacion:p.value,onDocumentoGenerado:k},null,8,["modelValue","cotizacion"]),e(no,{mostrar:n.value,"onUpdate:mostrar":l[5]||(l[5]=m=>n.value=m),cotizacion:p.value,onDocumentoCreado:S,onActualizarCotizacion:f},null,8,["mostrar","cotizacion"]),e(ie,{modelValue:z.value,"onUpdate:modelValue":l[7]||(l[7]=m=>z.value=m),"max-width":"1200px"},{default:o(()=>[z.value?(h(),Q(Lo,{key:0,cotizacion:p.value,onCerrar:l[6]||(l[6]=m=>z.value=!1)},null,8,["cotizacion"])):oe("",!0)]),_:1},8,["modelValue"])])}}};export{Nt as default};
