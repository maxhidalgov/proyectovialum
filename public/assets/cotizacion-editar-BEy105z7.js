import{r as u,j as po,au as m,X as I,E as _o,f as g,e as r,k as mo,o as p,c as b,F as J,b as l,t as n,v,a3 as C,Z as h,a2 as vo,m as D,i as fo,d as H,av as Vo}from"./index-DRX9M9WN.js";import go from"./VentanaForm-ByHhR9RC.js";import bo from"./AgregarVentanaModal-KQuYjvaQ.js";import zo from"./ModalProductos-Dhj7UlB7.js";import{d as yo}from"./debounce-Bk3s83Pf.js";import{V as Co}from"./VContainer-C70ht2vR.js";import{V as E,b as M}from"./VCard-BoNNJYpO.js";import{V as F}from"./VSpacer-CFWtZVBW.js";import{V as jo}from"./VCardText-DVBw6ri8.js";import{V as ko}from"./VForm-1MoOwht-.js";import{V as q,a as z}from"./VRow-DCUoJdo7.js";import{V as Po}from"./VAutocomplete-D7tcNp4E.js";import{V as ho}from"./VTextField-CTI75BqX.js";import{V as $o}from"./VSelect-CFChBydQ.js";import{V as xo}from"./VTextarea-Cdqc8C2G.js";import{V as $}from"./VAlert-CRsQhpRA.js";import{V as G}from"./VDataTable-BILqiKJ7.js";import{V as X}from"./VChip-DcK6QxRS.js";import"./VDialog-C1-bouey.js";import"./VOverlay-7L_Z2Pr0.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-DJoV2taJ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VDivider-DHT4taBX.js";/* empty css              */import"./VAvatar-DagRnBOJ.js";import"./VImg-nNk6BlCn.js";import"./VInput-CFHeTYPz.js";import"./VList-Di009mj3.js";import"./VMenu-Bi4kyHIV.js";import"./VCheckboxBtn-CZni9Hks.js";import"./VSelectionControl-KPuG38O6.js";const No={key:0},So={key:1},Do={key:0},ce={__name:"cotizacion-editar",setup(Eo){const j=u(!1),k=u(!1),Z=po(),K=mo(),Q=Z.query.id;u([]);const T=u([]),w=u(null),P=u([]),L=u([]);u(!1),u(W());function W(){return{tipo_ventana_id:null,ancho:null,alto:null,cantidad:1,color_id:null,tipo_vidrio_id:null,producto_vidrio_proveedor_id:null,hojas_totales:2,hojas_moviles:2,costo:0,precio:0,materiales:[]}}const Y=i=>y.value.flatMap(o=>o.colores_por_proveedor.map(a=>({id:a.id,producto_id:o.id,proveedor_id:a.proveedor_id}))).find(o=>o.id===i),R=yo(async(i,o)=>{if(!i.productoVidrio||!i.proveedorVidrio||!i.tipo||!i.ancho||!i.alto){console.warn("⚠️ Payload incompleto para cálculo:",i);return}try{console.log("➡️ Enviando a /api/cotizador/calcular-materiales:",i);const a=await m.post("/api/cotizador/calcular-materiales",i);console.log("✅ Respuesta del backend:",a.data);const e=o.cantidad||1;o.costo_total_unitario=a.data.costo_unitario,o.costo_total=a.data.costo_unitario*e,o.precio_unitario=Math.ceil(a.data.costo_unitario/(1-.45)),o.precio=o.precio_unitario*e,o.materiales=a.data.materiales??[],t.value.ventanas=[...t.value.ventanas],console.log("🧮 Costo asignado:",o.costo),console.log("🧮 Precio asignado:",o.precio);const s=t.value.ventanas.findIndex(c=>c===o);s!==-1&&(t.value.ventanas[s]={...o})}catch(a){console.error("❌ Error al calcular materiales:",a),o.costo=0,o.precio=0,o.materiales=[];const e=t.value.ventanas.findIndex(s=>s===o);e!==-1&&(t.value.ventanas[e]={...o})}},800),t=u({fecha:"",estado_cotizacion_id:null,observaciones:"",ventanas:[]});u(null);const oo=i=>{const o=Y(i.producto_vidrio_proveedor_id),a={...i,costo:0,precio:0,materiales:[]};t.value.ventanas.push(a),console.log("🧾 Lista actual de ventanas:",t.value.ventanas);const e={...a,tipo:a.tipo_ventana_id,tipoVidrio:a.tipo_vidrio_id,productoVidrio:o==null?void 0:o.producto_id,proveedorVidrio:o==null?void 0:o.proveedor_id,hojas_moviles:a.tipo_ventana_id===3||a.tipo_ventana_id===46?a.hojas_moviles:void 0};console.log("✅ Ejecutando recalcularCosto para ventana agregada..."),R(e,a),t.value.ventanas=[...t.value.ventanas],j.value=!1},eo=i=>{console.log("📦 Producto recibido del modal:",i);const o={tipo_item:"producto",producto_lista_id:i.producto_lista_id,lista_precio_id:i.lista_precio_id,descripcion:i.descripcion,cantidad:i.cantidad,precio_unitario:i.precio_venta,total:i.precio_venta*i.cantidad,_producto:i};t.value.detalles||(t.value.detalles=[]),t.value.detalles.push(o),console.log("✅ Producto agregado a detalles:",o),console.log("📋 Detalles actuales:",t.value.detalles),k.value=!1},ao=i=>{if(!confirm(`¿Eliminar el producto "${i.descripcion}"?`))return;const o=t.value.detalles.findIndex(a=>a===i);o!==-1&&(t.value.detalles.splice(o,1),console.log("🗑️ Producto eliminado"))},to=u(null),io=[{title:"Tipo de ventana",value:"tipo_ventana_id"},{title:"Ancho (mm)",value:"ancho"},{title:"Alto (mm)",value:"alto"},{title:"Cantidad",value:"cantidad"},{title:"Color",value:"color_id"},{title:"Vidrio",value:"producto_vidrio_proveedor_id"},{title:"Hojas Totales",value:"hojas_totales"},{title:"Hojas Móviles",value:"hojas_moviles"},{title:"Costo",value:"costo"},{title:"Precio",value:"precio"}],ro=[{title:"Descripción",value:"descripcion"},{title:"Cantidad",value:"cantidad"},{title:"Precio Unitario",value:"precio_unitario"},{title:"Total",value:"total"},{title:"Acciones",value:"actions",sortable:!1}],x=u([]),N=u([]),S=u([]),y=u([]),A=I(()=>{var i;return(i=t.value)!=null&&i.detalles?t.value.detalles.filter(o=>o.tipo_item==="producto"):[]}),U=I(()=>y.value.flatMap(i=>i.colores_por_proveedor.map(o=>{var a;return{id:o.id,nombre:`${i.nombre} (${((a=o.proveedor)==null?void 0:a.nombre)||"Desconocido"})`,producto_id:i.id,proveedor_id:o.proveedor_id,producto:i,proveedor:o.proveedor}}))),B=()=>{K.push({path:"/cotizaciones"})},lo=async()=>{const i=JSON.stringify(w.value),o=JSON.stringify(t.value);if(i===o){alert("No hay cambios para guardar");return}try{console.log("🧾 Payload a guardar:",t.value.ventanas.map(e=>({id:e.id,hojas_totales:e.hojas_totales,hojas_moviles:e.hojas_moviles,tipo_ventana_id:e.tipo_ventana_id})));const a={cliente_id:t.value.cliente_id,fecha:t.value.fecha,estado_cotizacion_id:t.value.estado_cotizacion_id,observaciones:t.value.observaciones,ventanas:t.value.ventanas.map(e=>({id:e.id,tipo_ventana_id:e.tipo_ventana_id,ancho:e.ancho,alto:e.alto,cantidad:e.cantidad||1,color_id:e.color_id,tipo_vidrio_id:e.tipo_vidrio_id,producto_vidrio_proveedor_id:Number(e.producto_vidrio_proveedor_id),costo:e.costo_total||e.costo||0,costo_unitario:e.costo_unitario||0,precio:e.precio||0,precio_unitario:e.precio_unitario||0,hojas_totales:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_totales:null,hojas_moviles:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_moviles:null})),productos:(t.value.detalles||[]).filter(e=>e.tipo_item==="producto").map(e=>({id:e.id,producto_lista_id:e.producto_lista_id,lista_precio_id:e.lista_precio_id,descripcion:e.descripcion,cantidad:e.cantidad,precio_unitario:e.precio_unitario,precio_venta:e.precio_unitario,total:e.total}))};await m.put(`/api/cotizaciones/${t.value.id}`,a),alert("Cotización actualizada correctamente"),B()}catch(a){console.error("❌ Error al guardar cambios:",a),alert("Error al guardar cambios")}};return _o(async()=>{try{const[i,o,a,e,s,c,so,no]=await Promise.all([m.get(`/api/cotizaciones/${Q}`),m.get("/api/tipos_ventana"),m.get("/api/colores"),m.get("/api/tipos_producto"),m.get("/api/productos"),m.get("/api/estados-cotizacion"),m.get("/api/clientes"),m.get("/api/tipos_material")]);y.value=s.data.filter(d=>[1,2].includes(d.tipo_producto_id));const uo=y.value.flatMap(d=>d.colores_por_proveedor.map(V=>{var _;return{id:V.id,nombre:`${d.nombre} (${((_=V.proveedor)==null?void 0:_.nombre)||"Desconocido"})`,producto_id:d.id,proveedor_id:V.proveedor_id,producto:d,proveedor:V.proveedor}})),f=i.data;f.ventanas=(f.ventanas||[]).map(d=>{var O;const V=Number(d.producto_vidrio_proveedor_id),_=uo.find(co=>co.id===V);return{...d,hojas_totales:d.hojas_totales??2,hojas_moviles:d.hojas_moviles??2,producto_vidrio_proveedor_id:V,cantidad:d.cantidad||1,tipo_vidrio_id:((O=_==null?void 0:_.producto)==null?void 0:O.tipo_producto_id)??null,producto_vidrio_proveedor:_||null,producto_vidrio_nombre:(_==null?void 0:_.nombre)||"—"}}),f.ventanas=f.ventanas.map(d=>({...d,original:{tipo_ventana_id:d.tipo_ventana_id,ancho:d.ancho,alto:d.alto,cantidad:d.cantidad||1,color_id:d.color_id,tipo_vidrio_id:d.tipo_vidrio_id,producto_vidrio_proveedor_id:d.producto_vidrio_proveedor_id}})),t.value=f,P.value=so.data,f.cliente&&!P.value.find(d=>d.id===f.cliente.id)&&P.value.unshift(f.cliente),L.value=no.data,w.value=JSON.parse(JSON.stringify(t.value)),x.value=o.data,N.value=a.data,S.value=e.data.filter(d=>[1,2].includes(d.id)),T.value=c.data,console.log("🧪 productosVidrioFiltrados:",U.value),console.log("🧾 ventanas:",t.value.ventanas.map(d=>d.producto_vidrio_proveedor_id))}catch(i){console.error("Error al cargar cotización:",i)}}),(i,o)=>(p(),g(Co,null,{default:r(()=>[t.value?(p(),b(J,{key:0},[l(E,{class:"mb-4"},{default:r(()=>[l(M,null,{default:r(()=>[n(" Editar Cotización #"+v(t.value.id)+" ",1),l(F),l(C,{icon:"",onClick:B},{default:r(()=>[l(h,null,{default:r(()=>o[8]||(o[8]=[n("mdi-arrow-left")])),_:1})]),_:1})]),_:1}),l(jo,null,{default:r(()=>[l(ko,{onSubmit:vo(lo,["prevent"]),ref_key:"form",ref:to},{default:r(()=>[l(q,null,{default:r(()=>[l(z,{cols:"12",sm:"6"},{default:r(()=>[l(Po,{modelValue:t.value.cliente_id,"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.cliente_id=a),items:P.value,"item-title":"razon_social","item-value":"id",label:"Cliente",clearable:""},null,8,["modelValue","items"])]),_:1}),l(z,{cols:"12",sm:"6"},{default:r(()=>[l(ho,{modelValue:t.value.fecha,"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.fecha=a),label:"Fecha",type:"date"},null,8,["modelValue"])]),_:1}),l(z,{cols:"12",sm:"6"},{default:r(()=>[l($o,{modelValue:t.value.estado_cotizacion_id,"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.estado_cotizacion_id=a),items:T.value,"item-value":"id","item-title":"nombre",label:"Estado"},null,8,["modelValue","items"])]),_:1}),l(z,{cols:"12"},{default:r(()=>[l(xo,{modelValue:t.value.observaciones,"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.observaciones=a),label:"Observaciones"},null,8,["modelValue"])]),_:1})]),_:1}),l(C,{type:"submit",color:"primary",class:"mt-4"},{default:r(()=>o[9]||(o[9]=[n("Guardar Cambios")])),_:1})]),_:1},512)]),_:1})]),_:1}),l(E,null,{default:r(()=>[l(M,null,{default:r(()=>[o[11]||(o[11]=n(" Ventanas ")),l(F),t.value.estado_cotizacion_id===1?(p(),g(C,{key:0,icon:"",onClick:o[4]||(o[4]=a=>j.value=!0)},{default:r(()=>[l(h,null,{default:r(()=>o[10]||(o[10]=[n("mdi-plus")])),_:1})]),_:1})):D("",!0)]),_:1}),t.value.estado_cotizacion_id===1?(p(),b("div",No,[(p(!0),b(J,null,fo(t.value.ventanas,(a,e)=>(p(),b("div",{key:e,class:"mb-6"},[l(go,{ventana:a,tiposVentana:x.value,colores:N.value,tiposVidrio:S.value,productosVidrio:U.value},null,8,["ventana","tiposVentana","colores","tiposVidrio","productosVidrio"]),l(q,{class:"mt-2 px-4"},{default:r(()=>[l(z,{cols:"6"},{default:r(()=>[l($,{type:"info",variant:"tonal",color:"blue"},{default:r(()=>{var s,c;return[o[12]||(o[12]=H("strong",null,"Costo:",-1)),n(" $"+v(((c=(s=a.costo)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024),l(z,{cols:"6"},{default:r(()=>[l($,{type:"success",variant:"tonal",color:"green"},{default:r(()=>{var s,c;return[o[13]||(o[13]=H("strong",null,"Precio:",-1)),n(" $"+v(((c=(s=a.precio)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))])):(p(),b("div",So,[l(G,{headers:io,items:t.value.ventanas,"items-per-page":5,class:"elevation-1"},{"item.tipo_ventana_id":r(({item:a})=>{var e;return[n(v(((e=a.tipo_ventana)==null?void 0:e.nombre)||"—"),1)]}),"item.color_id":r(({item:a})=>[l(X,{color:"primary",variant:"tonal",size:"small"},{default:r(()=>{var e;return[n(v(((e=a.color_obj)==null?void 0:e.nombre)||"—"),1)]}),_:2},1024)]),"item.producto_vidrio_proveedor_id":r(({item:a})=>[l(X,{color:"green",variant:"tonal",size:"small"},{default:r(()=>{var e,s,c;return[n(v(((s=(e=a.producto_vidrio_proveedor)==null?void 0:e.producto)==null?void 0:s.nombre)||"—")+" ",1),(c=a.producto_vidrio_proveedor)!=null&&c.proveedor?(p(),b("span",Do," ("+v(a.producto_vidrio_proveedor.proveedor.nombre)+") ",1)):D("",!0)]}),_:2},1024)]),_:1},8,["items"])]))]),_:1}),l(E,{class:"mt-4"},{default:r(()=>[l(M,null,{default:r(()=>[o[15]||(o[15]=n(" Productos ")),l(F),t.value.estado_cotizacion_id===1?(p(),g(C,{key:0,icon:"",onClick:o[5]||(o[5]=a=>k.value=!0)},{default:r(()=>[l(h,null,{default:r(()=>o[14]||(o[14]=[n("mdi-plus")])),_:1})]),_:1})):D("",!0)]),_:1}),A.value.length>0?(p(),g(G,{key:0,headers:ro,items:A.value,"items-per-page":5,class:"elevation-1"},Vo({"item.precio_unitario":r(({item:a})=>{var e;return[n(" $"+v(((e=Number(a.precio_unitario))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),"item.total":r(({item:a})=>{var e;return[n(" $"+v(((e=Number(a.total))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),_:2},[t.value.estado_cotizacion_id===1?{name:"item.actions",fn:r(({item:a})=>[l(C,{icon:"",size:"small",onClick:e=>ao(a)},{default:r(()=>[l(h,null,{default:r(()=>o[16]||(o[16]=[n("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1032,["items"])):(p(),g($,{key:1,type:"info",variant:"tonal",class:"ma-4"},{default:r(()=>o[17]||(o[17]=[n(" No hay productos agregados. Haz clic en el botón + para agregar productos. ")])),_:1}))]),_:1}),l(bo,{modelValue:j.value,"onUpdate:modelValue":o[6]||(o[6]=a=>j.value=a),tiposVentana:x.value,colores:N.value,materiales:L.value,tiposVidrio:S.value,productosVidrio:y.value,onAgregar:oo},null,8,["modelValue","tiposVentana","colores","materiales","tiposVidrio","productosVidrio"]),l(zo,{modelValue:k.value,"onUpdate:modelValue":o[7]||(o[7]=a=>k.value=a),onProductoSeleccionado:eo},null,8,["modelValue"])],64)):(p(),g($,{key:1,type:"info",variant:"outlined",class:"mt-4"},{default:r(()=>o[18]||(o[18]=[n(" Cargando cotización... ")])),_:1}))]),_:1}))}};export{ce as default};
