import{r as p,j as vo,ar as g,X as K,E as mo,f as C,e as i,k as fo,o as v,c as h,F as X,b as d,t as n,v as V,a3 as A,Z as U,a2 as go,m as L,i as Vo,d as B,aK as bo}from"./index-Bbf9NtO_.js";import Co from"./VentanaForm-DrTOFqPO.js";import yo from"./AgregarVentanaModal-B4Zafk-8.js";import zo from"./ModalProductos-Cs1IrK7p.js";import{d as ho}from"./debounce-DXIiIT6J.js";import{V as Po}from"./VContainer-CT8eMPy7.js";import{V as O,b as w}from"./VCard-C1PjMmAL.js";import{V as G}from"./VSpacer-ByV-CSYn.js";import{V as jo}from"./VCardText-BS7-d3lL.js";import{V as ko}from"./VForm-BY0SHyqZ.js";import{V as Q,a as P}from"./VRow-e2eJeLw2.js";import{V as Eo}from"./VAutocomplete-DnnP3-kU.js";import{V as Do}from"./VTextField-BML0o-9-.js";import{V as Ao}from"./VSelect-CaTpVbiJ.js";import{V as No}from"./VTextarea-cKmAB4GX.js";import{V as N}from"./VAlert-CYbz_vFs.js";import{V as W}from"./VDataTable-bxdMY2XJ.js";import{V as Y}from"./VChip-DRg--sXz.js";import"./VDialog-4rgjSyxk.js";import"./VOverlay-DUm3p4jJ.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-BVD5sUHd.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VDivider-gR8e3Iny.js";import"./VCheckbox-D1qv0VMy.js";import"./VCheckboxBtn-sSehld79.js";import"./VSelectionControl-BaBBSdHs.js";import"./VInput-BQ9KC5pQ.js";/* empty css              */import"./VAvatar-CFjRqMQj.js";import"./VImg-DDK4CAHl.js";import"./filter-C_GDCAu8.js";import"./VList-B-rGQG8c.js";import"./VMenu-B1TTIrK1.js";import"./VTable-CeArmYJ_.js";const Io={key:0},$o={key:1},xo={key:0},Mo={class:"font-weight-medium"},ge={__name:"cotizacion-editarELIMINARPARECE",setup(So){console.log("üöÄüöÄüöÄ ARCHIVO COTIZACION-EDITAR.VUE CARGADO - VERSI√ìN NUEVA üöÄüöÄüöÄ");const I=p(!1),$=p(!1),oo=vo(),eo=fo(),ao=oo.query.id;p([]);const H=p([]),J=p(null),x=p([]),R=p([]);p(!1),p(to());function to(){return{tipo_ventana_id:null,ancho:null,alto:null,cantidad:1,color_id:null,tipo_vidrio_id:null,producto_vidrio_proveedor_id:null,hojas_totales:2,hojas_moviles:2,costo:0,precio:0,materiales:[]}}const io=r=>D.value.flatMap(o=>o.colores_por_proveedor.map(a=>({id:a.id,producto_id:o.id,proveedor_id:a.proveedor_id}))).find(o=>o.id===r),lo=ho(async(r,o)=>{if(!r.productoVidrio||!r.proveedorVidrio||!r.tipo||!r.ancho||!r.alto){console.warn("‚ö†Ô∏è Payload incompleto para c√°lculo:",r);return}try{console.log("‚û°Ô∏è Enviando a /api/cotizador/calcular-materiales:",r);const a=await g.post("/api/cotizador/calcular-materiales",r);console.log("‚úÖ Respuesta del backend:",a.data);const e=o.cantidad||1;o.costo_total_unitario=a.data.costo_unitario,o.costo_total=a.data.costo_unitario*e,o.precio_unitario=Math.ceil(a.data.costo_unitario/(1-.45)),o.precio=o.precio_unitario*e,o.materiales=a.data.materiales??[],t.value.ventanas=[...t.value.ventanas],console.log("üßÆ Costo asignado:",o.costo),console.log("üßÆ Precio asignado:",o.precio);const s=t.value.ventanas.findIndex(c=>c===o);s!==-1&&(t.value.ventanas[s]={...o})}catch(a){console.error("‚ùå Error al calcular materiales:",a),o.costo=0,o.precio=0,o.materiales=[];const e=t.value.ventanas.findIndex(s=>s===o);e!==-1&&(t.value.ventanas[e]={...o})}},800),t=p({fecha:"",estado_cotizacion_id:null,observaciones:"",ventanas:[]});p(null);const ro=r=>{const o=io(r.producto_vidrio_proveedor_id),a={...r,costo:0,precio:0,materiales:[]};t.value.ventanas.push(a),console.log("üßæ Lista actual de ventanas:",t.value.ventanas);const e={...a,tipo:a.tipo_ventana_id,tipoVidrio:a.tipo_vidrio_id,productoVidrio:o==null?void 0:o.producto_id,proveedorVidrio:o==null?void 0:o.proveedor_id,hojas_moviles:a.tipo_ventana_id===3||a.tipo_ventana_id===46?a.hojas_moviles:void 0};console.log("‚úÖ Ejecutando recalcularCosto para ventana agregada..."),lo(e,a),t.value.ventanas=[...t.value.ventanas],I.value=!1},so=r=>{console.log("üì¶ Productos recibidos del modal:",r),Array.isArray(r)||(r=[r]),r.forEach(o=>{var T,y,_,l,m,u,b,z;console.log("üîç Item completo:",o),console.log("üîç Item.producto:",o.producto),console.log("üîç Lista precio ID:",o.lista_precio_id);let a=((T=o.producto)==null?void 0:T.nombre)||o.nombre||"Producto sin nombre";const e=((_=(y=o.producto)==null?void 0:y.listaPrecios)==null?void 0:_.find(f=>f.id===o.lista_precio_id))||((m=(l=o.producto)==null?void 0:l.lista_precios)==null?void 0:m.find(f=>f.id===o.lista_precio_id));console.log("üìã Lista precio encontrada:",e);let s="-",c="-";if(e){const f=e.producto_color_proveedor||e.productoColorProveedor;console.log("üé® ProductoColorProveedor:",f),f&&(s=((u=f.color)==null?void 0:u.nombre)||"-",c=((b=f.proveedor)==null?void 0:b.nombre)||"-",console.log("üé® Color:",s),console.log("üè¢ Proveedor:",c))}console.log("üìù Descripci√≥n final generada:",a);const S={tipo_item:"producto",producto_lista_id:o.producto_lista_id||((z=o.producto)==null?void 0:z.id),lista_precio_id:o.lista_precio_id,descripcion:a,color:s,proveedor:c,cantidad:o.cantidad,precio_unitario:o.precio_venta/o.cantidad,total:o.precio_venta*o.cantidad,_producto:o.producto,_listaPrecio:e,esVidrio:o.esVidrio||!1,ancho_mm:o.ancho_mm||null,alto_mm:o.alto_mm||null,m2:o.m2||null,pulido:o.pulido||!1};t.value.detalles||(t.value.detalles=[]),t.value.detalles.push(S),console.log("‚úÖ Producto agregado a detalles:",S)}),console.log("üìã Detalles actuales:",t.value.detalles),$.value=!1},no=r=>{if(!confirm(`¬øEliminar el producto "${r.descripcion}"?`))return;const o=t.value.detalles.findIndex(a=>a===r);o!==-1&&(t.value.detalles.splice(o,1),console.log("üóëÔ∏è Producto eliminado"))},co=p(null),uo=[{title:"Tipo de ventana",value:"tipo_ventana_id"},{title:"Ancho (mm)",value:"ancho"},{title:"Alto (mm)",value:"alto"},{title:"Cantidad",value:"cantidad"},{title:"Color",value:"color_id"},{title:"Vidrio",value:"producto_vidrio_proveedor_id"},{title:"Hojas Totales",value:"hojas_totales"},{title:"Hojas M√≥viles",value:"hojas_moviles"},{title:"Costo",value:"costo"},{title:"Precio",value:"precio"}],po=[{title:"Descripci√≥n",value:"descripcion"},{title:"Color",value:"color"},{title:"Proveedor",value:"proveedor"},{title:"Cantidad",value:"cantidad"},{title:"Precio Unitario",value:"precio_unitario"},{title:"Total",value:"total"},{title:"Acciones",value:"actions",sortable:!1}],j=p([]),k=p([]),E=p([]),D=p([]),Z=K(()=>{var r;return(r=t.value)!=null&&r.detalles?t.value.detalles.filter(o=>o.tipo_item==="producto"):[]}),M=K(()=>D.value.flatMap(r=>r.colores_por_proveedor.map(o=>{var a;return{id:o.id,nombre:`${r.nombre} (${((a=o.proveedor)==null?void 0:a.nombre)||"Desconocido"})`,producto_id:r.id,proveedor_id:o.proveedor_id,producto:r,proveedor:o.proveedor}}))),q=()=>{eo.push({path:"/cotizaciones"})},_o=async()=>{const r=JSON.stringify(J.value),o=JSON.stringify(t.value);if(r===o){alert("No hay cambios para guardar");return}try{console.log("üßæ Payload a guardar:",t.value.ventanas.map(e=>({id:e.id,hojas_totales:e.hojas_totales,hojas_moviles:e.hojas_moviles,tipo_ventana_id:e.tipo_ventana_id})));const a={cliente_id:t.value.cliente_id,fecha:t.value.fecha,estado_cotizacion_id:t.value.estado_cotizacion_id,observaciones:t.value.observaciones,ventanas:t.value.ventanas.map(e=>({id:e.id,tipo_ventana_id:e.tipo_ventana_id,ancho:e.ancho,alto:e.alto,cantidad:e.cantidad||1,color_id:e.color_id,tipo_vidrio_id:e.tipo_vidrio_id,producto_vidrio_proveedor_id:Number(e.producto_vidrio_proveedor_id),costo:e.costo_total||e.costo||0,costo_unitario:e.costo_unitario||0,precio:e.precio||0,precio_unitario:e.precio_unitario||0,hojas_totales:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_totales:null,hojas_moviles:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_moviles:null})),productos:(t.value.detalles||[]).filter(e=>e.tipo_item==="producto").map(e=>({id:e.id,producto_lista_id:e.producto_lista_id,lista_precio_id:e.lista_precio_id,descripcion:e.descripcion,cantidad:e.cantidad,precio_unitario:e.precio_unitario,precio_venta:e.precio_unitario,total:e.total}))};await g.put(`/api/cotizaciones/${t.value.id}`,a),alert("Cotizaci√≥n actualizada correctamente"),q()}catch(a){console.error("‚ùå Error al guardar cambios:",a),alert("Error al guardar cambios")}};return mo(async()=>{try{const[r,o,a,e,s,c,S,T]=await Promise.all([g.get(`/api/cotizaciones/${ao}`),g.get("/api/tipos_ventana"),g.get("/api/colores"),g.get("/api/tipos_producto"),g.get("/api/productos"),g.get("/api/estados-cotizacion"),g.get("/api/clientes"),g.get("/api/tipos_material")]);D.value=s.data.filter(l=>[1,2].includes(l.tipo_producto_id));const y=D.value.flatMap(l=>l.colores_por_proveedor.map(m=>{var u;return{id:m.id,nombre:`${l.nombre} (${((u=m.proveedor)==null?void 0:u.nombre)||"Desconocido"})`,producto_id:l.id,proveedor_id:m.proveedor_id,producto:l,proveedor:m.proveedor}}));console.log("üîç IDs disponibles en productosVidrioMapeados:",y.map(l=>l.id)),console.log("üîç Buscando ID 64 en:",y.find(l=>l.id===64)),console.log("üîç Total items mapeados:",y.length);const _=r.data;_.ventanas=(_.ventanas||[]).map(l=>{var b;const m=Number(l.producto_vidrio_proveedor_id),u=y.find(z=>z.id===m);return{...l,hojas_totales:l.hojas_totales??2,hojas_moviles:l.hojas_moviles??2,producto_vidrio_proveedor_id:m,cantidad:l.cantidad||1,tipo_vidrio_id:l.tipo_vidrio_id??((b=u==null?void 0:u.producto)==null?void 0:b.tipo_producto_id)??null,producto_vidrio_proveedor:u||null,producto_vidrio_nombre:(u==null?void 0:u.nombre)||"‚Äî"}}),_.ventanas=_.ventanas.map(l=>({...l,original:{tipo_ventana_id:l.tipo_ventana_id,ancho:l.ancho,alto:l.alto,cantidad:l.cantidad||1,color_id:l.color_id,tipo_vidrio_id:l.tipo_vidrio_id,producto_vidrio_proveedor_id:l.producto_vidrio_proveedor_id}})),t.value=_,_.detalles&&Array.isArray(_.detalles)&&(t.value.detalles=_.detalles.map(l=>{var m,u,b;if(l.tipo_item==="producto"){let z="-",f="-";const F=(m=l.descripcion)==null?void 0:m.match(/(.+?)\s*-\s*(.+?)\s*\((.+?)\)/);return F&&(z=((u=F[2])==null?void 0:u.trim())||"-",f=((b=F[3])==null?void 0:b.trim())||"-"),{...l,color:z,proveedor:f}}return l})),x.value=S.data,_.cliente&&!x.value.find(l=>l.id===_.cliente.id)&&x.value.unshift(_.cliente),R.value=T.data,J.value=JSON.parse(JSON.stringify(t.value)),j.value=o.data,k.value=a.data,E.value=e.data.filter(l=>[1,2].includes(l.id)),H.value=c.data,console.log("üß™ productosVidrioFiltrados:",M.value),console.log("üßæ ventanas:",t.value.ventanas),console.log("üîç DEBUG - tiposVentanaTodos:",j.value.length),console.log("üîç DEBUG - colores:",k.value.length),console.log("üîç DEBUG - tiposVidrio:",E.value.length),console.log("üîç DEBUG - productosVidrioFiltrados:",M.value),console.log("üîç DEBUG - ventana ejemplo:",t.value.ventanas[0])}catch(r){console.error("Error al cargar cotizaci√≥n:",r)}}),(r,o)=>(v(),C(Po,null,{default:i(()=>[t.value?(v(),h(X,{key:0},[d(O,{class:"mb-4"},{default:i(()=>[d(w,null,{default:i(()=>[n(" Editar Cotizaci√≥n #"+V(t.value.id)+" ",1),d(G),d(A,{icon:"",onClick:q},{default:i(()=>[d(U,null,{default:i(()=>o[8]||(o[8]=[n("mdi-arrow-left")])),_:1})]),_:1})]),_:1}),d(jo,null,{default:i(()=>[d(ko,{onSubmit:go(_o,["prevent"]),ref_key:"form",ref:co},{default:i(()=>[d(Q,null,{default:i(()=>[d(P,{cols:"12",sm:"6"},{default:i(()=>[d(Eo,{modelValue:t.value.cliente_id,"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.cliente_id=a),items:x.value,"item-title":"razon_social","item-value":"id",label:"Cliente",clearable:""},null,8,["modelValue","items"])]),_:1}),d(P,{cols:"12",sm:"6"},{default:i(()=>[d(Do,{modelValue:t.value.fecha,"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.fecha=a),label:"Fecha",type:"date"},null,8,["modelValue"])]),_:1}),d(P,{cols:"12",sm:"6"},{default:i(()=>[d(Ao,{modelValue:t.value.estado_cotizacion_id,"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.estado_cotizacion_id=a),items:H.value,"item-value":"id","item-title":"nombre",label:"Estado"},null,8,["modelValue","items"])]),_:1}),d(P,{cols:"12"},{default:i(()=>[d(No,{modelValue:t.value.observaciones,"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.observaciones=a),label:"Observaciones"},null,8,["modelValue"])]),_:1})]),_:1}),d(A,{type:"submit",color:"primary",class:"mt-4"},{default:i(()=>o[9]||(o[9]=[n("Guardar Cambios")])),_:1})]),_:1},512)]),_:1})]),_:1}),d(O,null,{default:i(()=>[d(w,null,{default:i(()=>[o[11]||(o[11]=n(" Ventanas ")),d(G),t.value.estado_cotizacion_id===1?(v(),C(A,{key:0,icon:"",onClick:o[4]||(o[4]=a=>I.value=!0)},{default:i(()=>[d(U,null,{default:i(()=>o[10]||(o[10]=[n("mdi-plus")])),_:1})]),_:1})):L("",!0)]),_:1}),t.value.estado_cotizacion_id===1?(v(),h("div",Io,[(v(!0),h(X,null,Vo(t.value.ventanas,(a,e)=>(v(),h("div",{key:e,class:"mb-6"},[j.value.length&&k.value.length&&E.value.length&&M.value.length?(v(),C(Co,{key:0,ventana:a,tiposVentana:j.value,colores:k.value,tiposVidrio:E.value,productosVidrio:M.value},null,8,["ventana","tiposVentana","colores","tiposVidrio","productosVidrio"])):(v(),C(N,{key:1,type:"info",variant:"outlined"},{default:i(()=>o[12]||(o[12]=[n(" Cargando datos de ventana... ")])),_:1})),d(Q,{class:"mt-2 px-4"},{default:i(()=>[d(P,{cols:"6"},{default:i(()=>[d(N,{type:"info",variant:"tonal",color:"blue"},{default:i(()=>{var s,c;return[o[13]||(o[13]=B("strong",null,"Costo:",-1)),n(" $"+V(((c=(s=a.costo)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024),d(P,{cols:"6"},{default:i(()=>[d(N,{type:"success",variant:"tonal",color:"green"},{default:i(()=>{var s,c;return[o[14]||(o[14]=B("strong",null,"Precio:",-1)),n(" $"+V(((c=(s=a.precio)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))])):(v(),h("div",$o,[d(W,{headers:uo,items:t.value.ventanas,"items-per-page":5,class:"elevation-1"},{"item.tipo_ventana_id":i(({item:a})=>{var e;return[n(V(((e=a.tipo_ventana)==null?void 0:e.nombre)||"‚Äî"),1)]}),"item.color_id":i(({item:a})=>[d(Y,{color:"primary",variant:"tonal",size:"small"},{default:i(()=>{var e;return[n(V(((e=a.color_obj)==null?void 0:e.nombre)||"‚Äî"),1)]}),_:2},1024)]),"item.producto_vidrio_proveedor_id":i(({item:a})=>[d(Y,{color:"green",variant:"tonal",size:"small"},{default:i(()=>{var e,s,c;return[n(V(((s=(e=a.producto_vidrio_proveedor)==null?void 0:e.producto)==null?void 0:s.nombre)||"‚Äî")+" ",1),(c=a.producto_vidrio_proveedor)!=null&&c.proveedor?(v(),h("span",xo," ("+V(a.producto_vidrio_proveedor.proveedor.nombre)+") ",1)):L("",!0)]}),_:2},1024)]),_:1},8,["items"])]))]),_:1}),d(O,{class:"mt-4"},{default:i(()=>[d(w,null,{default:i(()=>[o[16]||(o[16]=n(" Productos ")),d(G),t.value.estado_cotizacion_id===1?(v(),C(A,{key:0,icon:"",onClick:o[5]||(o[5]=a=>$.value=!0)},{default:i(()=>[d(U,null,{default:i(()=>o[15]||(o[15]=[n("mdi-plus")])),_:1})]),_:1})):L("",!0)]),_:1}),Z.value.length>0?(v(),C(W,{key:0,headers:po,items:Z.value,"items-per-page":5,class:"elevation-1"},bo({"item.descripcion":i(({item:a})=>[B("div",null,[B("div",Mo,V(a.descripcion),1)])]),"item.precio_unitario":i(({item:a})=>{var e;return[n(" $"+V(((e=Number(a.precio_unitario))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),"item.total":i(({item:a})=>{var e;return[n(" $"+V(((e=Number(a.total))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),_:2},[t.value.estado_cotizacion_id===1?{name:"item.actions",fn:i(({item:a})=>[d(A,{icon:"",size:"small",onClick:e=>no(a)},{default:i(()=>[d(U,null,{default:i(()=>o[17]||(o[17]=[n("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1032,["items"])):(v(),C(N,{key:1,type:"info",variant:"tonal",class:"ma-4"},{default:i(()=>o[18]||(o[18]=[n(" No hay productos agregados. Haz clic en el bot√≥n + para agregar productos. ")])),_:1}))]),_:1}),d(yo,{modelValue:I.value,"onUpdate:modelValue":o[6]||(o[6]=a=>I.value=a),tiposVentana:j.value,colores:k.value,materiales:R.value,tiposVidrio:E.value,productosVidrio:D.value,onAgregar:ro},null,8,["modelValue","tiposVentana","colores","materiales","tiposVidrio","productosVidrio"]),d(zo,{modelValue:$.value,"onUpdate:modelValue":o[7]||(o[7]=a=>$.value=a),onAgregarProductos:so},null,8,["modelValue"])],64)):(v(),C(N,{key:1,type:"info",variant:"outlined",class:"mt-4"},{default:i(()=>o[19]||(o[19]=[n(" Cargando cotizaci√≥n... ")])),_:1}))]),_:1}))}};export{ge as default};
