import{r as p,j as vo,ar as V,X as K,E as mo,f as C,e as i,k as fo,o as m,c as z,F as Q,b as r,t as n,v as g,a3 as j,Z as A,a2 as Vo,m as I,i as go,d as E,as as bo}from"./index-BAT6t6dn.js";import yo from"./VentanaForm-DE5hV10p.js";import Co from"./AgregarVentanaModal-Doh15-oA.js";import zo from"./ModalProductos-DG0eT8b0.js";import{d as Po}from"./debounce-D_d6wPhf.js";import{V as ho}from"./VContainer-BzGFklfp.js";import{V as U,b as B}from"./VCard-BwJMo3Sa.js";import{V as O}from"./VSpacer-DI5E1xVm.js";import{V as jo}from"./VCardText-BzaBTWSG.js";import{V as ko}from"./VForm-BP2AdKhJ.js";import{V as W,a as P}from"./VRow-D-y_YGx3.js";import{V as No}from"./VAutocomplete-DsoISqOr.js";import{V as $o}from"./VTextField-BwzlFcri.js";import{V as xo}from"./VSelect-lk15yJVS.js";import{V as Do}from"./VTextarea-D4pZq5_4.js";import{V as M}from"./VAlert-KDtKTwGG.js";import{V as Y}from"./VDataTable--xW2Rabd.js";import{V as R}from"./VChip-Cn1fsBNb.js";import"./VDialog-vep9fSVx.js";import"./VOverlay-eVUtE9Lb.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-nEvIYTAk.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VDivider-B77JXK-_.js";import"./VCheckbox-D5KTnipN.js";import"./VCheckboxBtn-DArM_N6A.js";import"./VSelectionControl-C2iAaFOT.js";import"./VInput-CdCpa2l2.js";/* empty css              */import"./VAvatar-B1MGj36n.js";import"./VImg-CddH4jLD.js";import"./filter-MkpO6Exy.js";import"./VList-C2cLds-k.js";import"./VMenu-c_WJAP6D.js";const So={key:0},Ao={key:1},Eo={key:0},Mo={class:"font-weight-medium"},fe={__name:"cotizacion-editar",setup(Fo){const k=p(!1),N=p(!1),oo=vo(),eo=fo(),ao=oo.query.id;p([]);const J=p([]),H=p(null),$=p([]),q=p([]);p(!1),p(to());function to(){return{tipo_ventana_id:null,ancho:null,alto:null,cantidad:1,color_id:null,tipo_vidrio_id:null,producto_vidrio_proveedor_id:null,hojas_totales:2,hojas_moviles:2,costo:0,precio:0,materiales:[]}}const io=l=>h.value.flatMap(o=>o.colores_por_proveedor.map(a=>({id:a.id,producto_id:o.id,proveedor_id:a.proveedor_id}))).find(o=>o.id===l),ro=Po(async(l,o)=>{if(!l.productoVidrio||!l.proveedorVidrio||!l.tipo||!l.ancho||!l.alto){console.warn("⚠️ Payload incompleto para cálculo:",l);return}try{console.log("➡️ Enviando a /api/cotizador/calcular-materiales:",l);const a=await V.post("/api/cotizador/calcular-materiales",l);console.log("✅ Respuesta del backend:",a.data);const e=o.cantidad||1;o.costo_total_unitario=a.data.costo_unitario,o.costo_total=a.data.costo_unitario*e,o.precio_unitario=Math.ceil(a.data.costo_unitario/(1-.45)),o.precio=o.precio_unitario*e,o.materiales=a.data.materiales??[],t.value.ventanas=[...t.value.ventanas],console.log("🧮 Costo asignado:",o.costo),console.log("🧮 Precio asignado:",o.precio);const s=t.value.ventanas.findIndex(c=>c===o);s!==-1&&(t.value.ventanas[s]={...o})}catch(a){console.error("❌ Error al calcular materiales:",a),o.costo=0,o.precio=0,o.materiales=[];const e=t.value.ventanas.findIndex(s=>s===o);e!==-1&&(t.value.ventanas[e]={...o})}},800),t=p({fecha:"",estado_cotizacion_id:null,observaciones:"",ventanas:[]});p(null);const lo=l=>{const o=io(l.producto_vidrio_proveedor_id),a={...l,costo:0,precio:0,materiales:[]};t.value.ventanas.push(a),console.log("🧾 Lista actual de ventanas:",t.value.ventanas);const e={...a,tipo:a.tipo_ventana_id,tipoVidrio:a.tipo_vidrio_id,productoVidrio:o==null?void 0:o.producto_id,proveedorVidrio:o==null?void 0:o.proveedor_id,hojas_moviles:a.tipo_ventana_id===3||a.tipo_ventana_id===46?a.hojas_moviles:void 0};console.log("✅ Ejecutando recalcularCosto para ventana agregada..."),ro(e,a),t.value.ventanas=[...t.value.ventanas],k.value=!1},so=l=>{console.log("📦 Productos recibidos del modal:",l),Array.isArray(l)||(l=[l]),l.forEach(o=>{var D,S,_,d,v,u,b,y;console.log("🔍 Item completo:",o),console.log("🔍 Item.producto:",o.producto),console.log("🔍 Lista precio ID:",o.lista_precio_id);let a=((D=o.producto)==null?void 0:D.nombre)||o.nombre||"Producto sin nombre";const e=((_=(S=o.producto)==null?void 0:S.listaPrecios)==null?void 0:_.find(f=>f.id===o.lista_precio_id))||((v=(d=o.producto)==null?void 0:d.lista_precios)==null?void 0:v.find(f=>f.id===o.lista_precio_id));console.log("📋 Lista precio encontrada:",e);let s="-",c="-";if(e){const f=e.producto_color_proveedor||e.productoColorProveedor;console.log("🎨 ProductoColorProveedor:",f),f&&(s=((u=f.color)==null?void 0:u.nombre)||"-",c=((b=f.proveedor)==null?void 0:b.nombre)||"-",console.log("🎨 Color:",s),console.log("🏢 Proveedor:",c))}console.log("📝 Descripción final generada:",a);const x={tipo_item:"producto",producto_lista_id:o.producto_lista_id||((y=o.producto)==null?void 0:y.id),lista_precio_id:o.lista_precio_id,descripcion:a,color:s,proveedor:c,cantidad:o.cantidad,precio_unitario:o.precio_venta/o.cantidad,total:o.precio_venta*o.cantidad,_producto:o.producto,_listaPrecio:e,esVidrio:o.esVidrio||!1,ancho_mm:o.ancho_mm||null,alto_mm:o.alto_mm||null,m2:o.m2||null,pulido:o.pulido||!1};t.value.detalles||(t.value.detalles=[]),t.value.detalles.push(x),console.log("✅ Producto agregado a detalles:",x)}),console.log("📋 Detalles actuales:",t.value.detalles),N.value=!1},no=l=>{if(!confirm(`¿Eliminar el producto "${l.descripcion}"?`))return;const o=t.value.detalles.findIndex(a=>a===l);o!==-1&&(t.value.detalles.splice(o,1),console.log("🗑️ Producto eliminado"))},co=p(null),uo=[{title:"Tipo de ventana",value:"tipo_ventana_id"},{title:"Ancho (mm)",value:"ancho"},{title:"Alto (mm)",value:"alto"},{title:"Cantidad",value:"cantidad"},{title:"Color",value:"color_id"},{title:"Vidrio",value:"producto_vidrio_proveedor_id"},{title:"Hojas Totales",value:"hojas_totales"},{title:"Hojas Móviles",value:"hojas_moviles"},{title:"Costo",value:"costo"},{title:"Precio",value:"precio"}],po=[{title:"Descripción",value:"descripcion"},{title:"Color",value:"color"},{title:"Proveedor",value:"proveedor"},{title:"Cantidad",value:"cantidad"},{title:"Precio Unitario",value:"precio_unitario"},{title:"Total",value:"total"},{title:"Acciones",value:"actions",sortable:!1}],F=p([]),L=p([]),T=p([]),h=p([]),G=K(()=>{var l;return(l=t.value)!=null&&l.detalles?t.value.detalles.filter(o=>o.tipo_item==="producto"):[]}),X=K(()=>h.value.flatMap(l=>l.colores_por_proveedor.map(o=>{var a;return{id:o.id,nombre:`${l.nombre} (${((a=o.proveedor)==null?void 0:a.nombre)||"Desconocido"})`,producto_id:l.id,proveedor_id:o.proveedor_id,producto:l,proveedor:o.proveedor}}))),Z=()=>{eo.push({path:"/cotizaciones"})},_o=async()=>{const l=JSON.stringify(H.value),o=JSON.stringify(t.value);if(l===o){alert("No hay cambios para guardar");return}try{console.log("🧾 Payload a guardar:",t.value.ventanas.map(e=>({id:e.id,hojas_totales:e.hojas_totales,hojas_moviles:e.hojas_moviles,tipo_ventana_id:e.tipo_ventana_id})));const a={cliente_id:t.value.cliente_id,fecha:t.value.fecha,estado_cotizacion_id:t.value.estado_cotizacion_id,observaciones:t.value.observaciones,ventanas:t.value.ventanas.map(e=>({id:e.id,tipo_ventana_id:e.tipo_ventana_id,ancho:e.ancho,alto:e.alto,cantidad:e.cantidad||1,color_id:e.color_id,tipo_vidrio_id:e.tipo_vidrio_id,producto_vidrio_proveedor_id:Number(e.producto_vidrio_proveedor_id),costo:e.costo_total||e.costo||0,costo_unitario:e.costo_unitario||0,precio:e.precio||0,precio_unitario:e.precio_unitario||0,hojas_totales:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_totales:null,hojas_moviles:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_moviles:null})),productos:(t.value.detalles||[]).filter(e=>e.tipo_item==="producto").map(e=>({id:e.id,producto_lista_id:e.producto_lista_id,lista_precio_id:e.lista_precio_id,descripcion:e.descripcion,cantidad:e.cantidad,precio_unitario:e.precio_unitario,precio_venta:e.precio_unitario,total:e.total}))};await V.put(`/api/cotizaciones/${t.value.id}`,a),alert("Cotización actualizada correctamente"),Z()}catch(a){console.error("❌ Error al guardar cambios:",a),alert("Error al guardar cambios")}};return mo(async()=>{try{const[l,o,a,e,s,c,x,D]=await Promise.all([V.get(`/api/cotizaciones/${ao}`),V.get("/api/tipos_ventana"),V.get("/api/colores"),V.get("/api/tipos_producto"),V.get("/api/productos"),V.get("/api/estados-cotizacion"),V.get("/api/clientes"),V.get("/api/tipos_material")]);h.value=s.data.filter(d=>[1,2].includes(d.tipo_producto_id));const S=h.value.flatMap(d=>d.colores_por_proveedor.map(v=>{var u;return{id:v.id,nombre:`${d.nombre} (${((u=v.proveedor)==null?void 0:u.nombre)||"Desconocido"})`,producto_id:d.id,proveedor_id:v.proveedor_id,producto:d,proveedor:v.proveedor}})),_=l.data;_.ventanas=(_.ventanas||[]).map(d=>{var b;const v=Number(d.producto_vidrio_proveedor_id),u=S.find(y=>y.id===v);return{...d,hojas_totales:d.hojas_totales??2,hojas_moviles:d.hojas_moviles??2,producto_vidrio_proveedor_id:v,cantidad:d.cantidad||1,tipo_vidrio_id:((b=u==null?void 0:u.producto)==null?void 0:b.tipo_producto_id)??null,producto_vidrio_proveedor:u||null,producto_vidrio_nombre:(u==null?void 0:u.nombre)||"—"}}),_.ventanas=_.ventanas.map(d=>({...d,original:{tipo_ventana_id:d.tipo_ventana_id,ancho:d.ancho,alto:d.alto,cantidad:d.cantidad||1,color_id:d.color_id,tipo_vidrio_id:d.tipo_vidrio_id,producto_vidrio_proveedor_id:d.producto_vidrio_proveedor_id}})),t.value=_,_.detalles&&Array.isArray(_.detalles)&&(t.value.detalles=_.detalles.map(d=>{var v,u,b;if(d.tipo_item==="producto"){let y="-",f="-";const w=(v=d.descripcion)==null?void 0:v.match(/(.+?)\s*-\s*(.+?)\s*\((.+?)\)/);return w&&(y=((u=w[2])==null?void 0:u.trim())||"-",f=((b=w[3])==null?void 0:b.trim())||"-"),{...d,color:y,proveedor:f}}return d})),$.value=x.data,_.cliente&&!$.value.find(d=>d.id===_.cliente.id)&&$.value.unshift(_.cliente),q.value=D.data,H.value=JSON.parse(JSON.stringify(t.value)),F.value=o.data,L.value=a.data,T.value=e.data.filter(d=>[1,2].includes(d.id)),J.value=c.data,console.log("🧪 productosVidrioFiltrados:",X.value),console.log("🧾 ventanas:",t.value.ventanas.map(d=>d.producto_vidrio_proveedor_id))}catch(l){console.error("Error al cargar cotización:",l)}}),(l,o)=>(m(),C(ho,null,{default:i(()=>[t.value?(m(),z(Q,{key:0},[r(U,{class:"mb-4"},{default:i(()=>[r(B,null,{default:i(()=>[n(" Editar Cotización #"+g(t.value.id)+" ",1),r(O),r(j,{icon:"",onClick:Z},{default:i(()=>[r(A,null,{default:i(()=>o[8]||(o[8]=[n("mdi-arrow-left")])),_:1})]),_:1})]),_:1}),r(jo,null,{default:i(()=>[r(ko,{onSubmit:Vo(_o,["prevent"]),ref_key:"form",ref:co},{default:i(()=>[r(W,null,{default:i(()=>[r(P,{cols:"12",sm:"6"},{default:i(()=>[r(No,{modelValue:t.value.cliente_id,"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.cliente_id=a),items:$.value,"item-title":"razon_social","item-value":"id",label:"Cliente",clearable:""},null,8,["modelValue","items"])]),_:1}),r(P,{cols:"12",sm:"6"},{default:i(()=>[r($o,{modelValue:t.value.fecha,"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.fecha=a),label:"Fecha",type:"date"},null,8,["modelValue"])]),_:1}),r(P,{cols:"12",sm:"6"},{default:i(()=>[r(xo,{modelValue:t.value.estado_cotizacion_id,"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.estado_cotizacion_id=a),items:J.value,"item-value":"id","item-title":"nombre",label:"Estado"},null,8,["modelValue","items"])]),_:1}),r(P,{cols:"12"},{default:i(()=>[r(Do,{modelValue:t.value.observaciones,"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.observaciones=a),label:"Observaciones"},null,8,["modelValue"])]),_:1})]),_:1}),r(j,{type:"submit",color:"primary",class:"mt-4"},{default:i(()=>o[9]||(o[9]=[n("Guardar Cambios")])),_:1})]),_:1},512)]),_:1})]),_:1}),r(U,null,{default:i(()=>[r(B,null,{default:i(()=>[o[11]||(o[11]=n(" Ventanas ")),r(O),t.value.estado_cotizacion_id===1?(m(),C(j,{key:0,icon:"",onClick:o[4]||(o[4]=a=>k.value=!0)},{default:i(()=>[r(A,null,{default:i(()=>o[10]||(o[10]=[n("mdi-plus")])),_:1})]),_:1})):I("",!0)]),_:1}),t.value.estado_cotizacion_id===1?(m(),z("div",So,[(m(!0),z(Q,null,go(t.value.ventanas,(a,e)=>(m(),z("div",{key:e,class:"mb-6"},[r(yo,{ventana:a,tiposVentana:F.value,colores:L.value,tiposVidrio:T.value,productosVidrio:X.value},null,8,["ventana","tiposVentana","colores","tiposVidrio","productosVidrio"]),r(W,{class:"mt-2 px-4"},{default:i(()=>[r(P,{cols:"6"},{default:i(()=>[r(M,{type:"info",variant:"tonal",color:"blue"},{default:i(()=>{var s,c;return[o[12]||(o[12]=E("strong",null,"Costo:",-1)),n(" $"+g(((c=(s=a.costo)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024),r(P,{cols:"6"},{default:i(()=>[r(M,{type:"success",variant:"tonal",color:"green"},{default:i(()=>{var s,c;return[o[13]||(o[13]=E("strong",null,"Precio:",-1)),n(" $"+g(((c=(s=a.precio)==null?void 0:s.toLocaleString)==null?void 0:c.call(s))||0),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))])):(m(),z("div",Ao,[r(Y,{headers:uo,items:t.value.ventanas,"items-per-page":5,class:"elevation-1"},{"item.tipo_ventana_id":i(({item:a})=>{var e;return[n(g(((e=a.tipo_ventana)==null?void 0:e.nombre)||"—"),1)]}),"item.color_id":i(({item:a})=>[r(R,{color:"primary",variant:"tonal",size:"small"},{default:i(()=>{var e;return[n(g(((e=a.color_obj)==null?void 0:e.nombre)||"—"),1)]}),_:2},1024)]),"item.producto_vidrio_proveedor_id":i(({item:a})=>[r(R,{color:"green",variant:"tonal",size:"small"},{default:i(()=>{var e,s,c;return[n(g(((s=(e=a.producto_vidrio_proveedor)==null?void 0:e.producto)==null?void 0:s.nombre)||"—")+" ",1),(c=a.producto_vidrio_proveedor)!=null&&c.proveedor?(m(),z("span",Eo," ("+g(a.producto_vidrio_proveedor.proveedor.nombre)+") ",1)):I("",!0)]}),_:2},1024)]),_:1},8,["items"])]))]),_:1}),r(U,{class:"mt-4"},{default:i(()=>[r(B,null,{default:i(()=>[o[15]||(o[15]=n(" Productos ")),r(O),t.value.estado_cotizacion_id===1?(m(),C(j,{key:0,icon:"",onClick:o[5]||(o[5]=a=>N.value=!0)},{default:i(()=>[r(A,null,{default:i(()=>o[14]||(o[14]=[n("mdi-plus")])),_:1})]),_:1})):I("",!0)]),_:1}),G.value.length>0?(m(),C(Y,{key:0,headers:po,items:G.value,"items-per-page":5,class:"elevation-1"},bo({"item.descripcion":i(({item:a})=>[E("div",null,[E("div",Mo,g(a.descripcion),1)])]),"item.precio_unitario":i(({item:a})=>{var e;return[n(" $"+g(((e=Number(a.precio_unitario))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),"item.total":i(({item:a})=>{var e;return[n(" $"+g(((e=Number(a.total))==null?void 0:e.toLocaleString("es-CL",{minimumFractionDigits:0}))||0),1)]}),_:2},[t.value.estado_cotizacion_id===1?{name:"item.actions",fn:i(({item:a})=>[r(j,{icon:"",size:"small",onClick:e=>no(a)},{default:i(()=>[r(A,null,{default:i(()=>o[16]||(o[16]=[n("mdi-delete")])),_:1})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1032,["items"])):(m(),C(M,{key:1,type:"info",variant:"tonal",class:"ma-4"},{default:i(()=>o[17]||(o[17]=[n(" No hay productos agregados. Haz clic en el botón + para agregar productos. ")])),_:1}))]),_:1}),r(Co,{modelValue:k.value,"onUpdate:modelValue":o[6]||(o[6]=a=>k.value=a),tiposVentana:F.value,colores:L.value,materiales:q.value,tiposVidrio:T.value,productosVidrio:h.value,onAgregar:lo},null,8,["modelValue","tiposVentana","colores","materiales","tiposVidrio","productosVidrio"]),r(zo,{modelValue:N.value,"onUpdate:modelValue":o[7]||(o[7]=a=>N.value=a),onAgregarProductos:so},null,8,["modelValue"])],64)):(m(),C(M,{key:1,type:"info",variant:"outlined",class:"mt-4"},{default:i(()=>o[18]||(o[18]=[n(" Cargando cotización... ")])),_:1}))]),_:1}))}};export{fe as default};
