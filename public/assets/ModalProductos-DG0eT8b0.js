import{r as C,X as T,w as z,f as g,e as r,o as m,b as a,d,a3 as h,c as U,t as _,v as c,F as O,i as eo,m as to,Z as ao,x as ro,ar as lo}from"./index-BAT6t6dn.js";import{_ as so}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as no}from"./VDialog-vep9fSVx.js";import{V as F,b as io,c as co}from"./VCard-BwJMo3Sa.js";import{V as uo}from"./VCardText-BzaBTWSG.js";import{V as k,a as i}from"./VRow-D-y_YGx3.js";import{V as b}from"./VTextField-BwzlFcri.js";import{V as po}from"./VDataTable--xW2Rabd.js";import{V as q}from"./VDivider-B77JXK-_.js";import{V as mo}from"./VChip-Cn1fsBNb.js";import{V as _o}from"./VCheckbox-D5KTnipN.js";import{V as fo}from"./VAlert-KDtKTwGG.js";import{V as vo}from"./VSpacer-DI5E1xVm.js";import"./VOverlay-eVUtE9Lb.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-nEvIYTAk.js";import"./VAvatar-B1MGj36n.js";import"./VImg-CddH4jLD.js";/* empty css              */import"./VInput-CdCpa2l2.js";import"./VSelect-lk15yJVS.js";import"./VList-C2cLds-k.js";import"./VMenu-c_WJAP6D.js";import"./VCheckboxBtn-DArM_N6A.js";import"./VSelectionControl-C2iAaFOT.js";import"./filter-MkpO6Exy.js";const Vo={key:0},go={class:"text-subtitle-1 mb-3"},bo={class:"text-subtitle-2"},yo={class:"text-caption text-grey"},xo={class:"text-subtitle-2"},Co={class:"text-subtitle-2"},ho={class:"text-subtitle-2 text-success"},Po={class:"text-subtitle-2"},$o={class:"text-subtitle-2"},ko={class:"text-subtitle-2 text-success"},wo={class:"text-h6 text-primary"},So={__name:"ModalProductos",props:{mostrar:{type:Boolean,default:!1}},emits:["update:mostrar","agregar-productos"],setup(J,{emit:j}){const R=J,I=j,f=C(!1),P=C([]),u=C([]),y=C(""),w=C(!1),X=[{title:"Código",key:"codigo_proveedor",sortable:!0},{title:"Nombre",key:"nombre",sortable:!0},{title:"Color",key:"color",sortable:!0},{title:"Precio",key:"precio",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,align:"center"}],Z=T(()=>{if(!Array.isArray(P.value))return[];const t=[];if(P.value.forEach(o=>{const l=(o.listaPrecios||o.lista_precios||[]).filter(n=>Number(n.activo)===1||n.activo===!0||n.activo==="1");l.length===0?t.push({...o,_productoOriginal:o,_listaPrecio:null,color:"-",precio:"-"}):l.forEach(n=>{var v;const p=n.color||((v=n.productoColorProveedor)==null?void 0:v.color);t.push({...o,_productoOriginal:o,_listaPrecio:n,id:`${o.id}_${n.id}`,color:(p==null?void 0:p.nombre)||"-",precio:`$${Number(n.precio_venta||0).toLocaleString("es-CL")}`})})}),!y.value)return t;const e=y.value.toLowerCase();return t.filter(o=>{var s,l,n;return((s=o.nombre)==null?void 0:s.toLowerCase().includes(e))||((l=o.codigo)==null?void 0:l.toLowerCase().includes(e))||((n=o.color)==null?void 0:n.toLowerCase().includes(e))})}),G=T(()=>u.value.reduce((t,e)=>{const o=e.esVidrio?e.precio_venta_total||0:e.precio_venta||0;return t+o},0));z(()=>R.mostrar,t=>{f.value=t,t&&H()}),z(f,t=>{I("update:mostrar",t),t||Y()});const H=async()=>{w.value=!0;try{let e=(await lo.get("/api/productos")).data;if(typeof e=="string")try{e=JSON.parse(e)}catch(o){console.error("Error al parsear JSON:",o),e=[]}P.value=Array.isArray(e)?e:[]}catch(t){console.error("Error al cargar productos:",t),P.value=[]}finally{w.value=!1}},K=t=>{var B,E,L;const e=t._productoOriginal,o=t._listaPrecio;if(u.value.find(D=>D.producto_lista_id===e.id&&D.lista_precio_id===(o==null?void 0:o.id))){alert("Esta variante del producto ya fue seleccionada");return}if(!o){alert("Este producto no tiene precio configurado");return}const l=o.productoColorProveedor||o.producto_color_proveedor,n=o.color||(l==null?void 0:l.color),p=parseFloat(o.precio_costo)||0,v=parseFloat(o.margen)||30,N=v>=100?0:p/(1-v/100),V=e.tipo_producto_id===1||e.tipo_producto_id===2;u.value.push({producto:{...e},producto_lista_id:e.id,lista_precio_id:o.id,cantidad:1,precio_costo:p,margen:v,precio_venta:N,precio_venta_total:N,descripcion:`${e.nombre} - ${(n==null?void 0:n.nombre)||"Sin color"}`,codigo:e.codigo,nombre:e.nombre,color:(n==null?void 0:n.nombre)||"-",proveedor:"-",tipo:((B=e.tipo_producto)==null?void 0:B.nombre)||"",unidad:((E=e.unidad)==null?void 0:E.nombre)||((L=e.unidad)==null?void 0:L.simbolo)||"",esVidrio:V,ancho_mm:V?null:void 0,alto_mm:V?null:void 0,m2:V?0:void 0,pulido:V?!1:void 0,precio_costo_calculado:V?p:void 0})},Q=t=>{u.value.splice(t,1)},W=t=>{const e=parseFloat(t.precio_costo)||0,o=parseFloat(t.cantidad)||1,s=parseFloat(t.margen)||0;if(s>=100){t.precio_venta=0;return}const l=e/(1-s/100);t.precio_venta=l*o},S=t=>{if(!t.esVidrio||!t.ancho_mm||!t.alto_mm)return 0;const e=t.ancho_mm*t.alto_mm/1e6;return t.m2=e,e},A=t=>{const e=S(t);return e>0?e.toFixed(4):"0.0000"},$=t=>{if(!t.esVidrio)return;const e=S(t);if(e<=0){t.precio_venta_total=0,t.precio_costo_calculado=t.precio_costo;return}let o=t.precio_costo;t.pulido&&(o=t.precio_costo*1.2),t.precio_costo_calculado=o;const s=parseFloat(t.margen)||0;if(s>=100){t.precio_venta_total=0,t.precio_venta=0;return}const n=o*e/(1-s/100),p=parseFloat(t.cantidad)||1;t.precio_venta_total=n*p,t.precio_venta=t.precio_venta_total},x=t=>new Intl.NumberFormat("es-CL").format(t||0),Y=()=>{u.value=[],y.value=""},M=()=>{f.value=!1},oo=()=>{if(u.value.filter(o=>o.esVidrio&&(!o.ancho_mm||!o.alto_mm||o.ancho_mm<=0||o.alto_mm<=0)).length>0){alert("Por favor, ingresa las dimensiones (ancho y alto) para todos los productos de vidrio");return}const e=u.value.map(o=>{if(o.esVidrio){const s=o.pulido?" [PULIDO]":"";return{...o,descripcion:`${o.nombre} - ${o.ancho_mm}mm x ${o.alto_mm}mm (${A(o)} m²)${s} - ${o.color}`,precio_venta:o.precio_venta_total,m2:S(o)}}return o});I("agregar-productos",e),f.value=!1};return(t,e)=>(m(),g(no,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value=o),"max-width":"1000px",persistent:""},{default:r(()=>[a(F,null,{default:r(()=>[a(io,{class:"text-h6 d-flex justify-space-between align-center"},{default:r(()=>[e[2]||(e[2]=d("span",null,"Agregar Productos",-1)),a(h,{icon:"mdi-close",variant:"text",onClick:M})]),_:1}),a(uo,null,{default:r(()=>[a(k,{dense:""},{default:r(()=>[a(i,{cols:"12"},{default:r(()=>[a(b,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=o=>y.value=o),label:"Buscar producto por nombre o código","prepend-inner-icon":"mdi-magnify",clearable:"",outlined:"",dense:"","hide-details":"auto"},null,8,["modelValue"])]),_:1})]),_:1}),a(po,{headers:X,items:Z.value,loading:w.value,"item-value":"id",class:"elevation-1 mt-4",density:"compact","items-per-page":10,"items-per-page-options":[5,10,25,50]},{"item.tipo_producto":r(({item:o})=>{var s;return[_(c(((s=o.tipoProducto)==null?void 0:s.nombre)||"-"),1)]}),"item.unidad":r(({item:o})=>{var s;return[_(c(((s=o.unidad)==null?void 0:s.abreviacion)||"-"),1)]}),"item.acciones":r(({item:o})=>[a(h,{icon:"mdi-plus",size:"small",color:"success",variant:"tonal",onClick:s=>K(o)},null,8,["onClick"])]),_:1},8,["items","loading"]),a(q,{class:"my-4"}),u.value.length>0?(m(),U("div",Vo,[d("h3",go,"Productos seleccionados ("+c(u.value.length)+")",1),(m(!0),U(O,null,eo(u.value,(o,s)=>(m(),g(F,{key:s,class:"mb-3 pa-3",outlined:""},{default:r(()=>[a(k,{dense:"",align:"center"},{default:r(()=>[a(i,{cols:"12",md:"3"},{default:r(()=>[d("div",bo,c(o.nombre),1),d("div",yo,c(o.codigo),1),o.esVidrio?(m(),g(mo,{key:0,size:"x-small",color:"info",class:"mt-1"},{default:r(()=>e[3]||(e[3]=[_(" Venta por m² ")])),_:1})):to("",!0)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[4]||(e[4]=d("div",{class:"text-caption text-grey"},"Color",-1)),d("div",xo,c(o.color||"-"),1)]),_:2},1024),o.esVidrio?(m(),g(i,{key:0,cols:"12",md:"12"},{default:r(()=>[a(q,{class:"my-2"}),a(k,{dense:""},{default:r(()=>[a(i,{cols:"6",md:"2"},{default:r(()=>[a(b,{modelValue:o.ancho_mm,"onUpdate:modelValue":l=>o.ancho_mm=l,modelModifiers:{number:!0},label:"Ancho (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(b,{modelValue:o.alto_mm,"onUpdate:modelValue":l=>o.alto_mm=l,modelModifiers:{number:!0},label:"Alto (mm)",type:"number",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[(m(),g(b,{key:`m2-${o.ancho_mm}-${o.alto_mm}`,"model-value":A(o),label:"m²",readonly:"",variant:"outlined",density:"compact","hide-details":"",class:"text-primary font-weight-bold"},{"append-inner":r(()=>[a(ao,{size:"small",color:"info"},{default:r(()=>e[5]||(e[5]=[_("mdi-texture-box")])),_:1})]),_:2},1032,["model-value"]))]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[a(b,{modelValue:o.cantidad,"onUpdate:modelValue":l=>o.cantidad=l,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[a(_o,{modelValue:o.pulido,"onUpdate:modelValue":l=>o.pulido=l,label:"Pulido (+20%)",color:"primary","hide-details":"",onChange:l=>$(o)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[6]||(e[6]=d("div",{class:"text-caption text-grey"},"P. Costo/m²",-1)),d("div",Co,"$"+c(x(o.precio_costo_calculado||o.precio_costo)),1)]),_:2},1024),a(i,{cols:"6",md:"2"},{default:r(()=>[e[7]||(e[7]=d("div",{class:"text-caption text-grey"},"P. Venta Total",-1)),d("div",ho,"$"+c(x(o.precio_venta_total)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)):(m(),U(O,{key:1},[a(i,{cols:"6",md:"1"},{default:r(()=>[a(b,{modelValue:o.cantidad,"onUpdate:modelValue":l=>o.cantidad=l,modelModifiers:{number:!0},label:"Cant.",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:l=>W(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(i,{cols:"6",md:"1"},{default:r(()=>[e[8]||(e[8]=d("div",{class:"text-caption text-grey"},"P. Costo",-1)),d("div",Po,"$"+c(x(o.precio_costo)),1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[9]||(e[9]=d("div",{class:"text-caption text-grey"},"Margen",-1)),d("div",$o,c(o.margen)+"%",1)]),_:2},1024),a(i,{cols:"4",md:"1"},{default:r(()=>[e[10]||(e[10]=d("div",{class:"text-caption text-grey"},"P. Venta",-1)),d("div",ko,"$"+c(x(o.precio_venta)),1)]),_:2},1024)],64)),a(i,{cols:o.esVidrio?12:4,md:o.esVidrio?12:1,class:ro(o.esVidrio?"":"text-right")},{default:r(()=>[a(h,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:l=>Q(s)},null,8,["onClick"])]),_:2},1032,["cols","md","class"])]),_:2},1024)]),_:2},1024))),128)),a(F,{class:"pa-3 bg-primary-lighten-5",outlined:""},{default:r(()=>[a(k,null,{default:r(()=>[a(i,{cols:"12",class:"text-right"},{default:r(()=>[e[11]||(e[11]=d("div",{class:"text-subtitle-2 text-grey"},"Total productos seleccionados:",-1)),d("div",wo,"$"+c(x(G.value)),1)]),_:1})]),_:1})]),_:1})])):(m(),g(fo,{key:1,type:"info",variant:"tonal",class:"mt-4"},{default:r(()=>e[12]||(e[12]=[_(" Busca y selecciona productos de la tabla para agregarlos a la cotización ")])),_:1}))]),_:1}),a(co,null,{default:r(()=>[a(vo),a(h,{color:"grey",variant:"text",onClick:M},{default:r(()=>e[13]||(e[13]=[_(" Cancelar ")])),_:1}),a(h,{color:"primary",variant:"elevated",disabled:u.value.length===0,onClick:oo},{default:r(()=>[_(" Agregar "+c(u.value.length)+" producto(s) ",1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},ee=so(So,[["__scopeId","data-v-d5c428d9"]]);export{ee as default};
