import{r as d,X as fe,E as ge,f as _e,e as t,au as f,o as L,b as a,d as u,a3 as p,t as s,v as n,c as K,aR as Q,aS as W}from"./index-DRX9M9WN.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as ye}from"./VContainer-C70ht2vR.js";import{V as S,b as D,c as j}from"./VCard-BoNNJYpO.js";import{V as I}from"./VDivider-DHT4taBX.js";import{V as $}from"./VCardText-DVBw6ri8.js";import{V as Y,a as m}from"./VRow-DCUoJdo7.js";import{V as g}from"./VTextField-CTI75BqX.js";import{V as be}from"./VSelect-CFChBydQ.js";import{V as we}from"./VDataTable-BILqiKJ7.js";import{V as T}from"./VChip-DcK6QxRS.js";import{V as B}from"./VDialog-C1-bouey.js";import{V as xe}from"./VForm-1MoOwht-.js";import{V as Z}from"./VAutocomplete-D7tcNp4E.js";import{a as ee}from"./VList-Di009mj3.js";import{V as Pe}from"./VSwitch-C5yad2Ff.js";import{V as R}from"./VSpacer-CFWtZVBW.js";import{V as Ce}from"./VAlert-CRsQhpRA.js";/* empty css              */import"./VAvatar-DagRnBOJ.js";import"./VImg-nNk6BlCn.js";import"./transition-DJoV2taJ.js";import"./VInput-CFHeTYPz.js";import"./forwardRefs-DWGaNmQL.js";import"./VOverlay-7L_Z2Pr0.js";import"./VMenu-Bi4kyHIV.js";import"./VCheckboxBtn-CZni9Hks.js";import"./VSelectionControl-KPuG38O6.js";const Ee={class:"d-flex gap-2"},ke={class:"font-weight-medium"},Se={key:0},De={class:"text-caption"},Ie={class:"text-caption text-grey mt-1"},$e={key:1,class:"text-grey"},Te={class:"font-weight-medium"},Ue={class:"font-weight-bold text-success"},Oe={class:"text-caption"},ze={class:"d-flex gap-1"},Ae={class:"text-center pa-4"},Me={class:"font-weight-bold mt-2"},Fe={__name:"index",setup(Ne){const U=d([]),h=d([]),v=d([]),O=d(!1),z=d(!1),A=d(!1),M=d(!1),P=d(""),C=d(null),y=d(!1),b=d(!1),w=d(!1),x=d(!1),F=d(null),N=d(45),l=d({id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0}),E=d(!1),oe=[{title:"Producto",key:"producto",sortable:!0},{title:"Color / Proveedor",key:"color_proveedor",sortable:!1},{title:"Precio Costo",key:"precio_costo",sortable:!0,align:"end"},{title:"Margen",key:"margen",sortable:!0,align:"center"},{title:"Precio Venta",key:"precio_venta",sortable:!0,align:"end"},{title:"Estado",key:"activo",sortable:!0,align:"center"},{title:"Vigencia",key:"vigencia",sortable:!1},{title:"Acciones",key:"acciones",sortable:!1,align:"center"}],ae=fe(()=>{const r=parseFloat(l.value.precio_costo)||0,o=parseFloat(l.value.margen)||0,e=r*(1+o/100);return k(e)}),_=async()=>{O.value=!0;try{const r={};C.value!==null&&(r.activo=C.value),P.value&&(r.search=P.value);const o=await f.get("/api/lista-precios",{params:r});U.value=o.data,console.log("📦 Datos cargados:",o.data),o.data.length>0&&console.log("📦 Primer item:",o.data[0])}catch(r){console.error("Error al cargar precios:",r),alert("Error al cargar los precios")}finally{O.value=!1}},te=()=>{_()},q=async()=>{try{const r=await f.get("/api/productos");h.value=r.data}catch(r){console.error("Error al cargar productos:",r)}},G=async()=>{if(!l.value.producto_id){v.value=[];return}try{const o=(await f.get("/api/productos")).data.find(i=>i.id===l.value.producto_id),e=(o==null?void 0:o.coloresPorProveedor)||(o==null?void 0:o.colores_por_proveedor)||[];e.length>0?(v.value=e,console.log("📦 Colores y proveedores cargados:",v.value)):(v.value=[],console.warn("⚠️ Producto sin colores/proveedores definidos"))}catch(r){console.error("Error al cargar producto-color-proveedor:",r),v.value=[]}},re=async(r,o)=>{E.value||(o!==void 0&&r!==o&&(l.value.producto_color_proveedor_id=null,l.value.precio_costo=0),await G())},le=()=>{if(!l.value.producto_color_proveedor_id)return;const r=v.value.find(o=>o.id===l.value.producto_color_proveedor_id);r&&r.costo&&(l.value.precio_costo=parseFloat(r.costo))},H=()=>{},ie=async()=>{x.value=!1,E.value=!1,l.value={id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0},await q(),y.value=!0},se=async r=>{console.log("📝 Editando precio:",r),x.value=!0,E.value=!0,l.value={id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0},y.value=!0,await q(),l.value.producto_id=r.producto_id,await G(),l.value={id:r.id,producto_id:r.producto_id,producto_color_proveedor_id:r.producto_color_proveedor_id,precio_costo:parseFloat(r.precio_costo),margen:parseFloat(r.margen),vigencia_desde:r.vigencia_desde?r.vigencia_desde.split(" ")[0]:"",vigencia_hasta:r.vigencia_hasta?r.vigencia_hasta.split(" ")[0]:"",activo:r.activo},console.log("📋 Formulario establecido:",l.value),console.log("🎨 Colores/Proveedores cargados:",v.value.length),E.value=!1},X=()=>{y.value=!1,l.value={id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0},v.value=[]},ne=async()=>{z.value=!0;try{x.value?(await f.put(`/api/lista-precios/${l.value.id}`,l.value),alert("Precio actualizado correctamente")):(await f.post("/api/lista-precios",l.value),alert("Precio creado correctamente")),await _(),X()}catch(r){console.error("Error al guardar precio:",r),alert("Error al guardar el precio")}finally{z.value=!1}},de=r=>{F.value=r,w.value=!0},ue=async()=>{M.value=!0;try{await f.delete(`/api/lista-precios/${F.value.id}`),alert("Precio eliminado correctamente"),await _(),w.value=!1}catch(r){console.error("Error al eliminar precio:",r),alert("Error al eliminar el precio")}finally{M.value=!1}},ce=async()=>{A.value=!0;try{const r=await f.post("/api/lista-precios/importar",{margen:N.value});alert(`Importación completada:
- Creados: ${r.data.creados}
- Actualizados: ${r.data.actualizados}
- Total: ${r.data.total}`),await _(),b.value=!1}catch(r){console.error("Error al importar precios:",r),alert("Error al importar los precios")}finally{A.value=!1}},pe=async()=>{try{const r=await f.get("/api/lista-precios/exportar");if(r.data.length===0){alert("No hay datos para exportar");return}const o=Object.keys(r.data[0]),e=[o.join(","),...r.data.map(me=>o.map(ve=>me[ve]).join(","))].join(`
`),i=new Blob([e],{type:"text/csv"}),c=window.URL.createObjectURL(i),V=document.createElement("a");V.href=c,V.download=`lista-precios-${new Date().toISOString().split("T")[0]}.csv`,V.click(),window.URL.revokeObjectURL(c)}catch(r){console.error("Error al exportar precios:",r),alert("Error al exportar los precios")}},k=r=>new Intl.NumberFormat("es-CL").format(r||0),J=r=>r?new Date(r).toLocaleDateString("es-CL"):"-";return ge(()=>{_()}),(r,o)=>(L(),_e(ye,{fluid:""},{default:t(()=>[a(S,null,{default:t(()=>[a(D,{class:"d-flex justify-space-between align-center"},{default:t(()=>[o[19]||(o[19]=u("div",null,[u("h2",{class:"text-h5"},"Lista de Precios"),u("p",{class:"text-subtitle-2 text-grey mt-1"}," Gestiona los precios de tus productos ")],-1)),u("div",Ee,[a(p,{color:"info","prepend-icon":"mdi-upload",onClick:o[0]||(o[0]=e=>b.value=!0)},{default:t(()=>o[16]||(o[16]=[s(" Importar desde PCP ")])),_:1}),a(p,{color:"success","prepend-icon":"mdi-download",onClick:pe},{default:t(()=>o[17]||(o[17]=[s(" Exportar Excel ")])),_:1}),a(p,{color:"primary","prepend-icon":"mdi-plus",onClick:ie},{default:t(()=>o[18]||(o[18]=[s(" Nuevo Precio ")])),_:1})])]),_:1}),a(I),a($,null,{default:t(()=>[a(Y,null,{default:t(()=>[a(m,{cols:"12",md:"6"},{default:t(()=>[a(g,{modelValue:P.value,"onUpdate:modelValue":[o[1]||(o[1]=e=>P.value=e),te],label:"Buscar por nombre o código","prepend-inner-icon":"mdi-magnify",clearable:"",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1}),a(m,{cols:"12",md:"3"},{default:t(()=>[a(be,{modelValue:C.value,"onUpdate:modelValue":[o[2]||(o[2]=e=>C.value=e),_],items:[{title:"Todos",value:null},{title:"Activos",value:"1"},{title:"Inactivos",value:"0"}],label:"Estado",density:"compact",variant:"outlined","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(we,{headers:oe,items:U.value,loading:O.value,"items-per-page":15,"items-per-page-options":[10,15,25,50,100],class:"elevation-1"},{"item.producto":t(({item:e})=>{var i;return[u("div",null,[u("div",ke,n((i=e.producto)==null?void 0:i.nombre),1)])]}),"item.color_proveedor":t(({item:e})=>{var i;return[e.producto_color_proveedor?(L(),K("div",Se,[u("div",De,[a(T,{size:"x-small",color:"primary",class:"mr-1"},{default:t(()=>{var c;return[s(n(((c=e.producto_color_proveedor.color)==null?void 0:c.nombre)||"Sin color"),1)]}),_:2},1024)]),u("div",Ie,n(((i=e.producto_color_proveedor.proveedor)==null?void 0:i.nombre)||"Sin proveedor"),1)])):(L(),K("span",$e,"-"))]}),"item.precio_costo":t(({item:e})=>[u("span",Te,"$"+n(k(e.precio_costo)),1)]),"item.margen":t(({item:e})=>[a(T,{size:"small",color:"info"},{default:t(()=>[s(n(e.margen)+"% ",1)]),_:2},1024)]),"item.precio_venta":t(({item:e})=>[u("span",Ue," $"+n(k(e.precio_venta)),1)]),"item.activo":t(({item:e})=>[a(T,{color:e.activo?"success":"error",size:"small"},{default:t(()=>[s(n(e.activo?"Activo":"Inactivo"),1)]),_:2},1032,["color"])]),"item.vigencia":t(({item:e})=>[u("div",Oe,[u("div",null,"Desde: "+n(J(e.vigencia_desde)),1),u("div",null,"Hasta: "+n(J(e.vigencia_hasta)),1)])]),"item.acciones":t(({item:e})=>[u("div",ze,[a(p,{icon:"mdi-pencil",size:"small",color:"primary",variant:"text",onClick:i=>se(e)},null,8,["onClick"]),a(p,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:i=>de(e)},null,8,["onClick"])])]),bottom:t(()=>[u("div",Ae,[a(T,{color:"primary",class:"mr-2"},{default:t(()=>[s(" Total: "+n(U.value.length)+" precios ",1)]),_:1})])]),_:1},8,["items","loading"])]),_:1}),a(B,{modelValue:y.value,"onUpdate:modelValue":o[10]||(o[10]=e=>y.value=e),"max-width":"700px",persistent:""},{default:t(()=>[a(S,null,{default:t(()=>[a(D,{class:"text-h6 bg-primary"},{default:t(()=>[s(n(x.value?"Editar Precio":"Nuevo Precio"),1)]),_:1}),a($,{class:"pt-4"},{default:t(()=>[a(xe,{ref_key:"formPrecio",ref:l},{default:t(()=>[a(Y,null,{default:t(()=>[a(m,{cols:"12"},{default:t(()=>[a(Z,{modelValue:l.value.producto_id,"onUpdate:modelValue":[o[3]||(o[3]=e=>l.value.producto_id=e),re],items:h.value,"item-title":"nombre","item-value":"id",label:"Producto *","prepend-inner-icon":"mdi-package-variant",variant:"outlined",density:"compact",rules:[e=>!!e||"El producto es requerido"]},{item:t(({props:e,item:i})=>[a(ee,Q(W(e)),{title:t(()=>[s(n(i.raw.nombre),1)]),subtitle:t(()=>{var c;return[s(n((c=i.raw.tipoProducto)==null?void 0:c.nombre),1)]}),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),a(m,{cols:"12"},{default:t(()=>[a(Z,{modelValue:l.value.producto_color_proveedor_id,"onUpdate:modelValue":[o[4]||(o[4]=e=>l.value.producto_color_proveedor_id=e),le],items:v.value,"item-title":e=>{var i,c;return`${((i=e.color)==null?void 0:i.nombre)||"Sin color"} - ${((c=e.proveedor)==null?void 0:c.nombre)||"Sin proveedor"}`},"item-value":"id",label:"Color y Proveedor *","prepend-inner-icon":"mdi-palette",variant:"outlined",density:"compact",disabled:!l.value.producto_id,rules:[e=>!!e||"Debes seleccionar un color y proveedor"]},{item:t(({props:e,item:i})=>[a(ee,Q(W(e)),{title:t(()=>{var c,V;return[s(n(((c=i.raw.color)==null?void 0:c.nombre)||"Sin color")+" - "+n(((V=i.raw.proveedor)==null?void 0:V.nombre)||"Sin proveedor"),1)]}),subtitle:t(()=>[s(" Costo: $"+n(k(i.raw.costo)),1)]),_:2},1040)]),_:1},8,["modelValue","items","item-title","disabled","rules"])]),_:1}),a(m,{cols:"12",md:"4"},{default:t(()=>[a(g,{modelValue:l.value.precio_costo,"onUpdate:modelValue":[o[5]||(o[5]=e=>l.value.precio_costo=e),H],modelModifiers:{number:!0},label:"Precio Costo *",type:"number",prefix:"$",variant:"outlined",density:"compact",rules:[e=>e!=null&&e!==""||"El precio costo es requerido",e=>e>=0||"Debe ser mayor o igual a 0"]},null,8,["modelValue","rules"])]),_:1}),a(m,{cols:"12",md:"4"},{default:t(()=>[a(g,{modelValue:l.value.margen,"onUpdate:modelValue":[o[6]||(o[6]=e=>l.value.margen=e),H],modelModifiers:{number:!0},label:"Margen % *",type:"number",suffix:"%",variant:"outlined",density:"compact",rules:[e=>e!=null&&e!==""||"El margen es requerido",e=>e>=0||"Debe ser mayor o igual a 0",e=>e<=100||"No puede ser mayor a 100"]},null,8,["modelValue","rules"])]),_:1}),a(m,{cols:"12",md:"4"},{default:t(()=>[a(g,{"model-value":ae.value,label:"Precio Venta",prefix:"$",variant:"outlined",density:"compact",readonly:"","bg-color":"grey-lighten-4"},null,8,["model-value"])]),_:1}),a(m,{cols:"12",md:"6"},{default:t(()=>[a(g,{modelValue:l.value.vigencia_desde,"onUpdate:modelValue":o[7]||(o[7]=e=>l.value.vigencia_desde=e),label:"Vigencia Desde",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(m,{cols:"12",md:"6"},{default:t(()=>[a(g,{modelValue:l.value.vigencia_hasta,"onUpdate:modelValue":o[8]||(o[8]=e=>l.value.vigencia_hasta=e),label:"Vigencia Hasta",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(m,{cols:"12"},{default:t(()=>[a(Pe,{modelValue:l.value.activo,"onUpdate:modelValue":o[9]||(o[9]=e=>l.value.activo=e),label:"Precio Activo",color:"success","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),a(I),a(j,null,{default:t(()=>[a(R),a(p,{color:"grey",variant:"text",onClick:X},{default:t(()=>o[20]||(o[20]=[s(" Cancelar ")])),_:1}),a(p,{color:"primary",variant:"elevated",loading:z.value,onClick:ne},{default:t(()=>[s(n(x.value?"Actualizar":"Guardar"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(B,{modelValue:b.value,"onUpdate:modelValue":o[13]||(o[13]=e=>b.value=e),"max-width":"500px"},{default:t(()=>[a(S,null,{default:t(()=>[a(D,{class:"text-h6 bg-info"},{default:t(()=>o[21]||(o[21]=[s(" Importar desde Producto-Color-Proveedor ")])),_:1}),a($,{class:"pt-4"},{default:t(()=>[a(Ce,{type:"info",variant:"tonal",class:"mb-4"},{default:t(()=>o[22]||(o[22]=[s(" Esta acción importará todos los productos con color y proveedor definidos, creando o actualizando los precios en la lista. ")])),_:1}),a(g,{modelValue:N.value,"onUpdate:modelValue":o[11]||(o[11]=e=>N.value=e),modelModifiers:{number:!0},label:"Margen por defecto (%)",type:"number",suffix:"%",variant:"outlined",hint:"Se aplicará este margen a todos los productos importados","persistent-hint":""},null,8,["modelValue"])]),_:1}),a(I),a(j,null,{default:t(()=>[a(R),a(p,{color:"grey",variant:"text",onClick:o[12]||(o[12]=e=>b.value=!1)},{default:t(()=>o[23]||(o[23]=[s(" Cancelar ")])),_:1}),a(p,{color:"info",variant:"elevated",loading:A.value,onClick:ce},{default:t(()=>o[24]||(o[24]=[s(" Importar ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(B,{modelValue:w.value,"onUpdate:modelValue":o[15]||(o[15]=e=>w.value=e),"max-width":"400px"},{default:t(()=>[a(S,null,{default:t(()=>[a(D,{class:"text-h6 bg-error"},{default:t(()=>o[25]||(o[25]=[s(" Confirmar Eliminación ")])),_:1}),a($,{class:"pt-4"},{default:t(()=>{var e,i;return[o[26]||(o[26]=u("p",null,"¿Estás seguro de que deseas eliminar este precio?",-1)),u("p",Me,n((i=(e=F.value)==null?void 0:e.producto)==null?void 0:i.nombre),1)]}),_:1}),a(I),a(j,null,{default:t(()=>[a(R),a(p,{color:"grey",variant:"text",onClick:o[14]||(o[14]=e=>w.value=!1)},{default:t(()=>o[27]||(o[27]=[s(" Cancelar ")])),_:1}),a(p,{color:"error",variant:"elevated",loading:M.value,onClick:ue},{default:t(()=>o[28]||(o[28]=[s(" Eliminar ")])),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},vo=Ve(Fe,[["__scopeId","data-v-78527914"]]);export{vo as default};
