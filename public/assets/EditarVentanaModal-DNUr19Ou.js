import{r as U,w as M,X as w,f as p,e as l,o as v,b as a,t as s,a2 as G,m as _,d as A,v as b,a3 as T,Z as X,ar as Z}from"./index-Bbf9NtO_.js";import{_ as q}from"./VistaVentanaFijaS60-BmTkm7Cv.js";import{V as H}from"./VDialog-4rgjSyxk.js";import{V as x,b as L,c as J}from"./VCard-C1PjMmAL.js";import{V as K}from"./VDivider-gR8e3Iny.js";import{V as Q}from"./VForm-BY0SHyqZ.js";import{V as y,a as i}from"./VRow-e2eJeLw2.js";import{V as g}from"./VSelect-CaTpVbiJ.js";import{V as k}from"./VTextField-BML0o-9-.js";import{V as R}from"./VAlert-CYbz_vFs.js";import{V as W}from"./VSpacer-ByV-CSYn.js";import{V as Y}from"./VDataTable-bxdMY2XJ.js";import"./VOverlay-DUm3p4jJ.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-BVD5sUHd.js";import"./VAvatar-CFjRqMQj.js";import"./VImg-DDK4CAHl.js";import"./VCardText-BS7-d3lL.js";import"./VInput-BQ9KC5pQ.js";/* empty css              */import"./VList-B-rGQG8c.js";import"./VMenu-B1TTIrK1.js";import"./VCheckboxBtn-sSehld79.js";import"./VSelectionControl-BaBBSdHs.js";import"./VChip-DRg--sXz.js";import"./VTable-CeArmYJ_.js";import"./filter-C_GDCAu8.js";const h=.45,Eo={__name:"EditarVentanaModal",props:{mostrar:Boolean,ventana:Object,materiales:Array,colores:Array,tiposVidrio:Array,tiposVentana:Array,productosVidrio:Array},emits:["update:mostrar","guardar"],setup(V,{emit:O}){const m=V,E=O,f=U(m.mostrar),o=U({});M(()=>m.mostrar,r=>{f.value=r,r&&m.ventana&&(o.value={...m.ventana},console.log("âœ… EDITAR MODAL - Ventana recibida:",o.value))}),M(f,r=>E("update:mostrar",r));const $=w(()=>m.tiposVentana.filter(r=>r.material_id===o.value.material)),S=w(()=>o.value.tipoVidrio?m.productosVidrio.filter(r=>r.tipo_producto_id===o.value.tipoVidrio).flatMap(r=>r.colores_por_proveedor?r.colores_por_proveedor.map(e=>{var t;return{id:e.id,nombre:`${r.nombre} (${((t=e.proveedor)==null?void 0:t.nombre)||"Sin proveedor"})`}}):[]):[]),I=()=>{f.value=!1},B=()=>{E("guardar",o.value),I()};async function F(){var r;if(o.value.tipo&&o.value.ancho&&o.value.alto&&o.value.cantidad&&o.value.color&&o.value.productoVidrioProveedor)try{console.log("ðŸ” EDITAR MODAL - Buscando relaciÃ³n para ID:",o.value.productoVidrioProveedor),console.log("ðŸ” EDITAR MODAL - productosVidrio disponibles:",((r=m.productosVidrio)==null?void 0:r.length)||0);const e=m.productosVidrio.filter(u=>u.colores_por_proveedor&&Array.isArray(u.colores_por_proveedor)).flatMap(u=>u.colores_por_proveedor.map(D=>({id:D.id,producto_id:u.id,proveedor_id:D.proveedor_id})));console.log("ðŸ” EDITAR MODAL - Total relaciones encontradas:",e.length),console.log("ðŸ” EDITAR MODAL - IDs disponibles:",e.map(u=>u.id));const t=e.find(u=>parseInt(u.id)===parseInt(o.value.productoVidrioProveedor));if(!t){console.error("âŒ No se encontrÃ³ la relaciÃ³n producto-proveedor para ID:",o.value.productoVidrioProveedor),console.error("âŒ Todas las relaciones:",e);return}console.log("âœ… EDITAR MODAL - RelaciÃ³n encontrada:",t);const c={tipo_ventana_id:o.value.tipo,tipo:o.value.tipo,ancho:o.value.ancho,alto:o.value.alto,cantidad:o.value.cantidad,color_id:o.value.color,color:o.value.color,producto_vidrio_proveedor_id:o.value.productoVidrioProveedor,producto_id:t.producto_id,proveedor_id:t.proveedor_id,productoVidrio:t.producto_id,proveedorVidrio:t.proveedor_id,tipoVidrio:o.value.tipoVidrio};console.log("ðŸ’° EDITAR MODAL - Recalculando costos:",c);const{data:d}=await Z.post("/api/cotizador/calcular-materiales",c);console.log("âœ… EDITAR MODAL - Respuesta:",d),o.value.costo_total_unitario=d.costo_unitario,o.value.costo_total=d.costo_unitario*o.value.cantidad,o.value.precio=Math.ceil(o.value.costo_total/(1-h)),o.value.materiales=d.materiales,console.log("ðŸ’µ EDITAR MODAL - Costos actualizados:"),console.log("   - costo_total_unitario:",o.value.costo_total_unitario),console.log("   - costo_total:",o.value.costo_total),console.log("   - precio:",o.value.precio)}catch(e){console.error("âŒ Error en recalcularCostos:",e),o.value.costo_total_unitario=0,o.value.costo_total=0,o.value.precio=0,o.value.materiales=[]}}M(()=>[o.value.ancho,o.value.alto,o.value.cantidad,o.value.color,o.value.productoVidrioProveedor],F,{deep:!0});const N=()=>{var P;if(!o.value.materiales||o.value.materiales.length===0){alert("No hay materiales para descargar");return}const r=["Material","Proveedor","Cantidad","Unidad","Costo Unitario","Costo Total"],e=o.value.materiales.map(n=>[n.nombre||"",n.proveedor||"",n.cantidad||0,n.unidad||"",n.costo_unitario||0,n.costo_total||0]);let t=r.join(",")+`
`;e.forEach(n=>{t+=n.map(z=>{const C=String(z).replace(/"/g,'""');return C.includes(",")?`"${C}"`:C}).join(",")+`
`});const c=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a"),u=URL.createObjectURL(c),j=`materiales_${((P=m.tiposVentana.find(n=>n.id===o.value.tipo))==null?void 0:P.nombre)||"ventana"}_${new Date().toISOString().split("T")[0]}.csv`;d.setAttribute("href",u),d.setAttribute("download",j),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d)};return(r,e)=>(v(),p(H,{modelValue:f.value,"onUpdate:modelValue":e[8]||(e[8]=t=>f.value=t),"max-width":"1200px",persistent:""},{default:l(()=>[a(x,{class:"pa-4"},{default:l(()=>[a(L,{class:"text-h5"},{default:l(()=>e[9]||(e[9]=[s("Editar ventana")])),_:1}),a(K,{class:"mb-4"}),a(Q,{ref:"formRef",onSubmit:G(B,["prevent"])},{default:l(()=>[a(y,{dense:""},{default:l(()=>[a(i,{cols:"12",md:"4"},{default:l(()=>[a(g,{modelValue:o.value.tipo,"onUpdate:modelValue":e[0]||(e[0]=t=>o.value.tipo=t),items:$.value,"item-title":"nombre","item-value":"id",label:"Tipo de ventana",outlined:"",color:"primary",disabled:""},null,8,["modelValue","items"])]),_:1}),a(i,{cols:"6",md:"2"},{default:l(()=>[a(k,{modelValue:o.value.ancho,"onUpdate:modelValue":e[1]||(e[1]=t=>o.value.ancho=t),modelModifiers:{number:!0},label:"Ancho (mm)",type:"number",outlined:"",color:"primary"},null,8,["modelValue"])]),_:1}),a(i,{cols:"6",md:"2"},{default:l(()=>[a(k,{modelValue:o.value.alto,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.alto=t),modelModifiers:{number:!0},label:"Alto (mm)",type:"number",outlined:"",color:"primary"},null,8,["modelValue"])]),_:1}),a(i,{cols:"6",md:"2"},{default:l(()=>[a(k,{modelValue:o.value.cantidad,"onUpdate:modelValue":e[3]||(e[3]=t=>o.value.cantidad=t),modelModifiers:{number:!0},label:"Cantidad",type:"number",outlined:"",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{dense:""},{default:l(()=>[a(i,{cols:"6",md:"3"},{default:l(()=>[a(g,{modelValue:o.value.material,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.material=t),items:V.materiales,"item-title":"nombre","item-value":"id",label:"Material",outlined:"",color:"primary",disabled:""},null,8,["modelValue","items"])]),_:1}),a(i,{cols:"6",md:"3"},{default:l(()=>[a(g,{modelValue:o.value.color,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.color=t),items:V.colores,"item-title":"nombre","item-value":"id",label:"Color",outlined:"",color:"primary"},null,8,["modelValue","items"])]),_:1}),a(i,{cols:"6",md:"3"},{default:l(()=>[a(g,{modelValue:o.value.tipoVidrio,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.tipoVidrio=t),items:V.tiposVidrio,"item-title":"nombre","item-value":"id",label:"Tipo de vidrio",outlined:"",color:"primary",disabled:""},null,8,["modelValue","items"])]),_:1}),a(i,{cols:"6",md:"3"},{default:l(()=>[a(g,{modelValue:o.value.productoVidrioProveedor,"onUpdate:modelValue":e[7]||(e[7]=t=>o.value.productoVidrioProveedor=t),items:S.value,"item-title":"nombre","item-value":"id",label:"Producto de vidrio",outlined:"",color:"primary"},null,8,["modelValue","items"])]),_:1})]),_:1}),a(y,null,{default:l(()=>[a(i,{cols:"12"},{default:l(()=>{var t;return[o.value.tipo===2?(v(),p(q,{key:0,ancho:o.value.ancho,alto:o.value.alto,"color-marco":((t=V.colores.find(c=>c.id===o.value.color))==null?void 0:t.nombre)||"blanco",material:o.value.material,tipoVidrio:o.value.tipoVidrio,productoVidrioProveedor:o.value.productoVidrioProveedor},null,8,["ancho","alto","color-marco","material","tipoVidrio","productoVidrioProveedor"])):_("",!0)]}),_:1})]),_:1}),a(y,null,{default:l(()=>[a(i,{cols:"12",md:"4"},{default:l(()=>[o.value.costo_total_unitario?(v(),p(R,{key:0,type:"info",variant:"outlined"},{default:l(()=>[e[10]||(e[10]=A("strong",null,"Costo unitario:",-1)),s(" $"+b(o.value.costo_total_unitario),1)]),_:1})):_("",!0)]),_:1}),a(i,{cols:"12",md:"4"},{default:l(()=>[o.value.costo_total?(v(),p(R,{key:0,type:"info",variant:"tonal"},{default:l(()=>[e[11]||(e[11]=A("strong",null,"Costo total:",-1)),s(" $"+b(o.value.costo_total),1)]),_:1})):_("",!0)]),_:1}),a(i,{cols:"12",md:"4"},{default:l(()=>[o.value.precio?(v(),p(R,{key:0,type:"success",variant:"tonal"},{default:l(()=>[e[12]||(e[12]=A("strong",null,"Precio de venta:",-1)),s(" $"+b(o.value.precio),1)]),_:1})):_("",!0)]),_:1})]),_:1}),o.value.materiales&&o.value.materiales.length?(v(),p(y,{key:0},{default:l(()=>[a(i,{cols:"12"},{default:l(()=>[a(x,{variant:"outlined"},{default:l(()=>[a(L,{class:"d-flex align-center"},{default:l(()=>[e[15]||(e[15]=A("span",null,"Detalle de materiales",-1)),a(W),a(T,{color:"success",variant:"tonal",size:"small",onClick:N},{default:l(()=>[a(X,{left:""},{default:l(()=>e[13]||(e[13]=[s("mdi-download")])),_:1}),e[14]||(e[14]=s(" Descargar Excel "))]),_:1})]),_:1}),a(Y,{headers:[{title:"Material",key:"nombre"},{title:"Proveedor",key:"proveedor"},{title:"Cantidad",key:"cantidad"},{title:"Unidad",key:"unidad"},{title:"Costo unitario",key:"costo_unitario"},{title:"Costo total",key:"costo_total"}],items:o.value.materiales,class:"mt-2",dense:"","items-per-page":10,"items-per-page-options":[5,10,25,50,{value:-1,title:"Todos"}]},{"item.costo_unitario":l(({item:t})=>[s(" $"+b(t.costo_unitario),1)]),"item.costo_total":l(({item:t})=>[s(" $"+b(t.costo_total),1)]),_:1},8,["items"])]),_:1})]),_:1})]),_:1})):_("",!0),a(J,{class:"justify-end mt-4"},{default:l(()=>[a(T,{color:"secondary",variant:"text",onClick:I},{default:l(()=>e[16]||(e[16]=[s("Cancelar")])),_:1}),a(T,{color:"primary",type:"submit"},{default:l(()=>e[17]||(e[17]=[s("Guardar cambios")])),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1},8,["modelValue"]))}};export{Eo as default};
