import{r as n,j as io,au as _,X as ro,E as lo,f as x,e as r,k as so,o as v,c as g,F as P,b as i,t as c,v as f,a3 as N,Z as A,a2 as no,m as B,i as uo,d as O}from"./index-BVpA1Ywp.js";import co from"./VentanaForm-DrSzLQW5.js";import po from"./AgregarVentanaModal-odOZZi37.js";import{d as _o}from"./debounce-zRTcBVAC.js";import{V as vo}from"./VContainer-BRpYNVHh.js";import{V as D,b as U}from"./VCard-C1RMa97J.js";import{V as I}from"./VSpacer-D4z7Uk_7.js";import{V as mo}from"./VCardText-vvruW0LQ.js";import{V as Vo}from"./VForm-CGghkbox.js";import{V as J,a as b}from"./VRow-BZumZuoX.js";import{V as fo}from"./VAutocomplete-BJ4oaYUt.js";import{V as go}from"./VTextField-D456lAgx.js";import{V as bo}from"./VSelect-B1lTgiKR.js";import{V as zo}from"./VTextarea-CXfRP-0t.js";import{V as $}from"./VAlert-U45pBzdr.js";import{V as ho}from"./VDataTable-5Qc8kTby.js";import{V as L}from"./VChip--cc27nVh.js";import"./VDialog-wDD9wl6W.js";import"./VOverlay-DUx1217U.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-D46Ro-98.js";/* empty css              */import"./VAvatar-5gBSmyPY.js";import"./VImg-CJ-qG-Yc.js";import"./VInput-BlO8iqzh.js";import"./VList-D6lOss7d.js";import"./VDivider-DDPKeGJQ.js";import"./VMenu-CCdsEvyz.js";import"./VCheckboxBtn-BN_jGbjA.js";import"./VSelectionControl-DZMqUHzU.js";const yo={key:0},Co={key:1},jo={key:0},ea={__name:"cotizacion-editar",setup(ko){const h=n(!1),H=io(),q=so(),G=H.query.id;n([]);const E=n([]),S=n(null),y=n([]),M=n([]);n(!1),n(X());function X(){return{tipo_ventana_id:null,ancho:null,alto:null,cantidad:1,color_id:null,tipo_vidrio_id:null,producto_vidrio_proveedor_id:null,hojas_totales:2,hojas_moviles:2,costo:0,precio:0,materiales:[]}}const Z=d=>z.value.flatMap(o=>o.colores_por_proveedor.map(a=>({id:a.id,producto_id:o.id,proveedor_id:a.proveedor_id}))).find(o=>o.id===d),K=_o(async(d,o)=>{if(!d.productoVidrio||!d.proveedorVidrio||!d.tipo||!d.ancho||!d.alto){console.warn("⚠️ Payload incompleto para cálculo:",d);return}try{console.log("➡️ Enviando a /api/cotizador/calcular-materiales:",d);const a=await _.post("/api/cotizador/calcular-materiales",d);console.log("✅ Respuesta del backend:",a.data);const e=o.cantidad||1;o.costo_total_unitario=a.data.costo_unitario,o.costo_total=a.data.costo_unitario*e,o.precio_unitario=Math.ceil(a.data.costo_unitario/(1-.45)),o.precio=o.precio_unitario*e,o.materiales=a.data.materiales??[],t.value.ventanas=[...t.value.ventanas],console.log("🧮 Costo asignado:",o.costo),console.log("🧮 Precio asignado:",o.precio);const s=t.value.ventanas.findIndex(u=>u===o);s!==-1&&(t.value.ventanas[s]={...o})}catch(a){console.error("❌ Error al calcular materiales:",a),o.costo=0,o.precio=0,o.materiales=[];const e=t.value.ventanas.findIndex(s=>s===o);e!==-1&&(t.value.ventanas[e]={...o})}},800),t=n({fecha:"",estado_cotizacion_id:null,observaciones:"",ventanas:[]});n(null);const Q=d=>{const o=Z(d.producto_vidrio_proveedor_id),a={...d,costo:0,precio:0,materiales:[]};t.value.ventanas.push(a),console.log("🧾 Lista actual de ventanas:",t.value.ventanas);const e={...a,tipo:a.tipo_ventana_id,tipoVidrio:a.tipo_vidrio_id,productoVidrio:o==null?void 0:o.producto_id,proveedorVidrio:o==null?void 0:o.proveedor_id,hojas_moviles:a.tipo_ventana_id===3||a.tipo_ventana_id===46?a.hojas_moviles:void 0};console.log("✅ Ejecutando recalcularCosto para ventana agregada..."),K(e,a),t.value.ventanas=[...t.value.ventanas],h.value=!1},W=n(null),Y=[{title:"Tipo de ventana",value:"tipo_ventana_id"},{title:"Ancho (mm)",value:"ancho"},{title:"Alto (mm)",value:"alto"},{title:"Cantidad",value:"cantidad"},{title:"Color",value:"color_id"},{title:"Vidrio",value:"producto_vidrio_proveedor_id"},{title:"Hojas Totales",value:"hojas_totales"},{title:"Hojas Móviles",value:"hojas_moviles"},{title:"Costo",value:"costo"},{title:"Precio",value:"precio"}],C=n([]),j=n([]),k=n([]),z=n([]),T=ro(()=>z.value.flatMap(d=>d.colores_por_proveedor.map(o=>{var a;return{id:o.id,nombre:`${d.nombre} (${((a=o.proveedor)==null?void 0:a.nombre)||"Desconocido"})`,producto_id:d.id,proveedor_id:o.proveedor_id,producto:d,proveedor:o.proveedor}}))),w=()=>{q.push({path:"/cotizaciones"})},R=async()=>{const d=JSON.stringify(S.value),o=JSON.stringify(t.value);if(d===o){alert("No hay cambios para guardar");return}try{console.log("🧾 Payload a guardar:",t.value.ventanas.map(e=>({id:e.id,hojas_totales:e.hojas_totales,hojas_moviles:e.hojas_moviles,tipo_ventana_id:e.tipo_ventana_id})));const a={cliente_id:t.value.cliente_id,fecha:t.value.fecha,estado_cotizacion_id:t.value.estado_cotizacion_id,observaciones:t.value.observaciones,ventanas:t.value.ventanas.map(e=>({id:e.id,tipo_ventana_id:e.tipo_ventana_id,ancho:e.ancho,alto:e.alto,cantidad:e.cantidad||1,color_id:e.color_id,tipo_vidrio_id:e.tipo_vidrio_id,producto_vidrio_proveedor_id:Number(e.producto_vidrio_proveedor_id),costo:e.costo_total||e.costo||0,costo_unitario:e.costo_unitario||0,precio:e.precio||0,precio_unitario:e.precio_unitario||0,hojas_totales:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_totales:null,hojas_moviles:e.tipo_ventana_id===3||e.tipo_ventana_id===46?e.hojas_moviles:null}))};await _.put(`/api/cotizaciones/${t.value.id}`,a),alert("Cotización actualizada correctamente"),w()}catch(a){console.error("❌ Error al guardar cambios:",a),alert("Error al guardar cambios")}};return lo(async()=>{try{const[d,o,a,e,s,u,oo,ao]=await Promise.all([_.get(`/api/cotizaciones/${G}`),_.get("/api/tipos_ventana"),_.get("/api/colores"),_.get("/api/tipos_producto"),_.get("/api/productos"),_.get("/api/estados-cotizacion"),_.get("/api/clientes"),_.get("/api/tipos_material")]);z.value=s.data.filter(l=>[1,2].includes(l.tipo_producto_id));const eo=z.value.flatMap(l=>l.colores_por_proveedor.map(V=>{var p;return{id:V.id,nombre:`${l.nombre} (${((p=V.proveedor)==null?void 0:p.nombre)||"Desconocido"})`,producto_id:l.id,proveedor_id:V.proveedor_id,producto:l,proveedor:V.proveedor}})),m=d.data;m.ventanas=(m.ventanas||[]).map(l=>{var F;const V=Number(l.producto_vidrio_proveedor_id),p=eo.find(to=>to.id===V);return{...l,hojas_totales:l.hojas_totales??2,hojas_moviles:l.hojas_moviles??2,producto_vidrio_proveedor_id:V,cantidad:l.cantidad||1,tipo_vidrio_id:((F=p==null?void 0:p.producto)==null?void 0:F.tipo_producto_id)??null,producto_vidrio_proveedor:p||null,producto_vidrio_nombre:(p==null?void 0:p.nombre)||"—"}}),m.ventanas=m.ventanas.map(l=>({...l,original:{tipo_ventana_id:l.tipo_ventana_id,ancho:l.ancho,alto:l.alto,cantidad:l.cantidad||1,color_id:l.color_id,tipo_vidrio_id:l.tipo_vidrio_id,producto_vidrio_proveedor_id:l.producto_vidrio_proveedor_id}})),t.value=m,y.value=oo.data,m.cliente&&!y.value.find(l=>l.id===m.cliente.id)&&y.value.unshift(m.cliente),M.value=ao.data,S.value=JSON.parse(JSON.stringify(t.value)),C.value=o.data,j.value=a.data,k.value=e.data.filter(l=>[1,2].includes(l.id)),E.value=u.data,console.log("🧪 productosVidrioFiltrados:",T.value),console.log("🧾 ventanas:",t.value.ventanas.map(l=>l.producto_vidrio_proveedor_id))}catch(d){console.error("Error al cargar cotización:",d)}}),(d,o)=>(v(),x(vo,null,{default:r(()=>[t.value?(v(),g(P,{key:0},[i(D,{class:"mb-4"},{default:r(()=>[i(U,null,{default:r(()=>[c(" Editar Cotización #"+f(t.value.id)+" ",1),i(I),i(N,{icon:"",onClick:w},{default:r(()=>[i(A,null,{default:r(()=>o[6]||(o[6]=[c("mdi-arrow-left")])),_:1})]),_:1})]),_:1}),i(mo,null,{default:r(()=>[i(Vo,{onSubmit:no(R,["prevent"]),ref_key:"form",ref:W},{default:r(()=>[i(J,null,{default:r(()=>[i(b,{cols:"12",sm:"6"},{default:r(()=>[i(fo,{modelValue:t.value.cliente_id,"onUpdate:modelValue":o[0]||(o[0]=a=>t.value.cliente_id=a),items:y.value,"item-title":"razon_social","item-value":"id",label:"Cliente",clearable:""},null,8,["modelValue","items"])]),_:1}),i(b,{cols:"12",sm:"6"},{default:r(()=>[i(go,{modelValue:t.value.fecha,"onUpdate:modelValue":o[1]||(o[1]=a=>t.value.fecha=a),label:"Fecha",type:"date"},null,8,["modelValue"])]),_:1}),i(b,{cols:"12",sm:"6"},{default:r(()=>[i(bo,{modelValue:t.value.estado_cotizacion_id,"onUpdate:modelValue":o[2]||(o[2]=a=>t.value.estado_cotizacion_id=a),items:E.value,"item-value":"id","item-title":"nombre",label:"Estado"},null,8,["modelValue","items"])]),_:1}),i(b,{cols:"12"},{default:r(()=>[i(zo,{modelValue:t.value.observaciones,"onUpdate:modelValue":o[3]||(o[3]=a=>t.value.observaciones=a),label:"Observaciones"},null,8,["modelValue"])]),_:1})]),_:1}),i(N,{type:"submit",color:"primary",class:"mt-4"},{default:r(()=>o[7]||(o[7]=[c("Guardar Cambios")])),_:1})]),_:1},512)]),_:1})]),_:1}),i(D,null,{default:r(()=>[i(U,null,{default:r(()=>[o[9]||(o[9]=c(" Ventanas ")),i(I),t.value.estado_cotizacion_id===1?(v(),x(N,{key:0,icon:"",onClick:o[4]||(o[4]=a=>h.value=!0)},{default:r(()=>[i(A,null,{default:r(()=>o[8]||(o[8]=[c("mdi-plus")])),_:1})]),_:1})):B("",!0)]),_:1}),t.value.estado_cotizacion_id===1?(v(),g("div",yo,[(v(!0),g(P,null,uo(t.value.ventanas,(a,e)=>(v(),g("div",{key:e,class:"mb-6"},[i(co,{ventana:a,tiposVentana:C.value,colores:j.value,tiposVidrio:k.value,productosVidrio:T.value},null,8,["ventana","tiposVentana","colores","tiposVidrio","productosVidrio"]),i(J,{class:"mt-2 px-4"},{default:r(()=>[i(b,{cols:"6"},{default:r(()=>[i($,{type:"info",variant:"tonal",color:"blue"},{default:r(()=>{var s,u;return[o[10]||(o[10]=O("strong",null,"Costo:",-1)),c(" $"+f(((u=(s=a.costo)==null?void 0:s.toLocaleString)==null?void 0:u.call(s))||0),1)]}),_:2},1024)]),_:2},1024),i(b,{cols:"6"},{default:r(()=>[i($,{type:"success",variant:"tonal",color:"green"},{default:r(()=>{var s,u;return[o[11]||(o[11]=O("strong",null,"Precio:",-1)),c(" $"+f(((u=(s=a.precio)==null?void 0:s.toLocaleString)==null?void 0:u.call(s))||0),1)]}),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))])):(v(),g("div",Co,[i(ho,{headers:Y,items:t.value.ventanas,"items-per-page":5,class:"elevation-1"},{"item.tipo_ventana_id":r(({item:a})=>{var e;return[c(f(((e=a.tipo_ventana)==null?void 0:e.nombre)||"—"),1)]}),"item.color_id":r(({item:a})=>[i(L,{color:"primary",variant:"tonal",size:"small"},{default:r(()=>{var e;return[c(f(((e=a.color_obj)==null?void 0:e.nombre)||"—"),1)]}),_:2},1024)]),"item.producto_vidrio_proveedor_id":r(({item:a})=>[i(L,{color:"green",variant:"tonal",size:"small"},{default:r(()=>{var e,s,u;return[c(f(((s=(e=a.producto_vidrio_proveedor)==null?void 0:e.producto)==null?void 0:s.nombre)||"—")+" ",1),(u=a.producto_vidrio_proveedor)!=null&&u.proveedor?(v(),g("span",jo," ("+f(a.producto_vidrio_proveedor.proveedor.nombre)+") ",1)):B("",!0)]}),_:2},1024)]),_:1},8,["items"])]))]),_:1}),i(po,{modelValue:h.value,"onUpdate:modelValue":o[5]||(o[5]=a=>h.value=a),tiposVentana:C.value,colores:j.value,materiales:M.value,tiposVidrio:k.value,productosVidrio:z.value,onAgregar:Q},null,8,["modelValue","tiposVentana","colores","materiales","tiposVidrio","productosVidrio"])],64)):(v(),x($,{key:1,type:"info",variant:"outlined",class:"mt-4"},{default:r(()=>o[12]||(o[12]=[c(" Cargando cotización... ")])),_:1}))]),_:1}))}};export{ea as default};
