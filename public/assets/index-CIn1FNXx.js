import{au as X,f as O,e as o,b as e,t as c,Z as F,a3 as j,o as N,d as t,v as u,a as ye,r as L,w as se,a2 as ze,X as me,m as oe,aH as _e,aI as Ce,c as ee,E as Ee,F as Le,i as he,q as $e}from"./index-BkN66Jee.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as M,c as de,V as B}from"./VCard-BIq9KtZy.js";import{V as Q}from"./VDivider-izuRbe5V.js";import{V as I}from"./VCardText-yvZq5wFx.js";import{V as ue}from"./VForm-D1--ze3Q.js";import{V as J,a as _}from"./VRow-zuKfOnXG.js";import{V as P}from"./VTextField-CvSPcfDi.js";import{V as Y}from"./VSelect-qe3QKkar.js";import{V as Te}from"./VCheckbox-BtoWTvll.js";import{V as ce}from"./VSpacer-DstO-xmX.js";import{V as ie}from"./VDialog-Vz5WCGXr.js";import{V as De}from"./VAutocomplete-CJYFT9o9.js";import{a as le,b as te,d as fe,V as Ne}from"./VList-CGw_ag0t.js";import{V as ke}from"./VTextarea-w5hHsEzw.js";import{V as Pe}from"./VSwitch-CKg5f6_W.js";import{V as Be}from"./VAlert-B_cBy9LO.js";import{V as ae}from"./VChip-B3ZmS2Q6.js";import{V as Se}from"./VDataTable-DrR-NKoO.js";import{V as Fe}from"./VAvatar-CUG03JWJ.js";import{V as xe}from"./VImg-B-BAd-J6.js";import{V as je}from"./VMenu-BRJgvGXh.js";import"./VInput-CN2X7-5r.js";import"./transition-ClaezFJr.js";import"./forwardRefs-DWGaNmQL.js";/* empty css              */import"./VOverlay-CN7rzLfz.js";import"./VCheckboxBtn-sD-GE5AJ.js";import"./VSelectionControl-Fr9-jP0N.js";const Ae={name:"ModalCrearClienteBsale",props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","cliente-creado"],data(){return{formValid:!1,creandoCliente:!1,comunas:[{id:1,name:"Santiago"},{id:2,name:"Las Condes"},{id:3,name:"Providencia"},{id:4,name:"Ñuñoa"},{id:5,name:"La Reina"},{id:6,name:"Vitacura"},{id:7,name:"Lo Barnechea"},{id:8,name:"Maipú"},{id:9,name:"Puente Alto"},{id:10,name:"La Florida"}],formulario:{nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},emailRules:[a=>!a||/.+@.+\..+/.test(a)||"Email debe ser válido"]}},computed:{dialog:{get(){return this.modelValue},set(a){this.$emit("update:modelValue",a)}}},watch:{dialog(a){a&&this.cotizacion&&this.precargarDatos()}},methods:{precargarDatos(){var a;if((a=this.cotizacion)!=null&&a.cliente){const l=this.cotizacion.cliente;this.formulario.nombre=l.nombre||"",this.formulario.rut=l.rut||"",this.formulario.email=l.email||"",this.formulario.telefono=l.telefono||"",this.formulario.direccion=l.direccion||"",this.formulario.giro="Comercio al por menor"}},async crearCliente(){var a,l;if(this.formValid){this.creandoCliente=!0;try{const b={nombre:this.formulario.nombre,apellido:this.formulario.apellido,rut:this.formulario.rut,email:this.formulario.email,telefono:this.formulario.telefono,empresa:this.formulario.empresa,giro:this.formulario.giro,direccion:this.formulario.direccion,comuna_id:this.formulario.comuna_id,enviar_email:this.formulario.enviar_email},x=await X.post("/api/bsale/clientes",b);if(x.data.success)this.$emit("cliente-creado",x.data.cliente),this.cerrar();else throw new Error(x.data.error||"Error desconocido")}catch(b){console.error("Error creando cliente:",b);const x=((l=(a=b.response)==null?void 0:a.data)==null?void 0:l.error)||b.message||"Error al crear cliente";this.$toast.error(x)}finally{this.creandoCliente=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var a;this.formulario={nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},(a=this.$refs.form)==null||a.resetValidation()}}};function qe(a,l,b,x,n,y){return N(),O(ie,{modelValue:y.dialog,"onUpdate:modelValue":l[11]||(l[11]=p=>y.dialog=p),"max-width":"600px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(M,{class:"text-h5 pa-4"},{default:o(()=>[e(F,{class:"mr-2",color:"primary"},{default:o(()=>l[12]||(l[12]=[c("mdi-account-plus")])),_:1}),l[13]||(l[13]=c(" Crear Cliente en BSALE "))]),_:1}),e(Q),e(I,{class:"pa-4"},{default:o(()=>[e(ue,{ref:"form",modelValue:n.formValid,"onUpdate:modelValue":l[10]||(l[10]=p=>n.formValid=p)},{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.nombre,"onUpdate:modelValue":l[0]||(l[0]=p=>n.formulario.nombre=p),label:"Nombre",rules:[p=>!!p||"Nombre es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.apellido,"onUpdate:modelValue":l[1]||(l[1]=p=>n.formulario.apellido=p),label:"Apellido",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.rut,"onUpdate:modelValue":l[2]||(l[2]=p=>n.formulario.rut=p),label:"RUT",rules:[p=>!!p||"RUT es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.email,"onUpdate:modelValue":l[3]||(l[3]=p=>n.formulario.email=p),label:"Email",type:"email",rules:n.emailRules,outlined:"","prepend-inner-icon":"mdi-email"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.telefono,"onUpdate:modelValue":l[4]||(l[4]=p=>n.formulario.telefono=p),label:"Teléfono",outlined:"","prepend-inner-icon":"mdi-phone",placeholder:"+56 9 1234 5678"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.empresa,"onUpdate:modelValue":l[5]||(l[5]=p=>n.formulario.empresa=p),label:"Empresa",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(P,{modelValue:n.formulario.giro,"onUpdate:modelValue":l[6]||(l[6]=p=>n.formulario.giro=p),label:"Giro/Actividad",rules:[p=>!!p||"Giro es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-briefcase",placeholder:"Ej: Comercio al por menor"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(P,{modelValue:n.formulario.direccion,"onUpdate:modelValue":l[7]||(l[7]=p=>n.formulario.direccion=p),label:"Dirección",outlined:"","prepend-inner-icon":"mdi-map-marker",placeholder:"Ej: Av. Principal 123"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:n.formulario.comuna_id,"onUpdate:modelValue":l[8]||(l[8]=p=>n.formulario.comuna_id=p),items:n.comunas,"item-value":"id","item-title":"name",label:"Comuna",rules:[p=>!!p||"Comuna es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-city"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(Te,{modelValue:n.formulario.enviar_email,"onUpdate:modelValue":l[9]||(l[9]=p=>n.formulario.enviar_email=p),label:"Enviar email de bienvenida al cliente",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(Q),e(de,{class:"pa-4"},{default:o(()=>[e(ce),e(j,{color:"grey",text:"",onClick:y.cerrar,disabled:n.creandoCliente},{default:o(()=>l[14]||(l[14]=[c(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(j,{color:"primary",onClick:y.crearCliente,loading:n.creandoCliente,disabled:!n.formValid},{default:o(()=>[e(F,{left:""},{default:o(()=>l[15]||(l[15]=[c("mdi-account-plus")])),_:1}),l[16]||(l[16]=c(" Crear Cliente "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const Ue=we(Ae,[["render",qe],["__scopeId","data-v-99c8a3e8"]]),Me={name:"ModalBsale",components:{ModalCrearClienteBsale:Ue},props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","documento-generado"],data(){return{formValid:!1,generandoDocumento:!1,cargandoClientes:!1,busquedaCliente:"",dialogCrearCliente:!1,tiposDocumento:[{id:3,name:"Nota de Venta",codeSii:"",description:"Documento de preventa"},{id:5,name:"Factura Electrónica",codeSii:"33",description:"Documento tributario electrónico"},{id:1,name:"Boleta Electrónica",codeSii:"39",description:"Boleta electrónica para consumidor final"}],oficinas:[],clientesBsale:[],metodosPago:[{text:"Efectivo",value:"efectivo"},{text:"Transferencia",value:"transferencia"},{text:"Cheque",value:"cheque"},{text:"Tarjeta de Crédito",value:"tarjeta_credito"},{text:"Tarjeta de Débito",value:"tarjeta_debito"}],formulario:{tipo_documento:null,oficina_id:null,cliente_bsale_id:null,metodo_pago:"transferencia",condiciones_pago:"30 días",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""}}},computed:{dialog:{get(){return this.modelValue},set(a){this.$emit("update:modelValue",a)}}},watch:{dialog(a){a&&this.cargarDatosIniciales()}},methods:{async cargarDatosIniciales(){var a,l,b,x,n,y,p,V;console.log("🔄 Cargando datos iniciales BSALE...");try{await this.cargarOficinas(),await this.cargarTiposDocumento(),((l=(a=this.cotizacion)==null?void 0:a.cliente)!=null&&l.rut||(x=(b=this.cotizacion)==null?void 0:b.cliente)!=null&&x.identification)&&await this.buscarClientesPorRut(this.cotizacion.cliente.rut||this.cotizacion.cliente.identification),console.log("✅ Datos iniciales cargados correctamente")}catch(i){console.error("❌ Error cargando datos iniciales:",i),console.error("Response:",(n=i.response)==null?void 0:n.data),console.error("Status:",(y=i.response)==null?void 0:y.status),console.error("URL:",(p=i.config)==null?void 0:p.url),(V=this.$toast)==null||V.error("Error al cargar datos de BSALE")}},async cargarOficinas(){try{const a=await X.get("/api/bsale-oficinas");this.oficinas=a.data.items.map(l=>({id:l.id,name:l.name,description:l.description,address:l.address})),console.log("✅ Oficinas cargadas:",this.oficinas.length)}catch(a){console.error("❌ Error cargando oficinas:",a),this.oficinas=[{id:1,name:"Oficina Principal"}]}},async cargarTiposDocumento(){try{const a=await X.get("/api/bsale-tipos-documento");this.tiposDocumento=a.data.items.map(l=>({id:l.id,name:l.name,codeSii:l.codeSii,description:l.description})),console.log("✅ Tipos de documento cargados:",this.tiposDocumento.length)}catch(a){console.error("❌ Error cargando tipos de documento:",a),console.log("Usando tipos de documento estáticos como fallback")}},async buscarClientes(a){var l;if(!(!a||a.length<2)){this.cargandoClientes=!0;try{const b=await X.get("/api/bsale/clientes",{params:{search:a}});b.data.success&&(this.clientesBsale=((l=b.data.clientes.items)==null?void 0:l.map(x=>({...x,displayName:`${x.company||`${x.firstName||""} ${x.lastName||""}`.trim()||"Sin nombre"} - ${x.code}`})))||[])}catch(b){console.error("Error buscando clientes:",b)}finally{this.cargandoClientes=!1}}},async buscarClientesPorRut(a){this.cargandoClientes=!0;try{const l=await X.get("/api/bsale/clientes",{params:{search:a}});if(l.data.success){const b=l.data.clientes.items||[];this.clientesBsale=b.map(n=>({...n,displayName:`${n.company||`${n.firstName||""} ${n.lastName||""}`.trim()||"Sin nombre"} - ${n.code}`}));const x=b.find(n=>n.code===a);x&&(this.formulario.cliente_bsale_id=x.id)}}catch(l){console.error("Error buscando cliente por RUT:",l)}finally{this.cargandoClientes=!1}},abrirCrearCliente(){this.dialogCrearCliente=!0},onClienteCreado(a){this.clientesBsale.unshift({...a,displayName:`${a.company||`${a.firstName||""} ${a.lastName||""}`.trim()||"Sin nombre"} - ${a.code}`}),this.formulario.cliente_bsale_id=a.id,this.$toast.success("Cliente creado exitosamente")},async generarDocumento(){var a,l,b,x,n,y,p;if(this.formValid){this.generandoDocumento=!0;try{const V={cotizacion_id:this.cotizacion.id,tipo_documento:this.formulario.tipo_documento,cliente_bsale_id:this.formulario.cliente_bsale_id,metodo_pago:this.formulario.metodo_pago,condiciones_pago:this.formulario.condiciones_pago,fecha_vencimiento:this.formulario.fecha_vencimiento,observaciones:this.formulario.observaciones},i=await X.post("/api/bsale/documento",V);if(i.data&&i.data.success){const T=i.data.documento,h=this.tiposDocumento.find(C=>C.id===this.formulario.tipo_documento);this.$toast.success(`${(h==null?void 0:h.name)||"Documento"} #${T.number} generado exitosamente
Total: $${(a=T.totalAmount)==null?void 0:a.toLocaleString("es-CL")}
ID BSALE: ${T.id}`,{timeout:8e3}),T.urlPdf&&this.$toast.info(`PDF disponible: ${T.urlPdf}`,{timeout:1e4,action:{text:"Abrir PDF",onClick:()=>window.open(T.urlPdf,"_blank")}}),this.$emit("documento-generado",T),this.cerrar()}else throw new Error(((l=i.data)==null?void 0:l.error)||((b=i.data)==null?void 0:b.message)||"Error desconocido")}catch(V){console.error("Error generando documento:",V);const i=((n=(x=V.response)==null?void 0:x.data)==null?void 0:n.error)||((p=(y=V.response)==null?void 0:y.data)==null?void 0:p.message)||V.message||"Error al generar documento";this.$toast.error(i)}finally{this.generandoDocumento=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var a;this.formulario={tipo_documento:null,oficina_id:null,cliente_bsale_id:null,metodo_pago:"transferencia",condiciones_pago:"30 días",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""},(a=this.$refs.form)==null||a.resetValidation()},getFechaVencimiento(){const a=new Date;return a.setDate(a.getDate()+30),a.toISOString().split("T")[0]},formatearPrecio(a){return new Intl.NumberFormat("es-CL").format(a)},formatearFecha(a){return a?new Date(a).toLocaleDateString("es-CL"):"N/A"}}},Ie={class:"mb-2"},Re={class:"mb-1"},Oe={class:"mb-1"},Ge={class:"mb-0"};function He(a,l,b,x,n,y){const p=ye("v-list-item-content"),V=Ue;return N(),O(ie,{modelValue:y.dialog,"onUpdate:modelValue":l[9]||(l[9]=i=>y.dialog=i),"max-width":"800px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(M,{class:"text-h5 pa-4"},{default:o(()=>[e(F,{class:"mr-2",color:"success"},{default:o(()=>l[10]||(l[10]=[c("mdi-receipt")])),_:1}),l[11]||(l[11]=c(" Generar Documento Electrónico "))]),_:1}),e(Q),e(I,{class:"pa-4"},{default:o(()=>[e(J,{class:"mb-4"},{default:o(()=>[e(_,{cols:"12"},{default:o(()=>[e(B,{outlined:"",class:"pa-3"},{default:o(()=>{var i,T,h,C,z;return[t("h4",Ie,"Cotización #"+u(((i=b.cotizacion)==null?void 0:i.numero)||"N/A"),1),t("p",Re,[l[12]||(l[12]=t("strong",null,"Cliente:",-1)),c(" "+u(((h=(T=b.cotizacion)==null?void 0:T.cliente)==null?void 0:h.nombre)||"N/A"),1)]),t("p",Oe,[l[13]||(l[13]=t("strong",null,"Total:",-1)),c(" $"+u(y.formatearPrecio(((C=b.cotizacion)==null?void 0:C.total)||0)),1)]),t("p",Ge,[l[14]||(l[14]=t("strong",null,"Fecha:",-1)),c(" "+u(y.formatearFecha((z=b.cotizacion)==null?void 0:z.created_at)),1)])]}),_:1})]),_:1})]),_:1}),e(ue,{ref:"form",modelValue:n.formValid,"onUpdate:modelValue":l[7]||(l[7]=i=>n.formValid=i)},{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:n.formulario.tipo_documento,"onUpdate:modelValue":l[0]||(l[0]=i=>n.formulario.tipo_documento=i),items:n.tiposDocumento,"item-value":"id","item-title":"name",label:"Tipo de documento",rules:[i=>!!i||"Tipo de documento es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-file-document"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:n.formulario.oficina_id,"onUpdate:modelValue":l[1]||(l[1]=i=>n.formulario.oficina_id=i),items:n.oficinas,"item-value":"id","item-title":"name",label:"Oficina",rules:[i=>!!i||"Oficina es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(De,{modelValue:n.formulario.cliente_bsale_id,"onUpdate:modelValue":l[2]||(l[2]=i=>n.formulario.cliente_bsale_id=i),items:n.clientesBsale,"item-value":"id","item-title":"displayName",label:"Cliente en BSALE","search-input":n.busquedaCliente,loading:n.cargandoClientes,rules:[i=>!!i||"Cliente BSALE es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-account",clearable:"","onUpdate:search":y.buscarClientes},{"no-data":o(()=>[e(le,null,{default:o(()=>[e(p,null,{default:o(()=>[e(te,null,{default:o(()=>l[15]||(l[15]=[c(" No se encontraron clientes ")])),_:1}),e(fe,null,{default:o(()=>[e(j,{color:"primary",text:"",small:"",onClick:y.abrirCrearCliente},{default:o(()=>l[16]||(l[16]=[c(" Crear cliente nuevo ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","items","search-input","loading","rules","onUpdate:search"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:n.formulario.metodo_pago,"onUpdate:modelValue":l[3]||(l[3]=i=>n.formulario.metodo_pago=i),items:n.metodosPago,"item-title":"text","item-value":"value",label:"Método de pago",outlined:"","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.condiciones_pago,"onUpdate:modelValue":l[4]||(l[4]=i=>n.formulario.condiciones_pago=i),label:"Condiciones de pago",outlined:"","prepend-inner-icon":"mdi-calendar-clock",placeholder:"Ej: 30 días"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:n.formulario.fecha_vencimiento,"onUpdate:modelValue":l[5]||(l[5]=i=>n.formulario.fecha_vencimiento=i),label:"Fecha de vencimiento",type:"date",outlined:"","prepend-inner-icon":"mdi-calendar"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(ke,{modelValue:n.formulario.observaciones,"onUpdate:modelValue":l[6]||(l[6]=i=>n.formulario.observaciones=i),label:"Observaciones",outlined:"",rows:"3","prepend-inner-icon":"mdi-note-text",placeholder:"Observaciones adicionales para el documento..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(Q),e(de,{class:"pa-4"},{default:o(()=>[e(ce),e(j,{color:"grey",text:"",onClick:y.cerrar,disabled:n.generandoDocumento},{default:o(()=>l[17]||(l[17]=[c(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(j,{color:"success",onClick:y.generarDocumento,loading:n.generandoDocumento,disabled:!n.formValid},{default:o(()=>[e(F,{left:""},{default:o(()=>l[18]||(l[18]=[c("mdi-receipt")])),_:1}),l[19]||(l[19]=c(" Generar Documento "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),e(V,{modelValue:n.dialogCrearCliente,"onUpdate:modelValue":l[8]||(l[8]=i=>n.dialogCrearCliente=i),cotizacion:b.cotizacion,onClienteCreado:y.onClienteCreado},null,8,["modelValue","cotizacion","onClienteCreado"])]),_:1},8,["modelValue"])}const Xe=we(Me,[["render",He],["__scopeId","data-v-42f30eb2"]]),Ze={__name:"CrearClienteBsale",props:{mostrar:Boolean},emits:["update:mostrar","cliente-creado"],setup(a,{emit:l}){const b=a,x=l,n=L(b.mostrar);se(()=>b.mostrar,h=>{n.value=h}),se(n,h=>{x("update:mostrar",h)});const y=L(!1),p=L(),V=L({nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}),i=async()=>{var C,z;const{valid:h}=await p.value.validate();if(h)try{y.value=!0;const G={nombre:V.value.nombre,apellido:V.value.apellido,empresa:V.value.empresa,rut:V.value.rut,giro:V.value.giro,email:V.value.email,telefono:V.value.telefono,direccion:V.value.direccion,enviar_email:V.value.enviar_email},{data:H}=await X.post("/api/bsale/crear-cliente",G);H.success&&(x("cliente-creado",H.cliente),T(),alert("Cliente creado exitosamente"))}catch(G){console.error("Error creando cliente:",G);const H=((z=(C=G.response)==null?void 0:C.data)==null?void 0:z.message)||"Error al crear cliente";alert(`❌ ${H}`)}finally{y.value=!1}},T=()=>{n.value=!1,V.value={nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}};return(h,C)=>(N(),O(ie,{modelValue:n.value,"onUpdate:modelValue":C[9]||(C[9]=z=>n.value=z),"max-width":"600px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>C[10]||(C[10]=[c("mdi-account-plus")])),_:1}),C[11]||(C[11]=c(" Crear Cliente en BSALE "))]),_:1}),e(Q),e(I,null,{default:o(()=>[e(ue,{ref_key:"formRef",ref:p,onSubmit:ze(i,["prevent"])},{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.nombre,"onUpdate:modelValue":C[0]||(C[0]=z=>V.value.nombre=z),label:"Nombre *",rules:[z=>!!z||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account",required:""},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.apellido,"onUpdate:modelValue":C[1]||(C[1]=z=>V.value.apellido=z),label:"Apellido",variant:"outlined","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(P,{modelValue:V.value.empresa,"onUpdate:modelValue":C[2]||(C[2]=z=>V.value.empresa=z),label:"Empresa",variant:"outlined","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.rut,"onUpdate:modelValue":C[3]||(C[3]=z=>V.value.rut=z),label:"RUT",variant:"outlined","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.giro,"onUpdate:modelValue":C[4]||(C[4]=z=>V.value.giro=z),label:"Giro",variant:"outlined","prepend-inner-icon":"mdi-briefcase"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.email,"onUpdate:modelValue":C[5]||(C[5]=z=>V.value.email=z),label:"Email",type:"email",variant:"outlined","prepend-inner-icon":"mdi-email"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:V.value.telefono,"onUpdate:modelValue":C[6]||(C[6]=z=>V.value.telefono=z),label:"Teléfono",variant:"outlined","prepend-inner-icon":"mdi-phone"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(P,{modelValue:V.value.direccion,"onUpdate:modelValue":C[7]||(C[7]=z=>V.value.direccion=z),label:"Dirección",variant:"outlined","prepend-inner-icon":"mdi-map-marker"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(Pe,{modelValue:V.value.enviar_email,"onUpdate:modelValue":C[8]||(C[8]=z=>V.value.enviar_email=z),label:"Enviar email de confirmación",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),e(de,null,{default:o(()=>[e(ce),e(j,{variant:"text",onClick:T,disabled:y.value},{default:o(()=>C[12]||(C[12]=[c(" Cancelar ")])),_:1},8,["disabled"]),e(j,{color:"primary",onClick:i,loading:y.value},{default:o(()=>[e(F,{start:""},{default:o(()=>C[13]||(C[13]=[c("mdi-account-plus")])),_:1}),C[14]||(C[14]=c(" Crear Cliente "))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Je={class:"d-flex justify-space-between align-center"},Ke={class:"text-caption"},Qe={class:"text-end"},We={class:"text-h6 text-success"},Ye={class:"text-caption"},eo={class:"text-body-2"},oo={class:"text-body-2"},lo={class:"text-h6 text-success mt-2"},to={__name:"ModalFacturacion",props:{mostrar:Boolean,cotizacion:Object},emits:["update:mostrar","documento-creado","actualizar-cotizacion"],setup(a,{emit:l}){const b=a,x=l,n=L(b.mostrar);se(()=>b.mostrar,k=>{n.value=k}),se(n,k=>{x("update:mostrar",k)});const y=L(!1),p=L(!1),V=L(""),i=L({tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}),T=L([{id:1,nombre:"Factura Afecta",descripcion:"Documento tributario con IVA"},{id:8,nombre:"Boleta Afecta",descripcion:"Para consumidores finales con IVA"},{id:9,nombre:"Guía de Despacho",descripcion:"Solo traslado de mercadería"},{id:12,nombre:"Nota de Venta",descripcion:"Documento interno de venta"}]),h=L([{id:1,nombre:"Efectivo"},{id:2,nombre:"Transferencia Bancaria"},{id:3,nombre:"Cheque"},{id:4,nombre:"Tarjeta de Crédito"},{id:5,nombre:"Tarjeta de Débito"}]),C=L([{nombre:"Contado",valor:"contado"},{nombre:"30 días",valor:"30_dias"},{nombre:"60 días",valor:"60_dias"},{nombre:"90 días",valor:"90_dias"}]),z=L([]),G=me(()=>new Date().toISOString().split("T")[0]),H=async(k="")=>{try{const{data:r}=await X.get("/api/bsale/clientes",{params:{search:k,limit:50}});r.success&&(z.value=(r.clientes.items||[]).map(f=>({...f,nombre_completo:f.company||`${f.firstName||""} ${f.lastName||""}`.trim()||"Sin nombre",rut:f.code||"Sin RUT",empresa:f.company||"Particular"})))}catch(r){console.error("Error buscando clientes:",r)}},D=async()=>{var k,r;try{y.value=!0;const f={cotizacion_id:b.cotizacion.id,tipo_documento:i.value.tipo_documento,metodo_pago:i.value.metodo_pago,condiciones_pago:i.value.condiciones_pago,fecha_vencimiento:i.value.fecha_vencimiento,cliente_bsale_id:i.value.cliente_bsale_id,observaciones:i.value.observaciones};console.log("Generando documento con payload:",f);const{data:d}=await X.post("/api/bsale/crear-documento",f);d.success&&(x("documento-creado",d.documento),x("actualizar-cotizacion",d.cotizacion),w(),alert(`✅ Documento generado exitosamente: ${d.documento.number}`))}catch(f){console.error("Error generando documento:",f);const d=((r=(k=f.response)==null?void 0:k.data)==null?void 0:r.message)||"Error al generar documento";alert(`❌ ${d}`)}finally{y.value=!1}},m=k=>{z.value.push({...k,nombre_completo:k.company||`${k.firstName||""} ${k.lastName||""}`.trim()||"Sin nombre"}),i.value.cliente_bsale_id=k.id},w=()=>{n.value=!1,i.value={tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}},g=k=>{const r=T.value.find(f=>f.id===k);return(r==null?void 0:r.nombre)||"Documento"},U=k=>{const r=h.value.find(f=>f.id===k);return(r==null?void 0:r.nombre)||"No especificado"},A=k=>{const r=C.value.find(f=>f.valor===k);return(r==null?void 0:r.nombre)||"No especificado"},R=()=>z.value.find(k=>k.id===i.value.cliente_bsale_id),Z=()=>{var r;const k=((r=b.cotizacion)==null?void 0:r.total)||0;return Math.round(k/1.19)},K=()=>Math.round(Z()*.19),W=()=>Z()+K();return se(()=>b.mostrar,k=>{k&&H("")}),(k,r)=>(N(),O(ie,{modelValue:n.value,"onUpdate:modelValue":r[8]||(r[8]=f=>n.value=f),"max-width":"800px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(M,{class:"text-h5 d-flex align-center"},{default:o(()=>[e(F,{color:"primary",class:"me-2"},{default:o(()=>r[9]||(r[9]=[c("mdi-file-document-plus")])),_:1}),r[10]||(r[10]=c(" Generar Documento Electrónico "))]),_:1}),e(Q),e(I,null,{default:o(()=>[e(Be,{color:"info",variant:"outlined",class:"mb-4"},{default:o(()=>{var f,d,s,E,v,S,q;return[t("div",Je,[t("div",null,[t("strong",null,"Cotización #"+u((f=a.cotizacion)==null?void 0:f.numero),1),r[11]||(r[11]=t("br",null,null,-1)),t("span",Ke,"Cliente: "+u((s=(d=a.cotizacion)==null?void 0:d.cliente)==null?void 0:s.nombre),1)]),t("div",Qe,[t("div",We,"$"+u((v=(E=a.cotizacion)==null?void 0:E.total)==null?void 0:v.toLocaleString()),1),t("span",Ye,u((q=(S=a.cotizacion)==null?void 0:S.ventanas)==null?void 0:q.length)+" ventanas",1)])])]}),_:1}),e(ue,{ref:"formRef",onSubmit:ze(D,["prevent"])},{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:i.value.tipo_documento,"onUpdate:modelValue":r[0]||(r[0]=f=>i.value.tipo_documento=f),items:T.value,"item-title":"nombre","item-value":"id",label:"Tipo de documento *",rules:[f=>!!f||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-file-document"},{item:o(({props:f,item:d})=>[e(le,_e(Ce(f)),{default:o(()=>[e(te,null,{default:o(()=>[c(u(d.raw.nombre),1)]),_:2},1024),e(fe,null,{default:o(()=>[c(u(d.raw.descripcion),1)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:i.value.metodo_pago,"onUpdate:modelValue":r[1]||(r[1]=f=>i.value.metodo_pago=f),items:h.value,"item-title":"nombre","item-value":"id",label:"Método de pago *",rules:[f=>!!f||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:i.value.condiciones_pago,"onUpdate:modelValue":r[2]||(r[2]=f=>i.value.condiciones_pago=f),items:C.value,"item-title":"nombre","item-value":"valor",label:"Condiciones de pago *",rules:[f=>!!f||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-calendar-clock"},null,8,["modelValue","items","rules"])]),_:1}),i.value.condiciones_pago!=="contado"?(N(),O(_,{key:0,cols:"12",md:"6"},{default:o(()=>[e(P,{modelValue:i.value.fecha_vencimiento,"onUpdate:modelValue":r[3]||(r[3]=f=>i.value.fecha_vencimiento=f),type:"date",label:"Fecha de vencimiento",variant:"outlined","prepend-inner-icon":"mdi-calendar",min:G.value},null,8,["modelValue","min"])]),_:1})):oe("",!0),e(_,{cols:"12"},{default:o(()=>[e(De,{modelValue:i.value.cliente_bsale_id,"onUpdate:modelValue":r[5]||(r[5]=f=>i.value.cliente_bsale_id=f),items:z.value,search:V.value,"item-title":"nombre_completo","item-value":"id",label:"Cliente en BSALE *",rules:[f=>!!f||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account","onUpdate:search":H,"no-data-text":"No se encontraron clientes"},{item:o(({props:f,item:d})=>[e(le,_e(Ce(f)),{default:o(()=>[e(te,null,{default:o(()=>[c(u(d.raw.nombre_completo),1)]),_:2},1024),e(fe,null,{default:o(()=>[c(u(d.raw.empresa)+" • "+u(d.raw.rut),1)]),_:2},1024)]),_:2},1040)]),append:o(()=>[e(j,{icon:"mdi-plus",variant:"text",size:"small",onClick:r[4]||(r[4]=f=>p.value=!0)})]),_:1},8,["modelValue","items","search","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(ke,{modelValue:i.value.observaciones,"onUpdate:modelValue":r[6]||(r[6]=f=>i.value.observaciones=f),label:"Observaciones (opcional)",variant:"outlined",rows:"3","prepend-inner-icon":"mdi-note-text",counter:"500",maxlength:"500"},null,8,["modelValue"])]),_:1})]),_:1}),i.value.tipo_documento&&i.value.cliente_bsale_id?(N(),O(B,{key:0,variant:"outlined",class:"mt-4"},{default:o(()=>[e(M,{class:"text-subtitle-1"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>r[12]||(r[12]=[c("mdi-eye")])),_:1}),r[13]||(r[13]=c(" Preview del documento "))]),_:1}),e(I,null,{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>{var f,d;return[t("div",eo,[t("strong",null,u(g(i.value.tipo_documento)),1),r[14]||(r[14]=t("br",null,null,-1)),r[15]||(r[15]=t("strong",null,"Cliente:",-1)),c(" "+u((f=R())==null?void 0:f.nombre_completo),1),r[16]||(r[16]=t("br",null,null,-1)),r[17]||(r[17]=t("strong",null,"RUT:",-1)),c(" "+u((d=R())==null?void 0:d.rut),1),r[18]||(r[18]=t("br",null,null,-1)),r[19]||(r[19]=t("strong",null,"Método de pago:",-1)),c(" "+u(U(i.value.metodo_pago)),1),r[20]||(r[20]=t("br",null,null,-1)),r[21]||(r[21]=t("strong",null,"Condiciones:",-1)),c(" "+u(A(i.value.condiciones_pago)),1)])]}),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>{var f,d;return[t("div",oo,[r[22]||(r[22]=t("strong",null,"Items:",-1)),c(" "+u(((d=(f=a.cotizacion)==null?void 0:f.ventanas)==null?void 0:d.length)||0)+" ventanas",1),r[23]||(r[23]=t("br",null,null,-1)),r[24]||(r[24]=t("strong",null,"Subtotal:",-1)),c(" $"+u(Z().toLocaleString()),1),r[25]||(r[25]=t("br",null,null,-1)),r[26]||(r[26]=t("strong",null,"IVA (19%):",-1)),c(" $"+u(K().toLocaleString()),1),r[27]||(r[27]=t("br",null,null,-1)),t("div",lo,[t("strong",null,"Total: $"+u(W().toLocaleString()),1)])])]}),_:1})]),_:1})]),_:1})]),_:1})):oe("",!0)]),_:1},512)]),_:1}),e(de,null,{default:o(()=>[e(ce),e(j,{color:"secondary",variant:"text",onClick:w,disabled:y.value},{default:o(()=>r[28]||(r[28]=[c(" Cancelar ")])),_:1},8,["disabled"]),e(j,{color:"primary",onClick:D,loading:y.value},{default:o(()=>[e(F,{start:""},{default:o(()=>r[29]||(r[29]=[c("mdi-file-document-plus")])),_:1}),r[30]||(r[30]=c(" Generar Documento "))]),_:1},8,["loading"])]),_:1})]),_:1}),e(Ze,{mostrar:p.value,"onUpdate:mostrar":r[7]||(r[7]=f=>p.value=f),onClienteCreado:m},null,8,["mostrar"])]),_:1},8,["modelValue"]))}},ao={class:"text-body-1 mb-2"},io={class:"text-body-2 text-medium-emphasis mb-1"},no={class:"text-body-2 text-medium-emphasis mb-1"},ro={class:"text-body-2 text-medium-emphasis"},so={class:"text-body-2 mb-1"},uo={class:"text-body-2 mb-1"},co={class:"text-body-2 mb-1"},mo={class:"text-body-2 mb-1"},fo={class:"text-body-2"},po={class:"text-success text-h6 ms-1"},vo={class:"font-weight-medium"},bo={key:0,class:"text-caption text-medium-emphasis"},go={class:"text-body-2"},Vo={class:"text-caption text-medium-emphasis"},_o={class:"text-body-2"},Co={class:"text-caption text-medium-emphasis"},xo={class:"font-weight-medium"},yo={class:"font-weight-bold text-success"},zo={class:"text-body-2"},wo={class:"text-body-2 d-flex justify-space-between mb-2"},Do={key:0,class:"text-body-2 d-flex justify-space-between mb-2"},ko={class:"text-error"},So={class:"text-h5 font-weight-bold text-success d-flex justify-space-between"},Uo={class:"text-caption text-medium-emphasis mt-2"},Eo={__name:"DetalleCotizacion",props:{cotizacion:Object},emits:["cerrar"],setup(a,{emit:l}){const b=a,x=L(!1),n=L(""),y=[{title:"Tipo",key:"tipo_ventana",sortable:!1},{title:"Dimensiones",key:"dimensiones",sortable:!1},{title:"Material/Color",key:"material_color",sortable:!1},{title:"Cantidad",key:"cantidad",sortable:!0},{title:"Precio Unit.",key:"precio_unitario",sortable:!0},{title:"Total",key:"total",sortable:!1},{title:"Imagen",key:"imagen",sortable:!1}],p=()=>{var w,g,U;const D=(U=(g=(w=b.cotizacion)==null?void 0:w.estado)==null?void 0:g.nombre)==null?void 0:U.toLowerCase();return{evaluación:"warning",aprobada:"success",rechazada:"error",facturada:"info",pagada:"primary"}[D]||"grey"},V=D=>D?new Date(D).toLocaleDateString("es-CL"):"-",i=D=>{const m=[];return D.hojas_totales&&m.push(`${D.hojas_totales} hojas`),D.hojas_moviles&&m.push(`${D.hojas_moviles} móviles`),m.join(", ")},T=(D,m)=>!D||!m?"0.00":(D*m/1e6).toFixed(2),h=D=>{const m=D.precio_unitario||D.precio||0,w=D.cantidad||1;return m*w},C=()=>{var D,m;return((m=(D=b.cotizacion)==null?void 0:D.ventanas)==null?void 0:m.reduce((w,g)=>w+h(g),0))||0},z=()=>{var D;return((D=b.cotizacion)==null?void 0:D.descuento_total)||0},G=D=>{n.value=H(D),x.value=!0},H=D=>D?`/storage/imagenes_ventanas/${D}`:"";return(D,m)=>(N(),O(B,{class:"ma-0"},{default:o(()=>[e(M,{class:"d-flex align-center justify-space-between"},{default:o(()=>{var w;return[t("div",null,[t("h2",null,"Detalle de Cotización #"+u((w=a.cotizacion)==null?void 0:w.id),1),e(ae,{color:p(),size:"small",class:"mt-2"},{default:o(()=>{var g,U;return[c(u((U=(g=a.cotizacion)==null?void 0:g.estado)==null?void 0:U.nombre),1)]}),_:1},8,["color"])]),e(j,{icon:"mdi-close",variant:"text",onClick:m[0]||(m[0]=g=>D.$emit("cerrar"))})]}),_:1}),e(Q),e(I,{class:"pa-6"},{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>m[3]||(m[3]=[c("mdi-account")])),_:1}),m[4]||(m[4]=c(" Información del Cliente "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U,A,R,Z,K,W;return[t("div",ao,[t("strong",null,u((g=(w=a.cotizacion)==null?void 0:w.cliente)==null?void 0:g.nombre),1)]),t("div",io," 📧 "+u(((A=(U=a.cotizacion)==null?void 0:U.cliente)==null?void 0:A.email)||"Sin email"),1),t("div",no," 📱 "+u(((Z=(R=a.cotizacion)==null?void 0:R.cliente)==null?void 0:Z.telefono)||"Sin teléfono"),1),t("div",ro," 🏠 "+u(((W=(K=a.cotizacion)==null?void 0:K.cliente)==null?void 0:W.direccion)||"Sin dirección"),1)]}),_:1})]),_:1})]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>m[5]||(m[5]=[c("mdi-file-document")])),_:1}),m[6]||(m[6]=c(" Datos de la Cotización "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U,A,R,Z;return[t("div",so,[m[7]||(m[7]=t("strong",null,"Número:",-1)),c(" #"+u((w=a.cotizacion)==null?void 0:w.id),1)]),t("div",uo,[m[8]||(m[8]=t("strong",null,"Fecha:",-1)),c(" "+u(V((g=a.cotizacion)==null?void 0:g.fecha)),1)]),t("div",co,[m[9]||(m[9]=t("strong",null,"Vendedor:",-1)),c(" "+u(((A=(U=a.cotizacion)==null?void 0:U.vendedor)==null?void 0:A.nombre)||"No asignado"),1)]),t("div",mo,[m[10]||(m[10]=t("strong",null,"Estado:",-1)),e(ae,{color:p(),size:"x-small",class:"ms-1"},{default:o(()=>{var K,W;return[c(u((W=(K=a.cotizacion)==null?void 0:K.estado)==null?void 0:W.nombre),1)]}),_:1},8,["color"])]),t("div",fo,[m[11]||(m[11]=t("strong",null,"Total:",-1)),t("span",po," $"+u((Z=(R=a.cotizacion)==null?void 0:R.total)==null?void 0:Z.toLocaleString()),1)])]}),_:1})]),_:1})]),_:1})]),_:1}),e(J,{class:"mt-4"},{default:o(()=>[e(_,{cols:"12"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>{var w,g;return[e(F,{class:"me-2"},{default:o(()=>m[12]||(m[12]=[c("mdi-window-closed-variant")])),_:1}),c(" Ventanas Cotizadas ("+u(((g=(w=a.cotizacion)==null?void 0:w.ventanas)==null?void 0:g.length)||0)+") ",1)]}),_:1}),e(I,null,{default:o(()=>{var w;return[e(Se,{headers:y,items:((w=a.cotizacion)==null?void 0:w.ventanas)||[],"item-value":"id",class:"elevation-0",density:"comfortable"},{"item.tipo_ventana":o(({item:g})=>{var U,A;return[t("div",null,[t("div",vo,u(((U=g.tipoVentana)==null?void 0:U.nombre)||((A=g.tipo_ventana)==null?void 0:A.nombre)),1),i(g)?(N(),ee("div",bo,u(i(g)),1)):oe("",!0)])]}),"item.dimensiones":o(({item:g})=>[t("div",go,[t("div",null,u(g.ancho)+"mm × "+u(g.alto)+"mm",1),t("div",Vo,u(T(g.ancho,g.alto))+" m² ",1)])]),"item.material_color":o(({item:g})=>{var U,A,R;return[t("div",_o,[t("div",null,u(((U=g.color)==null?void 0:U.nombre)||"Sin color"),1),t("div",Co,u(((R=(A=g.productoVidrioProveedor)==null?void 0:A.producto)==null?void 0:R.nombre)||"Sin vidrio"),1)])]}),"item.cantidad":o(({item:g})=>[e(ae,{size:"small",color:"primary",variant:"outlined"},{default:o(()=>[c(u(g.cantidad),1)]),_:2},1024)]),"item.precio_unitario":o(({item:g})=>[t("div",xo," $"+u((g.precio_unitario||g.precio||0).toLocaleString()),1)]),"item.total":o(({item:g})=>[t("div",yo," $"+u(h(g).toLocaleString()),1)]),"item.imagen":o(({item:g})=>[g.imagen?(N(),O(Fe,{key:0,size:"40",class:"cursor-pointer",onClick:U=>G(g.imagen)},{default:o(()=>[e(xe,{src:H(g.imagen),cover:""},null,8,["src"])]),_:2},1032,["onClick"])):(N(),O(F,{key:1,color:"grey-lighten-1"},{default:o(()=>m[13]||(m[13]=[c("mdi-image-off")])),_:1}))]),_:1},8,["items"])]}),_:1})]),_:1})]),_:1})]),_:1}),e(J,{class:"mt-4"},{default:o(()=>[e(_,{cols:"12",md:"8"},{default:o(()=>{var w;return[(w=a.cotizacion)!=null&&w.observaciones?(N(),O(B,{key:0,variant:"outlined"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>m[14]||(m[14]=[c("mdi-note-text")])),_:1}),m[15]||(m[15]=c(" Observaciones "))]),_:1}),e(I,null,{default:o(()=>[t("p",zo,u(a.cotizacion.observaciones),1)]),_:1})]),_:1})):oe("",!0)]}),_:1}),e(_,{cols:"12",md:"4"},{default:o(()=>[e(B,{variant:"outlined",color:"success",class:"text-center"},{default:o(()=>[e(M,{class:"text-h6"},{default:o(()=>[e(F,{class:"me-2"},{default:o(()=>m[16]||(m[16]=[c("mdi-calculator")])),_:1}),m[17]||(m[17]=c(" Resumen Total "))]),_:1}),e(I,null,{default:o(()=>{var w,g,U;return[t("div",wo,[m[18]||(m[18]=t("span",null,"Subtotal:",-1)),t("span",null,"$"+u(C().toLocaleString()),1)]),z()>0?(N(),ee("div",Do,[m[19]||(m[19]=t("span",null,"Descuento:",-1)),t("span",ko,"-$"+u(z().toLocaleString()),1)])):oe("",!0),e(Q,{class:"my-3"}),t("div",So,[m[20]||(m[20]=t("span",null,"Total:",-1)),t("span",null,"$"+u((((w=a.cotizacion)==null?void 0:w.total)||0).toLocaleString()),1)]),t("div",Uo,u(((U=(g=a.cotizacion)==null?void 0:g.ventanas)==null?void 0:U.length)||0)+" ventanas ",1)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ie,{modelValue:x.value,"onUpdate:modelValue":m[2]||(m[2]=w=>x.value=w),"max-width":"800px"},{default:o(()=>[e(B,null,{default:o(()=>[e(M,{class:"d-flex justify-space-between align-center"},{default:o(()=>[m[21]||(m[21]=c(" Imagen de Ventana ")),e(j,{icon:"mdi-close",variant:"text",onClick:m[1]||(m[1]=w=>x.value=!1)})]),_:1}),e(I,{class:"text-center"},{default:o(()=>[e(xe,{src:n.value,"max-height":"500",contain:""},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},Lo={class:"d-flex align-center"},ho={key:0},$o={class:"font-weight-medium"},To={class:"text-caption text-medium-emphasis"},No={key:1,class:"text-caption text-medium-emphasis"},Po={class:"font-weight-bold text-success"},Bo={class:"text-caption"},Fo={class:"d-flex gap-2"},jo=["colspan"],Ao={class:"pa-4"},qo={class:"mb-3"},Mo={class:"font-weight-bold"},Io={class:"d-flex justify-space-between mb-2"},Ro={class:"d-flex justify-space-between mb-2"},Oo={class:"text-error"},Go={class:"d-flex justify-space-between font-weight-bold"},Ho={class:"text-success"},Xo={class:"d-flex justify-space-between align-center pa-4"},Zo={class:"text-caption"},wl={__name:"index",setup(a){const l=L(!1),b=L([]),x=L(!1),n=L(!1),y=L(!1),p=L(null),V=L(10),i=L({busqueda:"",estado:null,cliente:null}),T=[{title:"Número",key:"numero",sortable:!0},{title:"Cliente",key:"cliente",sortable:!1},{title:"Total",key:"total",sortable:!0},{title:"Estado",key:"estado_facturacion",sortable:!0},{title:"Fecha aprobación",key:"fecha_aprobacion",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,width:"200px"}],h=[{title:"Aprobada (Por facturar)",value:"aprobada"},{title:"Facturada",value:"facturada"},{title:"Pagada",value:"pagada"},{title:"Anulada",value:"anulada"}],C=me(()=>b.value.map(s=>s.cliente).filter((s,E,v)=>s&&v.findIndex(S=>S.id===s.id)===E)),z=me(()=>{let d=[...b.value];if(i.value.busqueda){const s=i.value.busqueda.toLowerCase();d=d.filter(E=>{var v,S,q,$,ne,re,pe,ve,be,ge,Ve;return((v=E.numero)==null?void 0:v.toString().includes(s))||((q=(S=E.cliente)==null?void 0:S.razon_social)==null?void 0:q.toLowerCase().includes(s))||((ne=($=E.cliente)==null?void 0:$.first_name)==null?void 0:ne.toLowerCase().includes(s))||((pe=(re=E.cliente)==null?void 0:re.last_name)==null?void 0:pe.toLowerCase().includes(s))||((be=(ve=E.cliente)==null?void 0:ve.identification)==null?void 0:be.toLowerCase().includes(s))||((Ve=(ge=E.cliente)==null?void 0:ge.email)==null?void 0:Ve.toLowerCase().includes(s))})}return i.value.estado&&(d=d.filter(s=>s.estado_facturacion===i.value.estado)),i.value.cliente&&(d=d.filter(s=>{var E;return((E=s.cliente)==null?void 0:E.id)===i.value.cliente})),d}),G=async()=>{var d,s,E,v,S,q;try{l.value=!0,console.log("🔍 Intentando cargar cotizaciones desde:","/api/cotizaciones/aprobadas");const{data:$}=await X.get("/api/cotizaciones/aprobadas");console.log("✅ Respuesta recibida:",$),b.value=$.cotizaciones||[],console.log("📊 Cotizaciones cargadas:",b.value.length)}catch($){console.error("❌ Error cargando cotizaciones:",$),console.error("📍 URL intentada:",(d=$.config)==null?void 0:d.url),console.error("🔢 Status:",(s=$.response)==null?void 0:s.status),console.error("📝 Mensaje:",(E=$.response)==null?void 0:E.data),alert(`Error: ${(v=$.response)==null?void 0:v.status} - ${((q=(S=$.response)==null?void 0:S.data)==null?void 0:q.message)||"Error desconocido"}`)}finally{l.value=!1}},H=d=>{p.value=d,y.value=!0},D=d=>{console.log("Documento creado:",d),G()},m=d=>{const s=b.value.findIndex(E=>E.id===d.id);s!==-1&&(b.value[s]=d)},w=d=>{console.log("Duplicar cotización:",d.id)},g=async d=>{if(confirm(`¿Estás seguro de eliminar la cotización #${d.numero}?`))try{await X.delete(`/api/cotizaciones/${d.id}`),b.value=b.value.filter(s=>s.id!==d.id)}catch(s){console.error("Error eliminando cotización:",s)}},U=()=>{i.value={busqueda:"",estado:null,cliente:null}},A=d=>({aprobada:"warning",facturada:"success",pagada:"primary",anulada:"error"})[d]||"grey",R=d=>({aprobada:"Por facturar",facturada:"Facturada",pagada:"Pagada",anulada:"Anulada"})[d]||d,Z=d=>d?new Date(d).toLocaleDateString("es-CL"):"-",K=d=>{var s;return((s=d.ventanas)==null?void 0:s.reduce((E,v)=>E+v.precio_unitario*v.cantidad,0))||0},W=d=>{p.value=d,x.value=!0},k=async d=>{try{await G(),console.log("Documento generado exitosamente:",d)}catch(s){console.error("Error recargando datos:",s)}},r=async d=>{if(d.url_pdf_bsale){window.open(d.url_pdf_bsale,"_blank");return}if(d.id_documento_bsale)try{const s=await X.get(`/api/bsale/documento/${d.id_documento_bsale}/pdf`);s.data.success&&s.data.pdf_url?window.open(s.data.pdf_url,"_blank"):console.error("No se pudo obtener el PDF del documento")}catch(s){console.error("Error obteniendo PDF:",s)}},f=d=>d.descuento_total||0;return Ee(()=>{G()}),(d,s)=>{const E=ye("v-simple-table");return N(),ee("div",null,[e(B,{class:"mb-6"},{default:o(()=>[e(M,{class:"d-flex align-center justify-space-between"},{default:o(()=>[s[8]||(s[8]=t("div",null,[t("h1",{class:"text-h4 mb-2"},"📄 Facturación"),t("p",{class:"text-subtitle-1 text-medium-emphasis"}," Gestiona las cotizaciones aprobadas y genera documentos electrónicos ")],-1)),e(ae,{color:"primary",variant:"elevated",size:"large"},{default:o(()=>[c(u(b.value.length)+" por facturar ",1)]),_:1})]),_:1})]),_:1}),e(B,{class:"mb-4"},{default:o(()=>[e(I,null,{default:o(()=>[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"4"},{default:o(()=>[e(P,{modelValue:i.value.busqueda,"onUpdate:modelValue":s[0]||(s[0]=v=>i.value.busqueda=v),label:"Buscar cotización...","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"3"},{default:o(()=>[e(Y,{modelValue:i.value.estado,"onUpdate:modelValue":s[1]||(s[1]=v=>i.value.estado=v),items:h,label:"Estado",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"3"},{default:o(()=>[e(Y,{modelValue:i.value.cliente,"onUpdate:modelValue":s[2]||(s[2]=v=>i.value.cliente=v),items:C.value,"item-title":"nombre","item-value":"id",label:"Cliente",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue","items"])]),_:1}),e(_,{cols:"12",md:"2"},{default:o(()=>[e(j,{color:"primary",variant:"outlined",block:"",onClick:U},{default:o(()=>s[9]||(s[9]=[c(" Limpiar filtros ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(B,null,{default:o(()=>[e(Se,{"items-per-page":V.value,"onUpdate:itemsPerPage":s[3]||(s[3]=v=>V.value=v),headers:T,items:z.value,loading:l.value,class:"elevation-1","item-value":"id","show-expand":"","expand-on-click":""},{"item.numero":o(({item:v})=>[t("div",Lo,[e(ae,{color:"primary",variant:"outlined",size:"small",class:"me-2"},{default:o(()=>[c(" #"+u(v.id),1)]),_:2},1024)])]),"item.cliente":o(({item:v})=>[v.cliente?(N(),ee("div",ho,[t("div",$o,u(v.cliente.razon_social||`${v.cliente.first_name||""} ${v.cliente.last_name||""}`.trim()||"Sin nombre"),1),t("div",To,u(v.cliente.email||v.cliente.identification),1)])):(N(),ee("div",No," Sin cliente "))]),"item.total":o(({item:v})=>{var S;return[t("div",Po," $"+u((S=v.total)==null?void 0:S.toLocaleString()),1)]}),"item.estado_facturacion":o(({item:v})=>[e(ae,{color:A(v.estado_facturacion),variant:v.estado_facturacion==="aprobada"?"elevated":"outlined",size:"small"},{default:o(()=>[c(u(R(v.estado_facturacion)),1)]),_:2},1032,["color","variant"])]),"item.fecha_aprobacion":o(({item:v})=>[t("div",Bo,u(Z(v.fecha_aprobacion)),1)]),"item.acciones":o(({item:v})=>[t("div",Fo,[v.estado_facturacion==="aprobada"?(N(),O(j,{key:0,color:"success",variant:"elevated",size:"small",onClick:S=>W(v)},{default:o(()=>[e(F,{start:""},{default:o(()=>s[10]||(s[10]=[c("mdi-receipt")])),_:1}),s[11]||(s[11]=c(" Generar Documento "))]),_:2},1032,["onClick"])):v.estado_facturacion==="facturada"?(N(),O(j,{key:1,color:"info",variant:"outlined",size:"small",onClick:S=>r(v)},{default:o(()=>[e(F,{start:""},{default:o(()=>s[12]||(s[12]=[c("mdi-file-pdf-box")])),_:1}),s[13]||(s[13]=c(" Descargar Documento "))]),_:2},1032,["onClick"])):oe("",!0),e(je,null,{activator:o(({props:S})=>[e(j,$e(S,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:o(()=>[e(Ne,null,{default:o(()=>[e(le,{onClick:S=>H(v)},{default:o(()=>[e(te,null,{default:o(()=>s[14]||(s[14]=[c("Ver detalle")])),_:1})]),_:2},1032,["onClick"]),e(le,{onClick:S=>w(v)},{default:o(()=>[e(te,null,{default:o(()=>s[15]||(s[15]=[c("Duplicar")])),_:1})]),_:2},1032,["onClick"]),e(Q),e(le,{onClick:S=>g(v),class:"text-error"},{default:o(()=>[e(te,null,{default:o(()=>s[16]||(s[16]=[c("Eliminar")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)])]),"expanded-row":o(({columns:v,item:S})=>[t("tr",null,[t("td",{colspan:v.length},[t("div",Ao,[e(J,null,{default:o(()=>[e(_,{cols:"12",md:"8"},{default:o(()=>{var q;return[t("h4",qo,"Ventanas cotizadas ("+u(((q=S.ventanas)==null?void 0:q.length)||0)+")",1),e(E,{dense:""},{default:o(()=>[s[17]||(s[17]=t("thead",null,[t("tr",null,[t("th",null,"Tipo"),t("th",null,"Dimensiones"),t("th",null,"Cantidad"),t("th",null,"Precio unitario"),t("th",null,"Total")])],-1)),t("tbody",null,[(N(!0),ee(Le,null,he(S.ventanas,$=>{var ne,re;return N(),ee("tr",{key:$.id},[t("td",null,u((ne=$.tipo_ventana)==null?void 0:ne.nombre),1),t("td",null,u($.ancho)+"mm × "+u($.alto)+"mm",1),t("td",null,u($.cantidad),1),t("td",null,"$"+u((re=$.precio_unitario)==null?void 0:re.toLocaleString()),1),t("td",Mo," $"+u(($.precio_unitario*$.cantidad).toLocaleString()),1)])}),128))])]),_:2},1024)]}),_:2},1024),e(_,{cols:"12",md:"4"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(M,{class:"text-subtitle-1"},{default:o(()=>s[18]||(s[18]=[c("Resumen")])),_:1}),e(I,null,{default:o(()=>{var q;return[t("div",Io,[s[19]||(s[19]=t("span",null,"Subtotal:",-1)),t("span",null,"$"+u(K(S).toLocaleString()),1)]),t("div",Ro,[s[20]||(s[20]=t("span",null,"Descuento:",-1)),t("span",Oo,"-$"+u(f(S).toLocaleString()),1)]),e(Q,{class:"my-2"}),t("div",Go,[s[21]||(s[21]=t("span",null,"Total:",-1)),t("span",Ho,"$"+u((q=S.total)==null?void 0:q.toLocaleString()),1)])]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)])],8,jo)])]),bottom:o(()=>[t("div",Xo,[t("div",Zo," Mostrando "+u(z.value.length)+" de "+u(b.value.length)+" cotizaciones ",1)])]),_:1},8,["items-per-page","items","loading"])]),_:1}),e(Xe,{modelValue:x.value,"onUpdate:modelValue":s[4]||(s[4]=v=>x.value=v),cotizacion:p.value,onDocumentoGenerado:k},null,8,["modelValue","cotizacion"]),e(to,{mostrar:n.value,"onUpdate:mostrar":s[5]||(s[5]=v=>n.value=v),cotizacion:p.value,onDocumentoCreado:D,onActualizarCotizacion:m},null,8,["mostrar","cotizacion"]),e(ie,{modelValue:y.value,"onUpdate:modelValue":s[7]||(s[7]=v=>y.value=v),"max-width":"1200px"},{default:o(()=>[y.value?(N(),O(Eo,{key:0,cotizacion:p.value,onCerrar:s[6]||(s[6]=v=>y.value=!1)},null,8,["cotizacion"])):oe("",!0)]),_:1},8,["modelValue"])])}}};export{wl as default};
