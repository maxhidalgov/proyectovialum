import{au as K,f as R,e as o,b as e,t as u,Z as h,a3 as j,o as F,d as l,v as d,a as ge,r as L,w as ie,a2 as Ve,X as me,m as ee,aH as pe,aI as ve,c as re,E as we,F as De,i as ke,q as Se}from"./index-BfHK3Q1m.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{b as q,c as se,V as B}from"./VCard-CeWeuS--.js";import{V as Q}from"./VDivider-BMdVogXq.js";import{V as M}from"./VCardText-B4Mq7kh7.js";import{V as de}from"./VForm-BCZ54E_S.js";import{V as Z,a as _}from"./VRow-FHbQ1uF8.js";import{V as $}from"./VTextField-DUDAFiaD.js";import{V as Y}from"./VSelect-Bru95xj0.js";import{V as Ue}from"./VCheckbox-BVONcfKb.js";import{V as ue}from"./VSpacer-BBog07qM.js";import{V as ae}from"./VDialog-kJxhWykV.js";import{V as Ce}from"./VAutocomplete-DQe_60_J.js";import{a as oe,b as le,d as ce,V as Ee}from"./VList-CUKKD17n.js";import{V as xe}from"./VTextarea-DX7rE1a5.js";import{V as Le}from"./VSwitch-Dj_9uaBK.js";import{V as Te}from"./VAlert-Dp9qQ6_Z.js";import{V as te}from"./VChip-nFHlPbg4.js";import{V as ye}from"./VDataTable-BApvmJuw.js";import{V as $e}from"./VAvatar-OHED_78t.js";import{V as be}from"./VImg-BTfg3y8o.js";import{V as Fe}from"./VMenu-B5gVqthR.js";import"./VInput-DlSFRFZH.js";import"./transition-GFg5pKwE.js";import"./forwardRefs-DWGaNmQL.js";/* empty css              */import"./VOverlay-DTAHoqYd.js";import"./VCheckboxBtn-Bv0I6RVb.js";import"./VSelectionControl-WLLpsEUg.js";const Ne={name:"ModalCrearClienteBsale",props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","cliente-creado"],data(){return{formValid:!1,creandoCliente:!1,comunas:[{id:1,name:"Santiago"},{id:2,name:"Las Condes"},{id:3,name:"Providencia"},{id:4,name:"√ëu√±oa"},{id:5,name:"La Reina"},{id:6,name:"Vitacura"},{id:7,name:"Lo Barnechea"},{id:8,name:"Maip√∫"},{id:9,name:"Puente Alto"},{id:10,name:"La Florida"}],formulario:{nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},emailRules:[r=>!r||/.+@.+\..+/.test(r)||"Email debe ser v√°lido"]}},computed:{dialog:{get(){return this.modelValue},set(r){this.$emit("update:modelValue",r)}}},watch:{dialog(r){r&&this.cotizacion&&this.precargarDatos()}},methods:{precargarDatos(){var r;if((r=this.cotizacion)!=null&&r.cliente){const t=this.cotizacion.cliente;this.formulario.nombre=t.nombre||"",this.formulario.rut=t.rut||"",this.formulario.email=t.email||"",this.formulario.telefono=t.telefono||"",this.formulario.direccion=t.direccion||"",this.formulario.giro="Comercio al por menor"}},async crearCliente(){var r,t;if(this.formValid){this.creandoCliente=!0;try{const b={nombre:this.formulario.nombre,apellido:this.formulario.apellido,rut:this.formulario.rut,email:this.formulario.email,telefono:this.formulario.telefono,empresa:this.formulario.empresa,giro:this.formulario.giro,direccion:this.formulario.direccion,comuna_id:this.formulario.comuna_id,enviar_email:this.formulario.enviar_email},z=await K.post("/api/bsale/clientes",b);if(z.data.success)this.$emit("cliente-creado",z.data.cliente),this.cerrar();else throw new Error(z.data.error||"Error desconocido")}catch(b){console.error("Error creando cliente:",b);const z=((t=(r=b.response)==null?void 0:r.data)==null?void 0:t.error)||b.message||"Error al crear cliente";this.$toast.error(z)}finally{this.creandoCliente=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var r;this.formulario={nombre:"",apellido:"",rut:"",email:"",telefono:"",empresa:"",giro:"",direccion:"",comuna_id:1,enviar_email:!1},(r=this.$refs.form)==null||r.resetValidation()}}};function Pe(r,t,b,z,a,x){return F(),R(ae,{modelValue:x.dialog,"onUpdate:modelValue":t[11]||(t[11]=f=>x.dialog=f),"max-width":"600px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(q,{class:"text-h5 pa-4"},{default:o(()=>[e(h,{class:"mr-2",color:"primary"},{default:o(()=>t[12]||(t[12]=[u("mdi-account-plus")])),_:1}),t[13]||(t[13]=u(" Crear Cliente en BSALE "))]),_:1}),e(Q),e(M,{class:"pa-4"},{default:o(()=>[e(de,{ref:"form",modelValue:a.formValid,"onUpdate:modelValue":t[10]||(t[10]=f=>a.formValid=f)},{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.nombre,"onUpdate:modelValue":t[0]||(t[0]=f=>a.formulario.nombre=f),label:"Nombre",rules:[f=>!!f||"Nombre es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.apellido,"onUpdate:modelValue":t[1]||(t[1]=f=>a.formulario.apellido=f),label:"Apellido",outlined:"","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.rut,"onUpdate:modelValue":t[2]||(t[2]=f=>a.formulario.rut=f),label:"RUT",rules:[f=>!!f||"RUT es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.email,"onUpdate:modelValue":t[3]||(t[3]=f=>a.formulario.email=f),label:"Email",type:"email",rules:a.emailRules,outlined:"","prepend-inner-icon":"mdi-email"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.telefono,"onUpdate:modelValue":t[4]||(t[4]=f=>a.formulario.telefono=f),label:"Tel√©fono",outlined:"","prepend-inner-icon":"mdi-phone",placeholder:"+56 9 1234 5678"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.empresa,"onUpdate:modelValue":t[5]||(t[5]=f=>a.formulario.empresa=f),label:"Empresa",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e($,{modelValue:a.formulario.giro,"onUpdate:modelValue":t[6]||(t[6]=f=>a.formulario.giro=f),label:"Giro/Actividad",rules:[f=>!!f||"Giro es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-briefcase",placeholder:"Ej: Comercio al por menor"},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e($,{modelValue:a.formulario.direccion,"onUpdate:modelValue":t[7]||(t[7]=f=>a.formulario.direccion=f),label:"Direcci√≥n",outlined:"","prepend-inner-icon":"mdi-map-marker",placeholder:"Ej: Av. Principal 123"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:a.formulario.comuna_id,"onUpdate:modelValue":t[8]||(t[8]=f=>a.formulario.comuna_id=f),items:a.comunas,"item-value":"id","item-title":"name",label:"Comuna",rules:[f=>!!f||"Comuna es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-city"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(Ue,{modelValue:a.formulario.enviar_email,"onUpdate:modelValue":t[9]||(t[9]=f=>a.formulario.enviar_email=f),label:"Enviar email de bienvenida al cliente",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(Q),e(se,{class:"pa-4"},{default:o(()=>[e(ue),e(j,{color:"grey",text:"",onClick:x.cerrar,disabled:a.creandoCliente},{default:o(()=>t[14]||(t[14]=[u(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(j,{color:"primary",onClick:x.crearCliente,loading:a.creandoCliente,disabled:!a.formValid},{default:o(()=>[e(h,{left:""},{default:o(()=>t[15]||(t[15]=[u("mdi-account-plus")])),_:1}),t[16]||(t[16]=u(" Crear Cliente "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}const ze=_e(Ne,[["render",Pe],["__scopeId","data-v-99c8a3e8"]]),Be={name:"ModalBsale",components:{ModalCrearClienteBsale:ze},props:{modelValue:{type:Boolean,default:!1},cotizacion:{type:Object,default:null}},emits:["update:modelValue","documento-generado"],data(){return{formValid:!1,generandoDocumento:!1,cargandoClientes:!1,busquedaCliente:"",dialogCrearCliente:!1,tiposDocumento:[{id:3,name:"Nota de Venta",codeSii:"",description:"Documento de preventa"},{id:5,name:"Factura Electr√≥nica",codeSii:"33",description:"Documento tributario electr√≥nico"},{id:1,name:"Boleta Electr√≥nica",codeSii:"39",description:"Boleta electr√≥nica para consumidor final"}],oficinas:[],clientesBsale:[],metodosPago:[{text:"Efectivo",value:"efectivo"},{text:"Transferencia",value:"transferencia"},{text:"Cheque",value:"cheque"},{text:"Tarjeta de Cr√©dito",value:"tarjeta_credito"},{text:"Tarjeta de D√©bito",value:"tarjeta_debito"}],formulario:{tipo_documento:null,oficina_id:null,cliente_bsale_id:null,metodo_pago:"transferencia",condiciones_pago:"30 d√≠as",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""}}},computed:{dialog:{get(){return this.modelValue},set(r){this.$emit("update:modelValue",r)}}},watch:{dialog(r){r&&this.cargarDatosIniciales()}},methods:{async cargarDatosIniciales(){var r,t,b,z,a,x,f;console.log("üîÑ Cargando datos iniciales BSALE...");try{((t=(r=this.cotizacion)==null?void 0:r.cliente)!=null&&t.rut||(z=(b=this.cotizacion)==null?void 0:b.cliente)!=null&&z.identification)&&await this.buscarClientesPorRut(this.cotizacion.cliente.rut||this.cotizacion.cliente.identification),console.log("‚úÖ Datos iniciales cargados correctamente")}catch(V){console.error("‚ùå Error cargando datos iniciales:",V),console.error("Response:",(a=V.response)==null?void 0:a.data),console.error("Status:",(x=V.response)==null?void 0:x.status),console.error("URL:",(f=V.config)==null?void 0:f.url),alert("Error al cargar datos de BSALE: "+(V.message||"Error desconocido"))}},async buscarClientes(r){var t;if(!(!r||r.length<2)){this.cargandoClientes=!0;try{const b=await K.get("/api/bsale/clientes",{params:{search:r}});b.data.success&&(this.clientesBsale=((t=b.data.clientes.items)==null?void 0:t.map(z=>({...z,displayName:`${z.firstName} ${z.lastName} - ${z.code}`})))||[])}catch(b){console.error("Error buscando clientes:",b)}finally{this.cargandoClientes=!1}}},async buscarClientesPorRut(r){this.cargandoClientes=!0;try{const t=await K.get("/api/bsale/clientes",{params:{search:r}});if(t.data.success){const b=t.data.clientes.items||[];this.clientesBsale=b.map(a=>({...a,displayName:`${a.firstName} ${a.lastName} - ${a.code}`}));const z=b.find(a=>a.code===r);z&&(this.formulario.cliente_bsale_id=z.id)}}catch(t){console.error("Error buscando cliente por RUT:",t)}finally{this.cargandoClientes=!1}},abrirCrearCliente(){this.dialogCrearCliente=!0},onClienteCreado(r){this.clientesBsale.unshift({...r,displayName:`${r.firstName} ${r.lastName} - ${r.code}`}),this.formulario.cliente_bsale_id=r.id,this.$toast.success("Cliente creado exitosamente")},async generarDocumento(){var r,t,b,z;if(this.formValid){this.generandoDocumento=!0;try{const a={cotizacion_id:this.cotizacion.id,tipo_documento:this.formulario.tipo_documento,cliente_bsale_id:this.formulario.cliente_bsale_id,metodo_pago:this.formulario.metodo_pago,condiciones_pago:this.formulario.condiciones_pago,fecha_vencimiento:this.formulario.fecha_vencimiento,observaciones:this.formulario.observaciones},x=await K.post("/api/bsale/documento",a);if(x.data&&x.data.success){const f=x.data.data,V=this.tiposDocumento.find(s=>s.id===this.formulario.tipo_documento);this.$toast.success(`${(V==null?void 0:V.name)||"Documento"} #${f.number} generado exitosamente
Total: $${(r=f.totalAmount)==null?void 0:r.toLocaleString("es-CL")}
ID BSALE: ${f.id}`,{timeout:8e3}),f.urlPdf&&this.$toast.info(`PDF disponible: ${f.urlPdf}`,{timeout:1e4,action:{text:"Abrir PDF",onClick:()=>window.open(f.urlPdf,"_blank")}}),this.$emit("documento-generado",f),this.cerrar()}else throw new Error(((t=x.data)==null?void 0:t.error)||"Error desconocido")}catch(a){console.error("Error generando documento:",a);const x=((z=(b=a.response)==null?void 0:b.data)==null?void 0:z.error)||a.message||"Error al generar documento";this.$toast.error(x)}finally{this.generandoDocumento=!1}}},cerrar(){this.dialog=!1,this.resetearFormulario()},resetearFormulario(){var r;this.formulario={tipo_documento:null,oficina_id:null,cliente_bsale_id:null,metodo_pago:"transferencia",condiciones_pago:"30 d√≠as",fecha_vencimiento:this.getFechaVencimiento(),observaciones:""},(r=this.$refs.form)==null||r.resetValidation()},getFechaVencimiento(){const r=new Date;return r.setDate(r.getDate()+30),r.toISOString().split("T")[0]},formatearPrecio(r){return new Intl.NumberFormat("es-CL").format(r)},formatearFecha(r){return r?new Date(r).toLocaleDateString("es-CL"):"N/A"}}},he={class:"mb-2"},je={class:"mb-1"},Ae={class:"mb-1"},qe={class:"mb-0"};function Me(r,t,b,z,a,x){const f=ge("v-list-item-content"),V=ze;return F(),R(ae,{modelValue:x.dialog,"onUpdate:modelValue":t[9]||(t[9]=s=>x.dialog=s),"max-width":"800px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(q,{class:"text-h5 pa-4"},{default:o(()=>[e(h,{class:"mr-2",color:"success"},{default:o(()=>t[10]||(t[10]=[u("mdi-receipt")])),_:1}),t[11]||(t[11]=u(" Generar Documento Electr√≥nico "))]),_:1}),e(Q),e(M,{class:"pa-4"},{default:o(()=>[e(Z,{class:"mb-4"},{default:o(()=>[e(_,{cols:"12"},{default:o(()=>[e(B,{outlined:"",class:"pa-3"},{default:o(()=>{var s,G,N,C,y;return[l("h4",he,"Cotizaci√≥n #"+d(((s=b.cotizacion)==null?void 0:s.numero)||"N/A"),1),l("p",je,[t[12]||(t[12]=l("strong",null,"Cliente:",-1)),u(" "+d(((N=(G=b.cotizacion)==null?void 0:G.cliente)==null?void 0:N.nombre)||"N/A"),1)]),l("p",Ae,[t[13]||(t[13]=l("strong",null,"Total:",-1)),u(" $"+d(x.formatearPrecio(((C=b.cotizacion)==null?void 0:C.total)||0)),1)]),l("p",qe,[t[14]||(t[14]=l("strong",null,"Fecha:",-1)),u(" "+d(x.formatearFecha((y=b.cotizacion)==null?void 0:y.created_at)),1)])]}),_:1})]),_:1})]),_:1}),e(de,{ref:"form",modelValue:a.formValid,"onUpdate:modelValue":t[7]||(t[7]=s=>a.formValid=s)},{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:a.formulario.tipo_documento,"onUpdate:modelValue":t[0]||(t[0]=s=>a.formulario.tipo_documento=s),items:a.tiposDocumento,"item-value":"id","item-title":"name",label:"Tipo de documento",rules:[s=>!!s||"Tipo de documento es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-file-document"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:a.formulario.oficina_id,"onUpdate:modelValue":t[1]||(t[1]=s=>a.formulario.oficina_id=s),items:a.oficinas,"item-value":"id","item-title":"name",label:"Oficina",rules:[s=>!!s||"Oficina es requerida"],required:"",outlined:"","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(Ce,{modelValue:a.formulario.cliente_bsale_id,"onUpdate:modelValue":t[2]||(t[2]=s=>a.formulario.cliente_bsale_id=s),items:a.clientesBsale,"item-value":"id","item-title":"displayName",label:"Cliente en BSALE","search-input":a.busquedaCliente,loading:a.cargandoClientes,rules:[s=>!!s||"Cliente BSALE es requerido"],required:"",outlined:"","prepend-inner-icon":"mdi-account",clearable:"","onUpdate:search":x.buscarClientes},{"no-data":o(()=>[e(oe,null,{default:o(()=>[e(f,null,{default:o(()=>[e(le,null,{default:o(()=>t[15]||(t[15]=[u(" No se encontraron clientes ")])),_:1}),e(ce,null,{default:o(()=>[e(j,{color:"primary",text:"",small:"",onClick:x.abrirCrearCliente},{default:o(()=>t[16]||(t[16]=[u(" Crear cliente nuevo ")])),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","items","search-input","loading","rules","onUpdate:search"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:a.formulario.metodo_pago,"onUpdate:modelValue":t[3]||(t[3]=s=>a.formulario.metodo_pago=s),items:a.metodosPago,"item-title":"text","item-value":"value",label:"M√©todo de pago",outlined:"","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.condiciones_pago,"onUpdate:modelValue":t[4]||(t[4]=s=>a.formulario.condiciones_pago=s),label:"Condiciones de pago",outlined:"","prepend-inner-icon":"mdi-calendar-clock",placeholder:"Ej: 30 d√≠as"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:a.formulario.fecha_vencimiento,"onUpdate:modelValue":t[5]||(t[5]=s=>a.formulario.fecha_vencimiento=s),label:"Fecha de vencimiento",type:"date",outlined:"","prepend-inner-icon":"mdi-calendar"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(xe,{modelValue:a.formulario.observaciones,"onUpdate:modelValue":t[6]||(t[6]=s=>a.formulario.observaciones=s),label:"Observaciones",outlined:"",rows:"3","prepend-inner-icon":"mdi-note-text",placeholder:"Observaciones adicionales para el documento..."},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(Q),e(se,{class:"pa-4"},{default:o(()=>[e(ue),e(j,{color:"grey",text:"",onClick:x.cerrar,disabled:a.generandoDocumento},{default:o(()=>t[17]||(t[17]=[u(" Cancelar ")])),_:1},8,["onClick","disabled"]),e(j,{color:"success",onClick:x.generarDocumento,loading:a.generandoDocumento,disabled:!a.formValid},{default:o(()=>[e(h,{left:""},{default:o(()=>t[18]||(t[18]=[u("mdi-receipt")])),_:1}),t[19]||(t[19]=u(" Generar Documento "))]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1}),e(V,{modelValue:a.dialogCrearCliente,"onUpdate:modelValue":t[8]||(t[8]=s=>a.dialogCrearCliente=s),cotizacion:b.cotizacion,onClienteCreado:x.onClienteCreado},null,8,["modelValue","cotizacion","onClienteCreado"])]),_:1},8,["modelValue"])}const Ie=_e(Be,[["render",Me],["__scopeId","data-v-80d7891d"]]),Re={__name:"CrearClienteBsale",props:{mostrar:Boolean},emits:["update:mostrar","cliente-creado"],setup(r,{emit:t}){const b=r,z=t,a=L(b.mostrar);ie(()=>b.mostrar,N=>{a.value=N}),ie(a,N=>{z("update:mostrar",N)});const x=L(!1),f=L(),V=L({nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}),s=async()=>{var C,y;const{valid:N}=await f.value.validate();if(N)try{x.value=!0;const O={nombre:V.value.nombre,apellido:V.value.apellido,empresa:V.value.empresa,rut:V.value.rut,giro:V.value.giro,email:V.value.email,telefono:V.value.telefono,direccion:V.value.direccion,enviar_email:V.value.enviar_email},{data:H}=await K.post("/api/bsale/crear-cliente",O);H.success&&(z("cliente-creado",H.cliente),G(),alert("Cliente creado exitosamente"))}catch(O){console.error("Error creando cliente:",O);const H=((y=(C=O.response)==null?void 0:C.data)==null?void 0:y.message)||"Error al crear cliente";alert(`‚ùå ${H}`)}finally{x.value=!1}},G=()=>{a.value=!1,V.value={nombre:"",apellido:"",empresa:"",rut:"",giro:"",email:"",telefono:"",direccion:"",enviar_email:!1}};return(N,C)=>(F(),R(ae,{modelValue:a.value,"onUpdate:modelValue":C[9]||(C[9]=y=>a.value=y),"max-width":"600px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>C[10]||(C[10]=[u("mdi-account-plus")])),_:1}),C[11]||(C[11]=u(" Crear Cliente en BSALE "))]),_:1}),e(Q),e(M,null,{default:o(()=>[e(de,{ref_key:"formRef",ref:f,onSubmit:Ve(s,["prevent"])},{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.nombre,"onUpdate:modelValue":C[0]||(C[0]=y=>V.value.nombre=y),label:"Nombre *",rules:[y=>!!y||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account",required:""},null,8,["modelValue","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.apellido,"onUpdate:modelValue":C[1]||(C[1]=y=>V.value.apellido=y),label:"Apellido",variant:"outlined","prepend-inner-icon":"mdi-account"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e($,{modelValue:V.value.empresa,"onUpdate:modelValue":C[2]||(C[2]=y=>V.value.empresa=y),label:"Empresa",variant:"outlined","prepend-inner-icon":"mdi-office-building"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.rut,"onUpdate:modelValue":C[3]||(C[3]=y=>V.value.rut=y),label:"RUT",variant:"outlined","prepend-inner-icon":"mdi-card-account-details",placeholder:"12345678-9"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.giro,"onUpdate:modelValue":C[4]||(C[4]=y=>V.value.giro=y),label:"Giro",variant:"outlined","prepend-inner-icon":"mdi-briefcase"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.email,"onUpdate:modelValue":C[5]||(C[5]=y=>V.value.email=y),label:"Email",type:"email",variant:"outlined","prepend-inner-icon":"mdi-email"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:V.value.telefono,"onUpdate:modelValue":C[6]||(C[6]=y=>V.value.telefono=y),label:"Tel√©fono",variant:"outlined","prepend-inner-icon":"mdi-phone"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e($,{modelValue:V.value.direccion,"onUpdate:modelValue":C[7]||(C[7]=y=>V.value.direccion=y),label:"Direcci√≥n",variant:"outlined","prepend-inner-icon":"mdi-map-marker"},null,8,["modelValue"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(Le,{modelValue:V.value.enviar_email,"onUpdate:modelValue":C[8]||(C[8]=y=>V.value.enviar_email=y),label:"Enviar email de confirmaci√≥n",color:"primary"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),e(se,null,{default:o(()=>[e(ue),e(j,{variant:"text",onClick:G,disabled:x.value},{default:o(()=>C[12]||(C[12]=[u(" Cancelar ")])),_:1},8,["disabled"]),e(j,{color:"primary",onClick:s,loading:x.value},{default:o(()=>[e(h,{start:""},{default:o(()=>C[13]||(C[13]=[u("mdi-account-plus")])),_:1}),C[14]||(C[14]=u(" Crear Cliente "))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Ge={class:"d-flex justify-space-between align-center"},Oe={class:"text-caption"},He={class:"text-end"},Xe={class:"text-h6 text-success"},Ze={class:"text-caption"},Je={class:"text-body-2"},Ke={class:"text-body-2"},Qe={class:"text-h6 text-success mt-2"},We={__name:"ModalFacturacion",props:{mostrar:Boolean,cotizacion:Object},emits:["update:mostrar","documento-creado","actualizar-cotizacion"],setup(r,{emit:t}){const b=r,z=t,a=L(b.mostrar);ie(()=>b.mostrar,S=>{a.value=S}),ie(a,S=>{z("update:mostrar",S)});const x=L(!1),f=L(!1),V=L(""),s=L({tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}),G=L([{id:1,nombre:"Factura Afecta",descripcion:"Documento tributario con IVA"},{id:8,nombre:"Boleta Afecta",descripcion:"Para consumidores finales con IVA"},{id:9,nombre:"Gu√≠a de Despacho",descripcion:"Solo traslado de mercader√≠a"},{id:12,nombre:"Nota de Venta",descripcion:"Documento interno de venta"}]),N=L([{id:1,nombre:"Efectivo"},{id:2,nombre:"Transferencia Bancaria"},{id:3,nombre:"Cheque"},{id:4,nombre:"Tarjeta de Cr√©dito"},{id:5,nombre:"Tarjeta de D√©bito"}]),C=L([{nombre:"Contado",valor:"contado"},{nombre:"30 d√≠as",valor:"30_dias"},{nombre:"60 d√≠as",valor:"60_dias"},{nombre:"90 d√≠as",valor:"90_dias"}]),y=L([]),O=me(()=>new Date().toISOString().split("T")[0]),H=async(S="")=>{try{const{data:n}=await K.get("/api/bsale/clientes",{params:{search:S,limit:50}});n.success&&(y.value=(n.clientes.items||[]).map(p=>({...p,nombre_completo:`${p.firstName} ${p.lastName}`.trim(),rut:p.code||"Sin RUT",empresa:p.company||"Particular"})))}catch(n){console.error("Error buscando clientes:",n)}},D=async()=>{var S,n;try{x.value=!0;const p={cotizacion_id:b.cotizacion.id,tipo_documento:s.value.tipo_documento,metodo_pago:s.value.metodo_pago,condiciones_pago:s.value.condiciones_pago,fecha_vencimiento:s.value.fecha_vencimiento,cliente_bsale_id:s.value.cliente_bsale_id,observaciones:s.value.observaciones};console.log("Generando documento con payload:",p);const{data:m}=await K.post("/api/bsale/crear-documento",p);m.success&&(z("documento-creado",m.documento),z("actualizar-cotizacion",m.cotizacion),w(),alert(`‚úÖ Documento generado exitosamente: ${m.documento.number}`))}catch(p){console.error("Error generando documento:",p);const m=((n=(S=p.response)==null?void 0:S.data)==null?void 0:n.message)||"Error al generar documento";alert(`‚ùå ${m}`)}finally{x.value=!1}},c=S=>{y.value.push({...S,nombre_completo:`${S.firstName} ${S.lastName}`.trim()}),s.value.cliente_bsale_id=S.id},w=()=>{a.value=!1,s.value={tipo_documento:null,metodo_pago:null,condiciones_pago:"contado",fecha_vencimiento:null,cliente_bsale_id:null,observaciones:""}},g=S=>{const n=G.value.find(p=>p.id===S);return(n==null?void 0:n.nombre)||"Documento"},U=S=>{const n=N.value.find(p=>p.id===S);return(n==null?void 0:n.nombre)||"No especificado"},A=S=>{const n=C.value.find(p=>p.valor===S);return(n==null?void 0:n.nombre)||"No especificado"},I=()=>y.value.find(S=>S.id===s.value.cliente_bsale_id),X=()=>{var n;const S=((n=b.cotizacion)==null?void 0:n.total)||0;return Math.round(S/1.19)},J=()=>Math.round(X()*.19),W=()=>X()+J();return ie(()=>b.mostrar,S=>{S&&H("")}),(S,n)=>(F(),R(ae,{modelValue:a.value,"onUpdate:modelValue":n[8]||(n[8]=p=>a.value=p),"max-width":"800px",persistent:""},{default:o(()=>[e(B,null,{default:o(()=>[e(q,{class:"text-h5 d-flex align-center"},{default:o(()=>[e(h,{color:"primary",class:"me-2"},{default:o(()=>n[9]||(n[9]=[u("mdi-file-document-plus")])),_:1}),n[10]||(n[10]=u(" Generar Documento Electr√≥nico "))]),_:1}),e(Q),e(M,null,{default:o(()=>[e(Te,{color:"info",variant:"outlined",class:"mb-4"},{default:o(()=>{var p,m,i,T,v,k,P;return[l("div",Ge,[l("div",null,[l("strong",null,"Cotizaci√≥n #"+d((p=r.cotizacion)==null?void 0:p.numero),1),n[11]||(n[11]=l("br",null,null,-1)),l("span",Oe,"Cliente: "+d((i=(m=r.cotizacion)==null?void 0:m.cliente)==null?void 0:i.nombre),1)]),l("div",He,[l("div",Xe,"$"+d((v=(T=r.cotizacion)==null?void 0:T.total)==null?void 0:v.toLocaleString()),1),l("span",Ze,d((P=(k=r.cotizacion)==null?void 0:k.ventanas)==null?void 0:P.length)+" ventanas",1)])])]}),_:1}),e(de,{ref:"formRef",onSubmit:Ve(D,["prevent"])},{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:s.value.tipo_documento,"onUpdate:modelValue":n[0]||(n[0]=p=>s.value.tipo_documento=p),items:G.value,"item-title":"nombre","item-value":"id",label:"Tipo de documento *",rules:[p=>!!p||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-file-document"},{item:o(({props:p,item:m})=>[e(oe,pe(ve(p)),{default:o(()=>[e(le,null,{default:o(()=>[u(d(m.raw.nombre),1)]),_:2},1024),e(ce,null,{default:o(()=>[u(d(m.raw.descripcion),1)]),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:s.value.metodo_pago,"onUpdate:modelValue":n[1]||(n[1]=p=>s.value.metodo_pago=p),items:N.value,"item-title":"nombre","item-value":"id",label:"M√©todo de pago *",rules:[p=>!!p||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-credit-card"},null,8,["modelValue","items","rules"])]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(Y,{modelValue:s.value.condiciones_pago,"onUpdate:modelValue":n[2]||(n[2]=p=>s.value.condiciones_pago=p),items:C.value,"item-title":"nombre","item-value":"valor",label:"Condiciones de pago *",rules:[p=>!!p||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-calendar-clock"},null,8,["modelValue","items","rules"])]),_:1}),s.value.condiciones_pago!=="contado"?(F(),R(_,{key:0,cols:"12",md:"6"},{default:o(()=>[e($,{modelValue:s.value.fecha_vencimiento,"onUpdate:modelValue":n[3]||(n[3]=p=>s.value.fecha_vencimiento=p),type:"date",label:"Fecha de vencimiento",variant:"outlined","prepend-inner-icon":"mdi-calendar",min:O.value},null,8,["modelValue","min"])]),_:1})):ee("",!0),e(_,{cols:"12"},{default:o(()=>[e(Ce,{modelValue:s.value.cliente_bsale_id,"onUpdate:modelValue":n[5]||(n[5]=p=>s.value.cliente_bsale_id=p),items:y.value,search:V.value,"item-title":"nombre_completo","item-value":"id",label:"Cliente en BSALE *",rules:[p=>!!p||"Requerido"],variant:"outlined","prepend-inner-icon":"mdi-account","onUpdate:search":H,"no-data-text":"No se encontraron clientes"},{item:o(({props:p,item:m})=>[e(oe,pe(ve(p)),{default:o(()=>[e(le,null,{default:o(()=>[u(d(m.raw.nombre_completo),1)]),_:2},1024),e(ce,null,{default:o(()=>[u(d(m.raw.empresa)+" ‚Ä¢ "+d(m.raw.rut),1)]),_:2},1024)]),_:2},1040)]),append:o(()=>[e(j,{icon:"mdi-plus",variant:"text",size:"small",onClick:n[4]||(n[4]=p=>f.value=!0)})]),_:1},8,["modelValue","items","search","rules"])]),_:1}),e(_,{cols:"12"},{default:o(()=>[e(xe,{modelValue:s.value.observaciones,"onUpdate:modelValue":n[6]||(n[6]=p=>s.value.observaciones=p),label:"Observaciones (opcional)",variant:"outlined",rows:"3","prepend-inner-icon":"mdi-note-text",counter:"500",maxlength:"500"},null,8,["modelValue"])]),_:1})]),_:1}),s.value.tipo_documento&&s.value.cliente_bsale_id?(F(),R(B,{key:0,variant:"outlined",class:"mt-4"},{default:o(()=>[e(q,{class:"text-subtitle-1"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>n[12]||(n[12]=[u("mdi-eye")])),_:1}),n[13]||(n[13]=u(" Preview del documento "))]),_:1}),e(M,null,{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>{var p,m;return[l("div",Je,[l("strong",null,d(g(s.value.tipo_documento)),1),n[14]||(n[14]=l("br",null,null,-1)),n[15]||(n[15]=l("strong",null,"Cliente:",-1)),u(" "+d((p=I())==null?void 0:p.nombre_completo),1),n[16]||(n[16]=l("br",null,null,-1)),n[17]||(n[17]=l("strong",null,"RUT:",-1)),u(" "+d((m=I())==null?void 0:m.rut),1),n[18]||(n[18]=l("br",null,null,-1)),n[19]||(n[19]=l("strong",null,"M√©todo de pago:",-1)),u(" "+d(U(s.value.metodo_pago)),1),n[20]||(n[20]=l("br",null,null,-1)),n[21]||(n[21]=l("strong",null,"Condiciones:",-1)),u(" "+d(A(s.value.condiciones_pago)),1)])]}),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>{var p,m;return[l("div",Ke,[n[22]||(n[22]=l("strong",null,"Items:",-1)),u(" "+d(((m=(p=r.cotizacion)==null?void 0:p.ventanas)==null?void 0:m.length)||0)+" ventanas",1),n[23]||(n[23]=l("br",null,null,-1)),n[24]||(n[24]=l("strong",null,"Subtotal:",-1)),u(" $"+d(X().toLocaleString()),1),n[25]||(n[25]=l("br",null,null,-1)),n[26]||(n[26]=l("strong",null,"IVA (19%):",-1)),u(" $"+d(J().toLocaleString()),1),n[27]||(n[27]=l("br",null,null,-1)),l("div",Qe,[l("strong",null,"Total: $"+d(W().toLocaleString()),1)])])]}),_:1})]),_:1})]),_:1})]),_:1})):ee("",!0)]),_:1},512)]),_:1}),e(se,null,{default:o(()=>[e(ue),e(j,{color:"secondary",variant:"text",onClick:w,disabled:x.value},{default:o(()=>n[28]||(n[28]=[u(" Cancelar ")])),_:1},8,["disabled"]),e(j,{color:"primary",onClick:D,loading:x.value},{default:o(()=>[e(h,{start:""},{default:o(()=>n[29]||(n[29]=[u("mdi-file-document-plus")])),_:1}),n[30]||(n[30]=u(" Generar Documento "))]),_:1},8,["loading"])]),_:1})]),_:1}),e(Re,{mostrar:f.value,"onUpdate:mostrar":n[7]||(n[7]=p=>f.value=p),onClienteCreado:c},null,8,["mostrar"])]),_:1},8,["modelValue"]))}},Ye={class:"text-body-1 mb-2"},eo={class:"text-body-2 text-medium-emphasis mb-1"},oo={class:"text-body-2 text-medium-emphasis mb-1"},lo={class:"text-body-2 text-medium-emphasis"},to={class:"text-body-2 mb-1"},ao={class:"text-body-2 mb-1"},no={class:"text-body-2 mb-1"},io={class:"text-body-2 mb-1"},ro={class:"text-body-2"},so={class:"text-success text-h6 ms-1"},uo={class:"font-weight-medium"},mo={key:0,class:"text-caption text-medium-emphasis"},co={class:"text-body-2"},fo={class:"text-caption text-medium-emphasis"},po={class:"text-body-2"},vo={class:"text-caption text-medium-emphasis"},bo={class:"font-weight-medium"},go={class:"font-weight-bold text-success"},Vo={class:"text-body-2"},_o={class:"text-body-2 d-flex justify-space-between mb-2"},Co={key:0,class:"text-body-2 d-flex justify-space-between mb-2"},xo={class:"text-error"},yo={class:"text-h5 font-weight-bold text-success d-flex justify-space-between"},zo={class:"text-caption text-medium-emphasis mt-2"},wo={__name:"DetalleCotizacion",props:{cotizacion:Object},emits:["cerrar"],setup(r,{emit:t}){const b=r,z=L(!1),a=L(""),x=[{title:"Tipo",key:"tipo_ventana",sortable:!1},{title:"Dimensiones",key:"dimensiones",sortable:!1},{title:"Material/Color",key:"material_color",sortable:!1},{title:"Cantidad",key:"cantidad",sortable:!0},{title:"Precio Unit.",key:"precio_unitario",sortable:!0},{title:"Total",key:"total",sortable:!1},{title:"Imagen",key:"imagen",sortable:!1}],f=()=>{var w,g,U;const D=(U=(g=(w=b.cotizacion)==null?void 0:w.estado)==null?void 0:g.nombre)==null?void 0:U.toLowerCase();return{evaluaci√≥n:"warning",aprobada:"success",rechazada:"error",facturada:"info",pagada:"primary"}[D]||"grey"},V=D=>D?new Date(D).toLocaleDateString("es-CL"):"-",s=D=>{const c=[];return D.hojas_totales&&c.push(`${D.hojas_totales} hojas`),D.hojas_moviles&&c.push(`${D.hojas_moviles} m√≥viles`),c.join(", ")},G=(D,c)=>!D||!c?"0.00":(D*c/1e6).toFixed(2),N=D=>{const c=D.precio_unitario||D.precio||0,w=D.cantidad||1;return c*w},C=()=>{var D,c;return((c=(D=b.cotizacion)==null?void 0:D.ventanas)==null?void 0:c.reduce((w,g)=>w+N(g),0))||0},y=()=>{var D;return((D=b.cotizacion)==null?void 0:D.descuento_total)||0},O=D=>{a.value=H(D),z.value=!0},H=D=>D?`/storage/imagenes_ventanas/${D}`:"";return(D,c)=>(F(),R(B,{class:"ma-0"},{default:o(()=>[e(q,{class:"d-flex align-center justify-space-between"},{default:o(()=>{var w;return[l("div",null,[l("h2",null,"Detalle de Cotizaci√≥n #"+d((w=r.cotizacion)==null?void 0:w.id),1),e(te,{color:f(),size:"small",class:"mt-2"},{default:o(()=>{var g,U;return[u(d((U=(g=r.cotizacion)==null?void 0:g.estado)==null?void 0:U.nombre),1)]}),_:1},8,["color"])]),e(j,{icon:"mdi-close",variant:"text",onClick:c[0]||(c[0]=g=>D.$emit("cerrar"))})]}),_:1}),e(Q),e(M,{class:"pa-6"},{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"6"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>c[3]||(c[3]=[u("mdi-account")])),_:1}),c[4]||(c[4]=u(" Informaci√≥n del Cliente "))]),_:1}),e(M,null,{default:o(()=>{var w,g,U,A,I,X,J,W;return[l("div",Ye,[l("strong",null,d((g=(w=r.cotizacion)==null?void 0:w.cliente)==null?void 0:g.nombre),1)]),l("div",eo," üìß "+d(((A=(U=r.cotizacion)==null?void 0:U.cliente)==null?void 0:A.email)||"Sin email"),1),l("div",oo," üì± "+d(((X=(I=r.cotizacion)==null?void 0:I.cliente)==null?void 0:X.telefono)||"Sin tel√©fono"),1),l("div",lo," üè† "+d(((W=(J=r.cotizacion)==null?void 0:J.cliente)==null?void 0:W.direccion)||"Sin direcci√≥n"),1)]}),_:1})]),_:1})]),_:1}),e(_,{cols:"12",md:"6"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>c[5]||(c[5]=[u("mdi-file-document")])),_:1}),c[6]||(c[6]=u(" Datos de la Cotizaci√≥n "))]),_:1}),e(M,null,{default:o(()=>{var w,g,U,A,I,X;return[l("div",to,[c[7]||(c[7]=l("strong",null,"N√∫mero:",-1)),u(" #"+d((w=r.cotizacion)==null?void 0:w.id),1)]),l("div",ao,[c[8]||(c[8]=l("strong",null,"Fecha:",-1)),u(" "+d(V((g=r.cotizacion)==null?void 0:g.fecha)),1)]),l("div",no,[c[9]||(c[9]=l("strong",null,"Vendedor:",-1)),u(" "+d(((A=(U=r.cotizacion)==null?void 0:U.vendedor)==null?void 0:A.nombre)||"No asignado"),1)]),l("div",io,[c[10]||(c[10]=l("strong",null,"Estado:",-1)),e(te,{color:f(),size:"x-small",class:"ms-1"},{default:o(()=>{var J,W;return[u(d((W=(J=r.cotizacion)==null?void 0:J.estado)==null?void 0:W.nombre),1)]}),_:1},8,["color"])]),l("div",ro,[c[11]||(c[11]=l("strong",null,"Total:",-1)),l("span",so," $"+d((X=(I=r.cotizacion)==null?void 0:I.total)==null?void 0:X.toLocaleString()),1)])]}),_:1})]),_:1})]),_:1})]),_:1}),e(Z,{class:"mt-4"},{default:o(()=>[e(_,{cols:"12"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>{var w,g;return[e(h,{class:"me-2"},{default:o(()=>c[12]||(c[12]=[u("mdi-window-closed-variant")])),_:1}),u(" Ventanas Cotizadas ("+d(((g=(w=r.cotizacion)==null?void 0:w.ventanas)==null?void 0:g.length)||0)+") ",1)]}),_:1}),e(M,null,{default:o(()=>{var w;return[e(ye,{headers:x,items:((w=r.cotizacion)==null?void 0:w.ventanas)||[],"item-value":"id",class:"elevation-0",density:"comfortable"},{"item.tipo_ventana":o(({item:g})=>{var U,A;return[l("div",null,[l("div",uo,d(((U=g.tipoVentana)==null?void 0:U.nombre)||((A=g.tipo_ventana)==null?void 0:A.nombre)),1),s(g)?(F(),re("div",mo,d(s(g)),1)):ee("",!0)])]}),"item.dimensiones":o(({item:g})=>[l("div",co,[l("div",null,d(g.ancho)+"mm √ó "+d(g.alto)+"mm",1),l("div",fo,d(G(g.ancho,g.alto))+" m¬≤ ",1)])]),"item.material_color":o(({item:g})=>{var U,A,I;return[l("div",po,[l("div",null,d(((U=g.color)==null?void 0:U.nombre)||"Sin color"),1),l("div",vo,d(((I=(A=g.productoVidrioProveedor)==null?void 0:A.producto)==null?void 0:I.nombre)||"Sin vidrio"),1)])]}),"item.cantidad":o(({item:g})=>[e(te,{size:"small",color:"primary",variant:"outlined"},{default:o(()=>[u(d(g.cantidad),1)]),_:2},1024)]),"item.precio_unitario":o(({item:g})=>[l("div",bo," $"+d((g.precio_unitario||g.precio||0).toLocaleString()),1)]),"item.total":o(({item:g})=>[l("div",go," $"+d(N(g).toLocaleString()),1)]),"item.imagen":o(({item:g})=>[g.imagen?(F(),R($e,{key:0,size:"40",class:"cursor-pointer",onClick:U=>O(g.imagen)},{default:o(()=>[e(be,{src:H(g.imagen),cover:""},null,8,["src"])]),_:2},1032,["onClick"])):(F(),R(h,{key:1,color:"grey-lighten-1"},{default:o(()=>c[13]||(c[13]=[u("mdi-image-off")])),_:1}))]),_:1},8,["items"])]}),_:1})]),_:1})]),_:1})]),_:1}),e(Z,{class:"mt-4"},{default:o(()=>[e(_,{cols:"12",md:"8"},{default:o(()=>{var w;return[(w=r.cotizacion)!=null&&w.observaciones?(F(),R(B,{key:0,variant:"outlined"},{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>c[14]||(c[14]=[u("mdi-note-text")])),_:1}),c[15]||(c[15]=u(" Observaciones "))]),_:1}),e(M,null,{default:o(()=>[l("p",Vo,d(r.cotizacion.observaciones),1)]),_:1})]),_:1})):ee("",!0)]}),_:1}),e(_,{cols:"12",md:"4"},{default:o(()=>[e(B,{variant:"outlined",color:"success",class:"text-center"},{default:o(()=>[e(q,{class:"text-h6"},{default:o(()=>[e(h,{class:"me-2"},{default:o(()=>c[16]||(c[16]=[u("mdi-calculator")])),_:1}),c[17]||(c[17]=u(" Resumen Total "))]),_:1}),e(M,null,{default:o(()=>{var w,g,U;return[l("div",_o,[c[18]||(c[18]=l("span",null,"Subtotal:",-1)),l("span",null,"$"+d(C().toLocaleString()),1)]),y()>0?(F(),re("div",Co,[c[19]||(c[19]=l("span",null,"Descuento:",-1)),l("span",xo,"-$"+d(y().toLocaleString()),1)])):ee("",!0),e(Q,{class:"my-3"}),l("div",yo,[c[20]||(c[20]=l("span",null,"Total:",-1)),l("span",null,"$"+d((((w=r.cotizacion)==null?void 0:w.total)||0).toLocaleString()),1)]),l("div",zo,d(((U=(g=r.cotizacion)==null?void 0:g.ventanas)==null?void 0:U.length)||0)+" ventanas ",1)]}),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ae,{modelValue:z.value,"onUpdate:modelValue":c[2]||(c[2]=w=>z.value=w),"max-width":"800px"},{default:o(()=>[e(B,null,{default:o(()=>[e(q,{class:"d-flex justify-space-between align-center"},{default:o(()=>[c[21]||(c[21]=u(" Imagen de Ventana ")),e(j,{icon:"mdi-close",variant:"text",onClick:c[1]||(c[1]=w=>z.value=!1)})]),_:1}),e(M,{class:"text-center"},{default:o(()=>[e(be,{src:a.value,"max-height":"500",contain:""},null,8,["src"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},Do={class:"d-flex align-center"},ko={class:"font-weight-medium"},So={class:"text-caption text-medium-emphasis"},Uo={class:"font-weight-bold text-success"},Eo={class:"text-caption"},Lo={class:"d-flex gap-2"},To=["colspan"],$o={class:"pa-4"},Fo={class:"mb-3"},No={class:"font-weight-bold"},Po={class:"d-flex justify-space-between mb-2"},Bo={class:"d-flex justify-space-between mb-2"},ho={class:"text-error"},jo={class:"d-flex justify-space-between font-weight-bold"},Ao={class:"text-success"},qo={class:"d-flex justify-space-between align-center pa-4"},Mo={class:"text-caption"},gl={__name:"index",setup(r){const t=L(!1),b=L([]),z=L(!1),a=L(!1),x=L(!1),f=L(null),V=L(10),s=L({busqueda:"",estado:null,cliente:null}),G=[{title:"N√∫mero",key:"numero",sortable:!0},{title:"Cliente",key:"cliente",sortable:!1},{title:"Total",key:"total",sortable:!0},{title:"Estado",key:"estado_facturacion",sortable:!0},{title:"Fecha aprobaci√≥n",key:"fecha_aprobacion",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,width:"200px"}],N=[{title:"Aprobada (Por facturar)",value:"aprobada"},{title:"Facturada",value:"facturada"},{title:"Pagada",value:"pagada"},{title:"Anulada",value:"anulada"}],C=me(()=>b.value.map(i=>i.cliente).filter((i,T,v)=>i&&v.findIndex(k=>k.id===i.id)===T)),y=me(()=>{let m=[...b.value];if(s.value.busqueda){const i=s.value.busqueda.toLowerCase();m=m.filter(T=>{var v,k,P,E,ne;return((v=T.numero)==null?void 0:v.toString().includes(i))||((P=(k=T.cliente)==null?void 0:k.nombre)==null?void 0:P.toLowerCase().includes(i))||((ne=(E=T.cliente)==null?void 0:E.email)==null?void 0:ne.toLowerCase().includes(i))})}return s.value.estado&&(m=m.filter(i=>i.estado_facturacion===s.value.estado)),s.value.cliente&&(m=m.filter(i=>{var T;return((T=i.cliente)==null?void 0:T.id)===s.value.cliente})),m}),O=async()=>{var m,i,T,v,k,P;try{t.value=!0,console.log("üîç Intentando cargar cotizaciones desde:","/api/cotizaciones/aprobadas");const{data:E}=await K.get("/api/cotizaciones/aprobadas");console.log("‚úÖ Respuesta recibida:",E),b.value=E.cotizaciones||[],console.log("üìä Cotizaciones cargadas:",b.value.length)}catch(E){console.error("‚ùå Error cargando cotizaciones:",E),console.error("üìç URL intentada:",(m=E.config)==null?void 0:m.url),console.error("üî¢ Status:",(i=E.response)==null?void 0:i.status),console.error("üìù Mensaje:",(T=E.response)==null?void 0:T.data),alert(`Error: ${(v=E.response)==null?void 0:v.status} - ${((P=(k=E.response)==null?void 0:k.data)==null?void 0:P.message)||"Error desconocido"}`)}finally{t.value=!1}},H=m=>{f.value=m,x.value=!0},D=m=>{console.log("Documento creado:",m),O()},c=m=>{const i=b.value.findIndex(T=>T.id===m.id);i!==-1&&(b.value[i]=m)},w=m=>{console.log("Duplicar cotizaci√≥n:",m.id)},g=async m=>{if(confirm(`¬øEst√°s seguro de eliminar la cotizaci√≥n #${m.numero}?`))try{await K.delete(`/api/cotizaciones/${m.id}`),b.value=b.value.filter(i=>i.id!==m.id)}catch(i){console.error("Error eliminando cotizaci√≥n:",i)}},U=()=>{s.value={busqueda:"",estado:null,cliente:null}},A=m=>({aprobada:"warning",facturada:"success",pagada:"primary",anulada:"error"})[m]||"grey",I=m=>({aprobada:"Por facturar",facturada:"Facturada",pagada:"Pagada",anulada:"Anulada"})[m]||m,X=m=>m?new Date(m).toLocaleDateString("es-CL"):"-",J=m=>{var i;return((i=m.ventanas)==null?void 0:i.reduce((T,v)=>T+v.precio_unitario*v.cantidad,0))||0},W=m=>{f.value=m,z.value=!0},S=async m=>{try{await O(),console.log("Documento generado exitosamente:",m)}catch(i){console.error("Error recargando datos:",i)}},n=async m=>{if(m.id_documento_bsale)try{const i=await K.get(`/api/bsale/documento/${m.id_documento_bsale}/pdf`);i.data.success&&i.data.pdf_url?window.open(i.data.pdf_url,"_blank"):console.error("No se pudo obtener el PDF del documento")}catch(i){console.error("Error obteniendo PDF:",i)}},p=m=>m.descuento_total||0;return we(()=>{O()}),(m,i)=>{const T=ge("v-simple-table");return F(),re("div",null,[e(B,{class:"mb-6"},{default:o(()=>[e(q,{class:"d-flex align-center justify-space-between"},{default:o(()=>[i[8]||(i[8]=l("div",null,[l("h1",{class:"text-h4 mb-2"},"üìÑ Facturaci√≥n"),l("p",{class:"text-subtitle-1 text-medium-emphasis"}," Gestiona las cotizaciones aprobadas y genera documentos electr√≥nicos ")],-1)),e(te,{color:"primary",variant:"elevated",size:"large"},{default:o(()=>[u(d(b.value.length)+" por facturar ",1)]),_:1})]),_:1})]),_:1}),e(B,{class:"mb-4"},{default:o(()=>[e(M,null,{default:o(()=>[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"4"},{default:o(()=>[e($,{modelValue:s.value.busqueda,"onUpdate:modelValue":i[0]||(i[0]=v=>s.value.busqueda=v),label:"Buscar cotizaci√≥n...","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"3"},{default:o(()=>[e(Y,{modelValue:s.value.estado,"onUpdate:modelValue":i[1]||(i[1]=v=>s.value.estado=v),items:N,label:"Estado",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])]),_:1}),e(_,{cols:"12",md:"3"},{default:o(()=>[e(Y,{modelValue:s.value.cliente,"onUpdate:modelValue":i[2]||(i[2]=v=>s.value.cliente=v),items:C.value,"item-title":"nombre","item-value":"id",label:"Cliente",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue","items"])]),_:1}),e(_,{cols:"12",md:"2"},{default:o(()=>[e(j,{color:"primary",variant:"outlined",block:"",onClick:U},{default:o(()=>i[9]||(i[9]=[u(" Limpiar filtros ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(B,null,{default:o(()=>[e(ye,{"items-per-page":V.value,"onUpdate:itemsPerPage":i[3]||(i[3]=v=>V.value=v),headers:G,items:y.value,loading:t.value,class:"elevation-1","item-value":"id","show-expand":"","expand-on-click":""},{"item.numero":o(({item:v})=>[l("div",Do,[e(te,{color:"primary",variant:"outlined",size:"small",class:"me-2"},{default:o(()=>[u(" #"+d(v.id),1)]),_:2},1024)])]),"item.cliente":o(({item:v})=>{var k,P,E;return[l("div",null,[l("div",ko,d((k=v.cliente)==null?void 0:k.first_name)+" "+d((P=v.cliente)==null?void 0:P.last_name),1),l("div",So,d((E=v.cliente)==null?void 0:E.email),1)])]}),"item.total":o(({item:v})=>{var k;return[l("div",Uo," $"+d((k=v.total)==null?void 0:k.toLocaleString()),1)]}),"item.estado_facturacion":o(({item:v})=>[e(te,{color:A(v.estado_facturacion),variant:v.estado_facturacion==="aprobada"?"elevated":"outlined",size:"small"},{default:o(()=>[u(d(I(v.estado_facturacion)),1)]),_:2},1032,["color","variant"])]),"item.fecha_aprobacion":o(({item:v})=>[l("div",Eo,d(X(v.fecha_aprobacion)),1)]),"item.acciones":o(({item:v})=>[l("div",Lo,[v.estado_facturacion==="aprobada"?(F(),R(j,{key:0,color:"success",variant:"elevated",size:"small",onClick:k=>W(v)},{default:o(()=>[e(h,{start:""},{default:o(()=>i[10]||(i[10]=[u("mdi-receipt")])),_:1}),i[11]||(i[11]=u(" Generar Documento "))]),_:2},1032,["onClick"])):v.estado_facturacion==="facturada"?(F(),R(j,{key:1,color:"info",variant:"outlined",size:"small",onClick:k=>n(v)},{default:o(()=>[e(h,{start:""},{default:o(()=>i[12]||(i[12]=[u("mdi-file-pdf-box")])),_:1}),i[13]||(i[13]=u(" Ver PDF "))]),_:2},1032,["onClick"])):ee("",!0),e(Fe,null,{activator:o(({props:k})=>[e(j,Se(k,{icon:"mdi-dots-vertical",variant:"text",size:"small"}),null,16)]),default:o(()=>[e(Ee,null,{default:o(()=>[e(oe,{onClick:k=>H(v)},{default:o(()=>[e(le,null,{default:o(()=>i[14]||(i[14]=[u("Ver detalle")])),_:1})]),_:2},1032,["onClick"]),e(oe,{onClick:k=>w(v)},{default:o(()=>[e(le,null,{default:o(()=>i[15]||(i[15]=[u("Duplicar")])),_:1})]),_:2},1032,["onClick"]),e(Q),e(oe,{onClick:k=>g(v),class:"text-error"},{default:o(()=>[e(le,null,{default:o(()=>i[16]||(i[16]=[u("Eliminar")])),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)])]),"expanded-row":o(({columns:v,item:k})=>[l("tr",null,[l("td",{colspan:v.length},[l("div",$o,[e(Z,null,{default:o(()=>[e(_,{cols:"12",md:"8"},{default:o(()=>{var P;return[l("h4",Fo,"Ventanas cotizadas ("+d(((P=k.ventanas)==null?void 0:P.length)||0)+")",1),e(T,{dense:""},{default:o(()=>[i[17]||(i[17]=l("thead",null,[l("tr",null,[l("th",null,"Tipo"),l("th",null,"Dimensiones"),l("th",null,"Cantidad"),l("th",null,"Precio unitario"),l("th",null,"Total")])],-1)),l("tbody",null,[(F(!0),re(De,null,ke(k.ventanas,E=>{var ne,fe;return F(),re("tr",{key:E.id},[l("td",null,d((ne=E.tipo_ventana)==null?void 0:ne.nombre),1),l("td",null,d(E.ancho)+"mm √ó "+d(E.alto)+"mm",1),l("td",null,d(E.cantidad),1),l("td",null,"$"+d((fe=E.precio_unitario)==null?void 0:fe.toLocaleString()),1),l("td",No," $"+d((E.precio_unitario*E.cantidad).toLocaleString()),1)])}),128))])]),_:2},1024)]}),_:2},1024),e(_,{cols:"12",md:"4"},{default:o(()=>[e(B,{variant:"outlined"},{default:o(()=>[e(q,{class:"text-subtitle-1"},{default:o(()=>i[18]||(i[18]=[u("Resumen")])),_:1}),e(M,null,{default:o(()=>{var P;return[l("div",Po,[i[19]||(i[19]=l("span",null,"Subtotal:",-1)),l("span",null,"$"+d(J(k).toLocaleString()),1)]),l("div",Bo,[i[20]||(i[20]=l("span",null,"Descuento:",-1)),l("span",ho,"-$"+d(p(k).toLocaleString()),1)]),e(Q,{class:"my-2"}),l("div",jo,[i[21]||(i[21]=l("span",null,"Total:",-1)),l("span",Ao,"$"+d((P=k.total)==null?void 0:P.toLocaleString()),1)])]}),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)])],8,To)])]),bottom:o(()=>[l("div",qo,[l("div",Mo," Mostrando "+d(y.value.length)+" de "+d(b.value.length)+" cotizaciones ",1)])]),_:1},8,["items-per-page","items","loading"])]),_:1}),e(Ie,{modelValue:z.value,"onUpdate:modelValue":i[4]||(i[4]=v=>z.value=v),cotizacion:f.value,onDocumentoGenerado:S},null,8,["modelValue","cotizacion"]),e(We,{mostrar:a.value,"onUpdate:mostrar":i[5]||(i[5]=v=>a.value=v),cotizacion:f.value,onDocumentoCreado:D,onActualizarCotizacion:c},null,8,["mostrar","cotizacion"]),e(ae,{modelValue:x.value,"onUpdate:modelValue":i[7]||(i[7]=v=>x.value=v),"max-width":"1200px"},{default:o(()=>[x.value?(F(),R(wo,{key:0,cotizacion:f.value,onCerrar:i[6]||(i[6]=v=>x.value=!1)},null,8,["cotizacion"])):ee("",!0)]),_:1},8,["modelValue"])])}}};export{gl as default};
