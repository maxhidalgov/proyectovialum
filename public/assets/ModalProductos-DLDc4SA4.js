import{r as g,X as A,w as B,f as x,e as r,o as f,b as a,d as l,a3 as v,c as U,t as _,v as n,F as G,i as H,au as K}from"./index-B-6RP4d4.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as W}from"./VDialog-CMr1FYzl.js";import{V as C,b as Y,c as Z}from"./VCard-DxML4OB1.js";import{V as ee}from"./VCardText-DscUe1qS.js";import{V as P,a as d}from"./VRow-DG65ZAfs.js";import{V as D}from"./VTextField-CPVRB-I7.js";import{V as oe}from"./VDataTable-DbmQydeD.js";import{V as te}from"./VDivider-CmMQ9Mbu.js";import{V as ae}from"./VAlert-Dwgzo1po.js";import{V as re}from"./VSpacer-T6TJ0SPm.js";import"./VOverlay-C0vXc1ST.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-yjfLy0uX.js";import"./VAvatar-Ht_SL-rZ.js";import"./VImg-Dq8pi4pP.js";/* empty css              */import"./VInput-DaKsB-xd.js";import"./VSelect-YGSj8lQa.js";import"./VList-Rr7C66tb.js";import"./VMenu-DT71z8NR.js";import"./VCheckboxBtn-U6uTktIG.js";import"./VSelectionControl-CgK89QSE.js";import"./VChip-sdlJL88e.js";import"./filter-BUr8tlK6.js";const se={key:0},le={class:"text-subtitle-1 mb-3"},ie={class:"text-subtitle-2"},ne={class:"text-caption text-grey"},ce={class:"text-subtitle-2"},de={class:"text-subtitle-2"},ue={class:"text-subtitle-2 text-success"},pe={class:"text-h6 text-primary"},me={__name:"ModalProductos",props:{mostrar:{type:Boolean,default:!1}},emits:["update:mostrar","agregar-productos"],setup(E,{emit:T}){const $=E,k=T,p=g(!1),u=g([]),i=g([]),m=g(""),y=g(!1),M=[{title:"Código",key:"codigo_proveedor",sortable:!0},{title:"Nombre",key:"nombre",sortable:!0},{title:"Tipo",key:"tipo_producto",sortable:!0},{title:"Unidad",key:"unidad",sortable:!0},{title:"Acciones",key:"acciones",sortable:!1,align:"center"}],I=A(()=>{if(!Array.isArray(u.value))return[];if(!m.value)return u.value;const e=m.value.toLowerCase();return u.value.filter(o=>{if(!o)return!1;const t=o.nombre||"",s=o.codigo_proveedor||"";return t.toLowerCase().includes(e)||s.toLowerCase().includes(e)})}),R=A(()=>i.value.reduce((e,o)=>e+o.precio_venta,0));B(()=>$.mostrar,e=>{p.value=e,e&&z()}),B(p,e=>{k("update:mostrar",e),e||j()});const z=async()=>{y.value=!0;try{console.log("🔍 Cargando productos desde /api/productos..."),console.log("🌐 Using API instance with baseURL");const e=await K.get("/api/productos");console.log("✅ Respuesta recibida:",e),console.log("📦 Data type:",typeof e.data),console.log("📦 Data content:",e.data);let o=e.data;if(typeof o=="string"){console.log("⚠️ Respuesta es string, intentando parsear..."),console.log("📝 Primeros 500 caracteres:",o.substring(0,500));try{o=JSON.parse(o)}catch(t){throw console.error("❌ No se pudo parsear como JSON:",t),new Error("La respuesta no es JSON válido")}}Array.isArray(o)?(u.value=o,console.log(`✅ ${u.value.length} productos cargados`)):(console.warn("⚠️ La respuesta no es un array:",typeof o),console.log("Contenido:",o),u.value=[])}catch(e){console.error("❌ Error al cargar productos:",e),console.error("❌ Error completo:",e.response),u.value=[],alert("Error al cargar productos. Por favor, verifica que el servidor esté corriendo.")}finally{y.value=!1}},J=e=>{var S,F,L,N;if(i.value.find(b=>b.producto.id===e.id)){alert("Este producto ya fue seleccionado");return}console.log("🔍 Producto seleccionado:",e),console.log("📋 Lista precios disponibles:",e.listaPrecios||e.lista_precios);const t=((S=e.listaPrecios||e.lista_precios)==null?void 0:S.find(b=>b.activo===1||b.activo===!0))||null;console.log("✅ Lista precio activa encontrada:",t);const s=t?parseFloat(t.precio_costo):0,c=t?parseFloat(t.margen):30,h=s*(1+c/100);console.log("💰 Precio costo:",s),console.log("📊 Margen:",c),console.log("💵 Precio venta:",h),i.value.push({producto:{...e},producto_lista_id:e.id,lista_precio_id:(t==null?void 0:t.id)||null,cantidad:1,precio_costo:s,margen:c,precio_venta:h,codigo:e.codigo,nombre:e.nombre,tipo:((F=e.tipo_producto)==null?void 0:F.nombre)||"",unidad:((L=e.unidad)==null?void 0:L.nombre)||((N=e.unidad)==null?void 0:N.simbolo)||""})},O=e=>{i.value.splice(e,1)},q=e=>{const o=parseFloat(e.precio_costo)||0,t=parseFloat(e.cantidad)||1,s=parseFloat(e.margen)||0,c=o*(1+s/100);e.precio_venta=c*t},V=e=>new Intl.NumberFormat("es-CL").format(e||0),j=()=>{i.value=[],m.value=""},w=()=>{p.value=!1},X=()=>{k("agregar-productos",[...i.value]),p.value=!1};return(e,o)=>(f(),x(W,{modelValue:p.value,"onUpdate:modelValue":o[1]||(o[1]=t=>p.value=t),"max-width":"1000px",persistent:""},{default:r(()=>[a(C,null,{default:r(()=>[a(Y,{class:"text-h6 d-flex justify-space-between align-center"},{default:r(()=>[o[2]||(o[2]=l("span",null,"Agregar Productos",-1)),a(v,{icon:"mdi-close",variant:"text",onClick:w})]),_:1}),a(ee,null,{default:r(()=>[a(P,{dense:""},{default:r(()=>[a(d,{cols:"12"},{default:r(()=>[a(D,{modelValue:m.value,"onUpdate:modelValue":o[0]||(o[0]=t=>m.value=t),label:"Buscar producto por nombre o código","prepend-inner-icon":"mdi-magnify",clearable:"",outlined:"",dense:"","hide-details":"auto"},null,8,["modelValue"])]),_:1})]),_:1}),a(oe,{headers:M,items:I.value,loading:y.value,"item-value":"id",class:"elevation-1 mt-4",density:"compact","items-per-page":10,"items-per-page-options":[5,10,25,50]},{"item.tipo_producto":r(({item:t})=>{var s;return[_(n(((s=t.tipoProducto)==null?void 0:s.nombre)||"-"),1)]}),"item.unidad":r(({item:t})=>{var s;return[_(n(((s=t.unidad)==null?void 0:s.abreviacion)||"-"),1)]}),"item.acciones":r(({item:t})=>[a(v,{icon:"mdi-plus",size:"small",color:"success",variant:"tonal",onClick:s=>J(t)},null,8,["onClick"])]),_:1},8,["items","loading"]),a(te,{class:"my-4"}),i.value.length>0?(f(),U("div",se,[l("h3",le,"Productos seleccionados ("+n(i.value.length)+")",1),(f(!0),U(G,null,H(i.value,(t,s)=>(f(),x(C,{key:s,class:"mb-3 pa-3",outlined:""},{default:r(()=>[a(P,{dense:"",align:"center"},{default:r(()=>[a(d,{cols:"12",md:"4"},{default:r(()=>[l("div",ie,n(t.producto.nombre),1),l("div",ne,n(t.producto.codigo_proveedor),1)]),_:2},1024),a(d,{cols:"6",md:"2"},{default:r(()=>[a(D,{modelValue:t.cantidad,"onUpdate:modelValue":c=>t.cantidad=c,modelModifiers:{number:!0},label:"Cantidad",type:"number",min:"1",outlined:"",dense:"","hide-details":"",onInput:c=>q(t)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024),a(d,{cols:"6",md:"2"},{default:r(()=>[o[3]||(o[3]=l("div",{class:"text-caption text-grey"},"Precio Costo",-1)),l("div",ce,"$"+n(V(t.precio_costo)),1)]),_:2},1024),a(d,{cols:"6",md:"2"},{default:r(()=>[o[4]||(o[4]=l("div",{class:"text-caption text-grey"},"Margen",-1)),l("div",de,n(t.margen)+"%",1)]),_:2},1024),a(d,{cols:"4",md:"1"},{default:r(()=>[o[5]||(o[5]=l("div",{class:"text-caption text-grey"},"Precio Venta",-1)),l("div",ue,"$"+n(V(t.precio_venta)),1)]),_:2},1024),a(d,{cols:"2",md:"1",class:"text-right"},{default:r(()=>[a(v,{icon:"mdi-delete",size:"small",color:"error",variant:"text",onClick:c=>O(s)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024))),128)),a(C,{class:"pa-3 bg-primary-lighten-5",outlined:""},{default:r(()=>[a(P,null,{default:r(()=>[a(d,{cols:"12",class:"text-right"},{default:r(()=>[o[6]||(o[6]=l("div",{class:"text-subtitle-2 text-grey"},"Total productos seleccionados:",-1)),l("div",pe,"$"+n(V(R.value)),1)]),_:1})]),_:1})]),_:1})])):(f(),x(ae,{key:1,type:"info",variant:"tonal",class:"mt-4"},{default:r(()=>o[7]||(o[7]=[_(" Busca y selecciona productos de la tabla para agregarlos a la cotización ")])),_:1}))]),_:1}),a(Z,null,{default:r(()=>[a(re),a(v,{color:"grey",variant:"text",onClick:w},{default:r(()=>o[8]||(o[8]=[_(" Cancelar ")])),_:1}),a(v,{color:"primary",variant:"elevated",disabled:i.value.length===0,onClick:X},{default:r(()=>[_(" Agregar "+n(i.value.length)+" producto(s) ",1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Ie=Q(me,[["__scopeId","data-v-5e03d2ee"]]);export{Ie as default};
