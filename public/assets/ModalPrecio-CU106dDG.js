import{r as m,X as D,w as h,f as q,e as l,o as z,b as a,t as n,v as p,aR as E,aS as F,a3 as T,au as _}from"./index-BeJKwT3L.js";import{_ as R}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as L}from"./VDialog-B8fNwsjc.js";import{V as j,b as G,c as H}from"./VCard-CGdkx-aT.js";import{V as X}from"./VCardText-DwCeoSnf.js";import{V as J}from"./VForm-0rQalx3P.js";import{V as K,a as c}from"./VRow-D5xgHycP.js";import{V as U}from"./VAutocomplete-BrNdOcD1.js";import{a as k}from"./VList-CestEiTa.js";import{V as v}from"./VTextField-Jwusj3K2.js";import{V as Q}from"./VSwitch-By68xJK5.js";import{V as W}from"./VDivider-BwTOxVso.js";import{V as Y}from"./VSpacer-DUGk-Oji.js";import"./VOverlay-Dw8rT7j1.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-_UBNvAVp.js";import"./VAvatar-CfPmM5Ot.js";import"./VImg-DEZOfq6Q.js";import"./VInput-CRx9gst-.js";/* empty css              */import"./VSelect-CP_h5oZu.js";import"./VMenu-BknqRJcB.js";import"./VCheckboxBtn-Dc5VQrYU.js";import"./VSelectionControl-C9MxSs2p.js";import"./VChip-Dk9LcUUU.js";import"./filter-DhrMZfUc.js";const Z={__name:"ModalPrecio",props:{modelValue:{type:Boolean,default:!1},precio:{type:Object,default:null},modoEdicion:{type:Boolean,default:!1}},emits:["update:modelValue","guardado"],setup(f,{emit:I}){const i=f,w=I,P=m([]),s=m([]),V=m(!1),N=m(null),o=m({id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0}),g=D({get:()=>i.modelValue,set:t=>w("update:modelValue",t)}),$=D(()=>{const t=parseFloat(o.value.precio_costo)||0,r=parseFloat(o.value.margen)||0;if(r>=100)return y(0);const e=t/(1-r/100);return y(e)});h(()=>i.modelValue,async t=>{t&&(await B(),i.modoEdicion&&i.precio?(o.value.producto_id=i.precio.producto_id,await C(),o.value={id:i.precio.id,producto_id:i.precio.producto_id,producto_color_proveedor_id:i.precio.producto_color_proveedor_id,precio_costo:parseFloat(i.precio.precio_costo),margen:parseFloat(i.precio.margen),vigencia_desde:i.precio.vigencia_desde?i.precio.vigencia_desde.split(" ")[0]:"",vigencia_hasta:i.precio.vigencia_hasta?i.precio.vigencia_hasta.split(" ")[0]:"",activo:i.precio.activo}):S())});const B=async()=>{try{const t=await _.get("/api/productos");P.value=t.data}catch(t){console.error("Error al cargar productos:",t)}},C=async()=>{if(!o.value.producto_id){s.value=[];return}try{const r=(await _.get("/api/productos")).data.find(d=>d.id===o.value.producto_id),e=(r==null?void 0:r.coloresPorProveedor)||(r==null?void 0:r.colores_por_proveedor)||[];e.length>0?s.value=e:(s.value=[],console.warn("⚠️ Producto sin colores/proveedores definidos"))}catch(t){console.error("Error al cargar producto-color-proveedor:",t),s.value=[]}},M=async t=>{t&&(o.value.producto_color_proveedor_id=null,o.value.precio_costo=0,await C())},O=()=>{if(!o.value.producto_color_proveedor_id)return;const t=s.value.find(r=>r.id===o.value.producto_color_proveedor_id);t&&t.costo&&(o.value.precio_costo=parseFloat(t.costo))},A=async()=>{V.value=!0;try{i.modoEdicion?(await _.put(`/api/lista-precios/${o.value.id}`,o.value),alert("Precio actualizado correctamente")):(await _.post("/api/lista-precios",o.value),alert("Precio creado correctamente")),w("guardado"),b()}catch(t){console.error("Error al guardar precio:",t),alert("Error al guardar el precio")}finally{V.value=!1}},b=()=>{g.value=!1,S()},S=()=>{o.value={id:null,producto_id:null,producto_color_proveedor_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0},s.value=[]},y=t=>new Intl.NumberFormat("es-CL").format(t||0);return(t,r)=>(z(),q(L,{modelValue:g.value,"onUpdate:modelValue":r[7]||(r[7]=e=>g.value=e),"max-width":"700px",persistent:"","onClick:outside":b},{default:l(()=>[a(j,null,{default:l(()=>[a(G,{class:"text-h6 bg-primary"},{default:l(()=>[n(p(f.modoEdicion?"Editar Precio":"Nuevo Precio"),1)]),_:1}),a(X,{class:"pt-4"},{default:l(()=>[a(J,{ref_key:"form",ref:N},{default:l(()=>[a(K,null,{default:l(()=>[a(c,{cols:"12"},{default:l(()=>[a(U,{modelValue:o.value.producto_id,"onUpdate:modelValue":[r[0]||(r[0]=e=>o.value.producto_id=e),M],items:P.value,"item-title":"nombre","item-value":"id",label:"Producto *","prepend-inner-icon":"mdi-package-variant",variant:"outlined",density:"compact",clearable:"",rules:[e=>!!e||"El producto es requerido"]},{item:l(({props:e,item:d})=>[a(k,E(F(e)),{title:l(()=>[n(p(d.raw.nombre),1)]),subtitle:l(()=>{var u;return[n(p((u=d.raw.tipoProducto)==null?void 0:u.nombre),1)]}),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),a(c,{cols:"12"},{default:l(()=>[a(U,{modelValue:o.value.producto_color_proveedor_id,"onUpdate:modelValue":[r[1]||(r[1]=e=>o.value.producto_color_proveedor_id=e),O],items:s.value,"item-title":e=>{var d,u;return`${((d=e.color)==null?void 0:d.nombre)||"Sin color"} - ${((u=e.proveedor)==null?void 0:u.nombre)||"Sin proveedor"}`},"item-value":"id",label:"Color y Proveedor *","prepend-inner-icon":"mdi-palette",variant:"outlined",density:"compact",disabled:!o.value.producto_id,clearable:"",rules:[e=>!!e||"Debes seleccionar un color y proveedor"]},{item:l(({props:e,item:d})=>[a(k,E(F(e)),{title:l(()=>{var u,x;return[n(p(((u=d.raw.color)==null?void 0:u.nombre)||"Sin color")+" - "+p(((x=d.raw.proveedor)==null?void 0:x.nombre)||"Sin proveedor"),1)]}),subtitle:l(()=>[n(" Costo: $"+p(y(d.raw.costo)),1)]),_:2},1040)]),_:1},8,["modelValue","items","item-title","disabled","rules"])]),_:1}),a(c,{cols:"12",md:"4"},{default:l(()=>[a(v,{modelValue:o.value.precio_costo,"onUpdate:modelValue":r[2]||(r[2]=e=>o.value.precio_costo=e),modelModifiers:{number:!0},label:"Precio Costo *",type:"number",prefix:"$",variant:"outlined",density:"compact",rules:[e=>e!=null&&e!==""||"El precio costo es requerido",e=>e>=0||"Debe ser mayor o igual a 0"]},null,8,["modelValue","rules"])]),_:1}),a(c,{cols:"12",md:"4"},{default:l(()=>[a(v,{modelValue:o.value.margen,"onUpdate:modelValue":r[3]||(r[3]=e=>o.value.margen=e),modelModifiers:{number:!0},label:"Margen % *",type:"number",suffix:"%",variant:"outlined",density:"compact",rules:[e=>e!=null&&e!==""||"El margen es requerido",e=>e>=0||"Debe ser mayor o igual a 0",e=>e<=100||"No puede ser mayor a 100"]},null,8,["modelValue","rules"])]),_:1}),a(c,{cols:"12",md:"4"},{default:l(()=>[a(v,{"model-value":$.value,label:"Precio Venta",prefix:"$",variant:"outlined",density:"compact",readonly:"","bg-color":"grey-lighten-4"},null,8,["model-value"])]),_:1}),a(c,{cols:"12",md:"6"},{default:l(()=>[a(v,{modelValue:o.value.vigencia_desde,"onUpdate:modelValue":r[4]||(r[4]=e=>o.value.vigencia_desde=e),label:"Vigencia Desde",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(c,{cols:"12",md:"6"},{default:l(()=>[a(v,{modelValue:o.value.vigencia_hasta,"onUpdate:modelValue":r[5]||(r[5]=e=>o.value.vigencia_hasta=e),label:"Vigencia Hasta",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),a(c,{cols:"12"},{default:l(()=>[a(Q,{modelValue:o.value.activo,"onUpdate:modelValue":r[6]||(r[6]=e=>o.value.activo=e),label:"Precio Activo",color:"success","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),a(W),a(H,null,{default:l(()=>[a(Y),a(T,{color:"grey",variant:"text",onClick:b},{default:l(()=>r[8]||(r[8]=[n(" Cancelar ")])),_:1}),a(T,{color:"primary",variant:"elevated",loading:V.value,onClick:A},{default:l(()=>[n(p(f.modoEdicion?"Actualizar":"Guardar"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},De=R(Z,[["__scopeId","data-v-399c287b"]]);export{De as default};
