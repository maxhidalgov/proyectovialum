import{r as m,X as F,w as H,f as L,e as t,o as R,b as r,t as v,v as f,aJ as N,aK as T,a3 as U,ar as _}from"./index-COm4NVKR.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{V as G}from"./VDialog-Dlh9uZi9.js";import{V as J,b as K,c as X}from"./VCard-td-zcGQo.js";import{V as Q}from"./VCardText-D0eELi7j.js";import{V as W}from"./VForm-BbwvP89X.js";import{V as Y,a as n}from"./VRow-D7Q6o8Uy.js";import{V as k}from"./VAutocomplete--YuPKsF2.js";import{a as I}from"./VList-U5eOqvkq.js";import{V as g}from"./VTextField-CunrbR4e.js";import{V as Z}from"./VSwitch-CDIJIU-V.js";import{V as ee}from"./VDivider-Dbrw5H8e.js";import{V as oe}from"./VSpacer-Rk6o96vg.js";import"./VOverlay-RDD_0lBz.js";import"./forwardRefs-DWGaNmQL.js";import"./transition-ZXjYSd4o.js";import"./VAvatar-CDt_NOM9.js";import"./VImg-3mTdHPb7.js";import"./VInput-TTRGKgFr.js";/* empty css              */import"./VSelect-DS1z6fi2.js";import"./VMenu-Cn8TkKo0.js";import"./VCheckboxBtn-BN3MgTKX.js";import"./VSelectionControl-z1tALCsc.js";import"./VChip-DZHIFqm9.js";import"./filter-DeEOssd9.js";const ae={__name:"ModalPrecio",props:{modelValue:{type:Boolean,default:!1},precio:{type:Object,default:null},modoEdicion:{type:Boolean,default:!1}},emits:["update:modelValue","guardado"],setup(V,{emit:M}){const i=V,x=M,D=m([]),u=m([]),y=m(!1),$=m(null),c=m(""),o=m({id:null,producto_id:null,color_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0}),b=F({get:()=>i.modelValue,set:l=>x("update:modelValue",l)}),A=F(()=>{const l=parseFloat(o.value.precio_costo)||0,a=parseFloat(o.value.margen)||0;if(a>=100)return P(0);const e=l/(1-a/100);return P(e)});H(()=>i.modelValue,async l=>{l&&(await B(),i.modoEdicion&&i.precio?(o.value.producto_id=i.precio.producto_id,await E(),o.value={id:i.precio.id,producto_id:i.precio.producto_id,color_id:i.precio.color_id,precio_costo:parseFloat(i.precio.precio_costo),margen:parseFloat(i.precio.margen),vigencia_desde:i.precio.vigencia_desde?i.precio.vigencia_desde.split(" ")[0]:"",vigencia_hasta:i.precio.vigencia_hasta?i.precio.vigencia_hasta.split(" ")[0]:"",activo:i.precio.activo},i.precio.proveedor_sugerido&&(c.value=`Proveedor: ${i.precio.proveedor_sugerido.nombre}`)):h())});const B=async()=>{try{const l=await _.get("/api/productos");D.value=l.data}catch(l){console.error("Error al cargar productos:",l)}},E=async()=>{if(!o.value.producto_id){u.value=[];return}try{const a=(await _.get("/api/productos")).data.find(s=>s.id===o.value.producto_id),e=(a==null?void 0:a.coloresPorProveedor)||(a==null?void 0:a.colores_por_proveedor)||[],d=new Map;e.forEach(s=>{s.color&&!d.has(s.color.id)&&d.set(s.color.id,s.color)}),u.value=Array.from(d.values()),u.value.length===0&&console.warn("⚠️ Producto sin colores definidos")}catch(l){console.error("Error al cargar colores:",l),u.value=[]}},O=async l=>{l&&(o.value.color_id=null,o.value.precio_costo=0,c.value="",await E())},z=async()=>{var l;if(!o.value.color_id||!o.value.producto_id){o.value.precio_costo=0,c.value="";return}try{const e=(await _.get("/api/productos")).data.find(p=>p.id===o.value.producto_id),s=((e==null?void 0:e.coloresPorProveedor)||(e==null?void 0:e.colores_por_proveedor)||[]).filter(p=>p.color_id===o.value.color_id);if(s.length===0){o.value.precio_costo=0,c.value="No hay proveedores para este color";return}const C=s.reduce((p,S)=>S.costo>p.costo?S:p);o.value.precio_costo=parseFloat(C.costo),c.value=`Proveedor con mayor costo: ${((l=C.proveedor)==null?void 0:l.nombre)||"N/A"} ($${P(C.costo)})`}catch(a){console.error("Error al calcular costo máximo:",a),o.value.precio_costo=0,c.value="Error al calcular costo"}},q=async()=>{y.value=!0;try{i.modoEdicion?(await _.put(`/api/lista-precios/${o.value.id}`,o.value),alert("Precio actualizado correctamente")):(await _.post("/api/lista-precios",o.value),alert("Precio creado correctamente")),x("guardado"),w()}catch(l){console.error("Error al guardar precio:",l),alert("Error al guardar el precio")}finally{y.value=!1}},w=()=>{b.value=!1,h()},h=()=>{o.value={id:null,producto_id:null,color_id:null,precio_costo:0,margen:45,vigencia_desde:new Date().toISOString().split("T")[0],vigencia_hasta:new Date(Date.now()+365*24*60*60*1e3).toISOString().split("T")[0],activo:!0},u.value=[],c.value=""},P=l=>new Intl.NumberFormat("es-CL").format(l||0);return(l,a)=>(R(),L(G,{modelValue:b.value,"onUpdate:modelValue":a[6]||(a[6]=e=>b.value=e),"max-width":"700px",persistent:"","onClick:outside":w},{default:t(()=>[r(J,null,{default:t(()=>[r(K,{class:"text-h6 bg-primary"},{default:t(()=>[v(f(V.modoEdicion?"Editar Precio":"Nuevo Precio"),1)]),_:1}),r(Q,{class:"pt-4"},{default:t(()=>[r(W,{ref_key:"form",ref:$},{default:t(()=>[r(Y,null,{default:t(()=>[r(n,{cols:"12"},{default:t(()=>[r(k,{modelValue:o.value.producto_id,"onUpdate:modelValue":[a[0]||(a[0]=e=>o.value.producto_id=e),O],items:D.value,"item-title":"nombre","item-value":"id",label:"Producto *","prepend-inner-icon":"mdi-package-variant",variant:"outlined",density:"compact",clearable:"",rules:[e=>!!e||"El producto es requerido"]},{item:t(({props:e,item:d})=>[r(I,N(T(e)),{title:t(()=>[v(f(d.raw.nombre),1)]),subtitle:t(()=>{var s;return[v(f((s=d.raw.tipoProducto)==null?void 0:s.nombre),1)]}),_:2},1040)]),_:1},8,["modelValue","items","rules"])]),_:1}),r(n,{cols:"12"},{default:t(()=>[r(k,{modelValue:o.value.color_id,"onUpdate:modelValue":[a[1]||(a[1]=e=>o.value.color_id=e),z],items:u.value,"item-title":"nombre","item-value":"id",label:"Color *","prepend-inner-icon":"mdi-palette",variant:"outlined",density:"compact",disabled:!o.value.producto_id,clearable:"",rules:[e=>!!e||"Debes seleccionar un color"]},{item:t(({props:e,item:d})=>[r(I,N(T(e)),{title:t(()=>[v(f(d.raw.nombre),1)]),_:2},1040)]),_:1},8,["modelValue","items","disabled","rules"])]),_:1}),r(n,{cols:"12",md:"4"},{default:t(()=>[r(g,{"model-value":o.value.precio_costo,label:"Precio Costo (Máximo)",type:"number",prefix:"$",variant:"outlined",density:"compact",readonly:"","bg-color":"grey-lighten-4",hint:c.value,"persistent-hint":""},null,8,["model-value","hint"])]),_:1}),r(n,{cols:"12",md:"4"},{default:t(()=>[r(g,{modelValue:o.value.margen,"onUpdate:modelValue":a[2]||(a[2]=e=>o.value.margen=e),modelModifiers:{number:!0},label:"Margen % *",type:"number",suffix:"%",variant:"outlined",density:"compact",rules:[e=>e!=null&&e!==""||"El margen es requerido",e=>e>=0||"Debe ser mayor o igual a 0",e=>e<=100||"No puede ser mayor a 100"]},null,8,["modelValue","rules"])]),_:1}),r(n,{cols:"12",md:"4"},{default:t(()=>[r(g,{"model-value":A.value,label:"Precio Venta",prefix:"$",variant:"outlined",density:"compact",readonly:"","bg-color":"grey-lighten-4"},null,8,["model-value"])]),_:1}),r(n,{cols:"12",md:"6"},{default:t(()=>[r(g,{modelValue:o.value.vigencia_desde,"onUpdate:modelValue":a[3]||(a[3]=e=>o.value.vigencia_desde=e),label:"Vigencia Desde",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),r(n,{cols:"12",md:"6"},{default:t(()=>[r(g,{modelValue:o.value.vigencia_hasta,"onUpdate:modelValue":a[4]||(a[4]=e=>o.value.vigencia_hasta=e),label:"Vigencia Hasta",type:"date",variant:"outlined",density:"compact"},null,8,["modelValue"])]),_:1}),r(n,{cols:"12"},{default:t(()=>[r(Z,{modelValue:o.value.activo,"onUpdate:modelValue":a[5]||(a[5]=e=>o.value.activo=e),label:"Precio Activo",color:"success","hide-details":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512)]),_:1}),r(ee),r(X,null,{default:t(()=>[r(oe),r(U,{color:"grey",variant:"text",onClick:w},{default:t(()=>a[7]||(a[7]=[v(" Cancelar ")])),_:1}),r(U,{color:"primary",variant:"elevated",loading:y.value,onClick:q},{default:t(()=>[v(f(V.modoEdicion?"Actualizar":"Guardar"),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}},Fe=j(ae,[["__scopeId","data-v-fb16c4df"]]);export{Fe as default};
